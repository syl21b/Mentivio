<!DOCTYPE html>
<html lang="en">
<head>
  <title id="page-title"></title>
  <script src="../js/components.js" defer></script>

  <style>/* Consolidated CSS - matched to Home.html color scheme */
:root {
  --primary: #4a6fa5;    /* Calming blue - matches Home.html */
  --primary-light: #88a4c7;
  --primary-dark: #3a5a80;
  --secondary: #7ba05b;  /* Natural green - matches Home.html */
  --accent: #d4a5a5;     /* Soft pink - matches Home.html */
  --light: #f8f9fa;
  --dark: #2c3e50;
  --success: #4caf50;
  --warning: #ff9800;
  --danger: #f44336;
  --danger-light: #ffebee;
  --danger-dark: #d32f2f;
  --gray: #6c757d;
  --gray-light: #e9ecef;
  --transition: all 0.3s ease;
  --radius: 12px;
  --white: #ffffff;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 8px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  line-height: 1.6;
  color: var(--dark);
  background-color: var(--white);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: min(95%, 1200px);
  margin: 0 auto;
  padding: 0 clamp(1rem, 3vw, 1.5rem);
}

/* Hero Section - Matched to Home.html */
.hero {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  color: var(--dark);
  padding: clamp(3rem, 8vw, 6rem) clamp(1rem, 4vw, 2.5rem);
  text-align: center;
  position: relative;
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800" opacity="0.02"><path fill="%234a6fa5" d="M0,0V800H1200V0ZM600,400C600,267,709.5,160,850,160S1100,267,1100,400,990.5,640,850,640,600,533,600,400ZM100,400c0-133,109.5-240,250-240S600,267,600,400,490.5,640,350,640,100,533,100,400Z"/></svg>');
  background-size: cover;
  pointer-events: none;
}

.hero-content {
  max-width: min(95%, 800px);
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

.hero h1 {
  font-size: clamp(1.8rem, 5vw, 2.8rem);
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-weight: 300;
  line-height: 1.2;
  word-wrap: break-word;
  overflow-wrap: break-word;
  animation: fadeInUp 0.8s ease 0.2s forwards;
  opacity: 0;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hero h1 strong {
  font-weight: 600;
  color: var(--primary);
}

.hero p {
  font-size: clamp(1rem, 2.5vw, 1.2rem);
  color: var(--gray);
  max-width: min(95%, 700px);
  margin: 0 auto clamp(1.5rem, 4vw, 2.5rem);
  line-height: 1.6;
  word-wrap: break-word;
  overflow-wrap: break-word;
  animation: fadeInUp 0.8s ease 0.4s forwards;
  opacity: 0;
}

.hero-features {
  display: flex;
  justify-content: center;
  gap: clamp(1rem, 4vw, 2.5rem);
  flex-wrap: wrap;
  margin-top: clamp(1.5rem, 4vw, 2rem);
}

.feature {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  min-width: 100px;
  -webkit-tap-highlight-color: transparent;
}

.feature i {
  font-size: clamp(1.5rem, 4vw, 1.8rem);
  margin-bottom: 0.25rem;
  color: var(--primary);
  opacity: 0.9;
}

.feature span {
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  font-weight: 500;
  color: var(--gray);
  text-align: center;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Card Layout - Matched to Home.html */
.survey-card {
  background: var(--white);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-light);
  animation: fadeIn 0.8s ease 0.6s forwards;
  opacity: 0;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

/* Progress Bar - Updated colors */
.progress-text {
  text-align: center;
  margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
  font-weight: 600;
  color: var(--gray);
  padding: clamp(1rem, 3vw, 1.5rem) clamp(1.5rem, 4vw, 2rem) 0;
  font-size: clamp(0.9rem, 2.5vw, 1.05rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.progress-container {
  height: clamp(6px, 1.5vw, 8px);
  background: var(--light);
  border-radius: 10px;
  margin: 0 clamp(1.5rem, 4vw, 2rem) clamp(1.5rem, 4vw, 2rem);
  overflow: hidden;
}

#progressFill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
  width: 0%;
  transition: width 0.5s ease;
  border-radius: 10px;
}

/* Screens */
.screen {
  display: none;
}

.screen.active {
  display: block;
  animation: fadeInSlide 0.5s ease;
}

@keyframes fadeInSlide {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Welcome Screen - Updated style */
.welcome-content {
  text-align: center;
  max-width: min(95%, 700px);
  margin: 0 auto;
  padding: clamp(2rem, 5vw, 3rem) clamp(1rem, 4vw, 2rem);
}

.welcome-icon {
  font-size: clamp(3rem, 8vw, 4rem);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  color: var(--primary);
  display: inline-block;
}

.welcome-content h2 {
  font-size: clamp(1.4rem, 4vw, 2rem);
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-weight: 300;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.welcome-content h2 strong {
  font-weight: 600;
  color: var(--primary);
}

.welcome-content p {
  font-size: clamp(0.95rem, 2.5vw, 1.15rem);
  color: var(--gray);
  line-height: 1.6;
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.features-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.25rem);
  margin: clamp(1.5rem, 4vw, 2.5rem) 0;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: clamp(0.75rem, 2vw, 1rem);
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: var(--radius);
  font-weight: 500;
  color: var(--gray);
  transition: var(--transition);
  border: 1px solid var(--gray-light);
  -webkit-tap-highlight-color: transparent;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.feature-item:hover {
  transform: translateY(-3px);
  border-color: var(--gray-light);
  box-shadow: var(--shadow);
}

.feature-item:active {
  transform: translateY(-1px);
}

.feature-icon {
  font-size: clamp(1.2rem, 3vw, 1.4rem);
  color: var(--primary);
  flex-shrink: 0;
}

/* Buttons - Updated colors */
.btn {
  padding: clamp(0.75rem, 2vw, 0.875rem) clamp(1.25rem, 3vw, 1.75rem);
  border: none;
  border-radius: 50px;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-family: inherit;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-decoration: none;
  min-height: 44px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  position: relative;
  overflow: hidden;
}

.btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: inherit;
  background: rgba(255, 255, 255, 0.1);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.btn:hover::after {
  opacity: 1;
}

.btn-primary {
  background-color: var(--primary);
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background-color: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
}

.btn-secondary:hover {
  background-color: rgba(74, 111, 165, 0.1);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-large {
  padding: clamp(1rem, 3vw, 1.25rem) clamp(2rem, 5vw, 2.5rem);
  font-size: clamp(1rem, 3vw, 1.15rem);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-info {
  background: var(--secondary);
  color: white;
  border: none;
}

.btn-info:hover {
  transform: translateY(-2px);
  background: #699449;
  box-shadow: var(--shadow);
}

/* Focus states */
.btn:focus,
.option-btn:focus,
input:focus,
select:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.btn:focus:not(:focus-visible) {
  outline: none;
}

/* Question Box - Updated style */
.question-box {
  padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1rem, 3vw, 2rem);
}

.question {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(1rem, 3vw, 1.75rem);
  flex-wrap: wrap;
  gap: 1rem;
}

.question-number {
  font-weight: 600;
  color: var(--primary);
  font-size: clamp(0.9rem, 2.5vw, 1.05rem);
  background: rgba(74, 111, 165, 0.1);
  padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 20px;
  flex-shrink: 0;
}

.question-text {
  font-size: clamp(1.1rem, 3vw, 1.35rem);
  font-weight: 500;
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  color: var(--dark);
  line-height: 1.5;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.options {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 0.875rem);
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.option-btn {
  padding: clamp(1rem, 3vw, 1.25rem) clamp(1.25rem, 3vw, 1.5rem);
  border: 2px solid var(--gray-light);
  border-radius: 10px;
  background: white;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: clamp(0.5rem, 2vw, 0.75rem);
  color: var(--gray);
  text-align: left;
  position: relative;
  min-height: 44px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
}

.option-btn:hover {
  transform: translateY(-2px);
  border-color: var(--primary-light);
  background: #f8fafc;
}

.option-btn.selected {
  border-color: var(--primary);
  background: rgba(74, 111, 165, 0.1);
  color: var(--primary);
  font-weight: 600;
}

.option-btn:active {
  transform: translateY(0);
}

.keyboard-shortcut {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: clamp(20px, 5vw, 24px);
  height: clamp(20px, 5vw, 24px);
  background: var(--gray-light);
  border-radius: 4px;
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  font-weight: 600;
  margin-right: 0.5rem;
  color: var(--gray);
  flex-shrink: 0;
}

.option-btn.selected .keyboard-shortcut {
  background: var(--primary);
  color: white;
}

.nav-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: clamp(1.5rem, 4vw, 2.5rem);
  gap: clamp(0.75rem, 2vw, 1rem);
}

/* Loading Screen */
.loading-state {
  text-align: center;
  padding: clamp(3rem, 8vw, 5rem) clamp(1rem, 4vw, 2rem);
}

.spinner {
  border: 5px solid var(--gray-light);
  border-top: 5px solid var(--primary);
  border-radius: 50%;
  width: clamp(50px, 12vw, 60px);
  height: clamp(50px, 12vw, 60px);
  animation: spin 1s linear infinite;
  margin: clamp(1rem, 3vw, 1.5rem) auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-details {
  margin-top: clamp(1.5rem, 4vw, 2.5rem);
  max-width: min(95%, 400px);
  margin-left: auto;
  margin-right: auto;
}

.loading-step {
  margin: clamp(0.75rem, 2vw, 1rem) 0;
  color: var(--gray);
  padding: clamp(0.5rem, 1.5vw, 0.75rem);
  border-radius: 8px;
  transition: var(--transition);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.loading-step.active {
  color: var(--primary);
  font-weight: 600;
  background: rgba(74, 111, 165, 0.1);
}

/* Results Screen - Updated style */
.result-box {
  padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1rem, 3vw, 2rem);
}

.results-header {
  text-align: center;
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.results-header h2 {
  font-size: clamp(1.4rem, 4vw, 2rem);
  color: var(--dark);
  margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
  font-weight: 300;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.results-header h2 strong {
  font-weight: 600;
  color: var(--primary);
}

.results-meta {
  color: var(--gray);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: clamp(0.5rem, 2vw, 1rem);
  flex-wrap: wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.primary-result {
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.diagnosis-result {
  background: white;
  border-radius: var(--radius);
  padding: clamp(1.5rem, 4vw, 2.5rem);
  border: 1px solid var(--gray-light);
  transition: var(--transition);
  box-shadow: var(--shadow);
  -webkit-tap-highlight-color: transparent;
}

.diagnosis-result:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.diagnosis-result:active {
  transform: translateY(-1px);
}

.diagnosis-normal {
  border-left: clamp(4px, 1vw, 6px) solid var(--secondary);
}

.diagnosis-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(1rem, 3vw, 1.75rem);
  flex-wrap: wrap;
  gap: clamp(0.5rem, 2vw, 1rem);
}

.diagnosis-header h3 {
  color: var(--gray);
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.confidence-badge {
  background: var(--secondary);
  color: white;
  padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 20px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 600;
  flex-shrink: 0;
}

.diagnosis-main h1 {
  font-size: clamp(1.3rem, 4vw, 1.75rem);
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.25rem);
  font-weight: 600;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.diagnosis-description {
  color: var(--gray);
  font-size: clamp(0.95rem, 2.5vw, 1.05rem);
  line-height: 1.6;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.additional-results {
  display: grid;
  gap: clamp(1.5rem, 4vw, 2rem);
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.results-section h4 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.25rem);
  font-size: clamp(1rem, 3vw, 1.2rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.diagnoses-list {
  display: grid;
  gap: clamp(0.75rem, 2vw, 0.875rem);
}

.diagnosis-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: 10px;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}

.diagnosis-item:hover {
  transform: translateY(-2px);
  background: #f1f5f9;
}

.diagnosis-item:active {
  transform: translateY(0);
}

.diagnosis-name {
  font-weight: 500;
  color: var(--dark);
  flex: 1;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.diagnosis-probability {
  background: var(--gray-light);
  padding: clamp(0.3rem, 1vw, 0.4rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 15px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 600;
  color: #475569;
  flex-shrink: 0;
}

.info-note {
  background: #f0f7ff;
  padding: clamp(1rem, 3vw, 1.25rem);
  border-radius: 10px;
  margin: clamp(1rem, 3vw, 1.5rem) 0;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  line-height: 1.5;
  color: var(--dark);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.info-note strong {
  color: var(--primary);
}

.results-actions {
  display: flex;
  gap: clamp(0.75rem, 2vw, 1rem);
  justify-content: center;
  margin-top: clamp(1.5rem, 4vw, 2rem);
  flex-wrap: wrap;
}

/* Review Screen - Updated style */
.review-content {
  display: grid;
  gap: clamp(1.5rem, 4vw, 2rem);
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
}

.patient-info-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
}

.patient-info-section h3 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-size: clamp(1.1rem, 3vw, 1.3rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.patient-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.5rem);
}

/* Patient Details Grid for Results Screen */
.patient-details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.5rem);
  margin-top: clamp(1rem, 3vw, 1.5rem);
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: 8px;
  border: 1px solid var(--gray-light);
  transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}

.detail-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.detail-item:active {
  transform: translateY(0);
}

.detail-label {
  font-weight: 500;
  color: var(--gray);
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.detail-value {
  font-size: clamp(0.9rem, 2.5vw, 1.05rem);
  color: var(--dark);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Adjust patient-info-section for results */
.patient-info-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
}

.patient-info-section h3 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-size: clamp(1.1rem, 3vw, 1.3rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Patient Info Values */
.patient-info-value {
  padding: clamp(0.5rem, 1.5vw, 0.75rem) 1rem;
  background: var(--light);
  border: 1px solid var(--gray-light);
  border-radius: 8px;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  color: var(--dark);
  min-height: 44px; /* Minimum touch target */
  display: flex;
  align-items: center;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Adjust form-group for patient info display */
.patient-info-section .form-group {
  margin-bottom: 0;
}

.patient-info-section .form-group label {
  font-weight: 500;
  color: var(--gray);
  margin-bottom: 0.5rem;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group label {
  font-weight: 500;
  color: var(--gray);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.form-group input,
.form-group select {
  padding: clamp(0.5rem, 1.5vw, 0.75rem) 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 8px;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  font-family: inherit;
  transition: var(--transition);
  background: white;
  min-height: 44px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
}

.responses-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
}

.responses-list {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.response-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: 10px;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  transition: var(--transition);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.response-item:hover {
  transform: translateY(-2px);
  background: #f1f5f9;
}

.response-item:active {
  transform: translateY(0);
}

.response-question {
  flex: 1;
  min-width: 0;
}

.response-category {
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  color: var(--gray);
  font-weight: 500;
  margin-bottom: 0.25rem;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.response-text {
  font-weight: 500;
  color: var(--dark);
  margin-bottom: 0.5rem;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.response-answer {
  color: var(--primary);
  font-weight: 600;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.edit-btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 500;
  transition: var(--transition);
  min-height: 36px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  flex-shrink: 0;
}

.edit-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.edit-btn:active {
  transform: translateY(0);
}

.review-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: clamp(1.5rem, 4vw, 2rem);
  padding-top: clamp(1.5rem, 4vw, 2rem);
  border-top: 1px solid var(--gray-light);
  gap: clamp(0.75rem, 2vw, 1rem);
}

/* History Screen - Updated style */
.history-content {
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.history-item {
  background: white;
  border-radius: var(--radius);
  padding: clamp(1rem, 3vw, 1.5rem);
  border: 1px solid var(--gray-light);
  transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}

.history-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.history-item:active {
  transform: translateY(0);
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  flex-wrap: wrap;
  gap: clamp(0.5rem, 2vw, 1rem);
}

.history-patient {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  flex: 1;
  min-width: 0;
}

.history-patient strong {
  color: var(--dark);
  font-size: clamp(1rem, 2.5vw, 1.1rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.history-id {
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  color: var(--gray);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.history-diagnosis {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 20px;
  font-weight: 600;
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  flex-shrink: 0;
}

.history-diagnosis.normal {
  background: #e8f5e9;
  color: #2e7d32;
}

.history-diagnosis.depression {
  background: #ffebee;
  color: #c62828;
}

.history-diagnosis.bipolar-type-1,
.history-diagnosis.bipolar-type-2 {
  background: #f3e5f5;
  color: #7b1fa2;
}

.history-confidence {
  background: white;
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  font-size: clamp(0.7rem, 1.8vw, 0.8rem);
}

.history-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.history-actions {
  display: flex;
  gap: clamp(0.25rem, 1vw, 0.5rem);
  flex-wrap: wrap;
}

.btn-view,
.btn-download,
.btn-delete {
  padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border: none;
  border-radius: 6px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-height: 36px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
}

.btn-view {
  background: var(--primary);
  color: white;
}

.btn-view:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.btn-download {
  background: var(--secondary);
  color: white;
}

.btn-download:hover {
  background: #699449;
  transform: translateY(-1px);
}

.btn-delete {
  background: var(--danger);
  color: white;
}

.btn-delete:hover {
  background: var(--danger-dark);
  transform: translateY(-1px);
}

.btn-view:active,
.btn-download:active,
.btn-delete:active {
  transform: translateY(0);
}

.no-history {
  text-align: center;
  padding: clamp(2rem, 5vw, 3rem) clamp(1rem, 4vw, 2rem);
  color: var(--gray);
  font-size: clamp(0.95rem, 2.5vw, 1.1rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.welcome-actions {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 1rem);
  margin: clamp(1.5rem, 4vw, 2rem) 0;
  max-width: min(95%, 300px);
  margin-left: auto;
  margin-right: auto;
}

/* Login Section */
.login-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  max-width: min(95%, 500px);
  margin-left: auto;
  margin-right: auto;
  border: 1px solid var(--gray-light);
}

.login-section h3 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  text-align: center;
  font-size: clamp(1.1rem, 3vw, 1.3rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.login-form {
  display: flex;
  flex-direction: column;
  gap: clamp(1rem, 3vw, 1.5rem);
}

.login-actions {
  display: flex;
  gap: clamp(0.75rem, 2vw, 1rem);
  margin-top: clamp(0.75rem, 2vw, 1rem);
}

.login-actions .btn {
  flex: 1;
}

.patient-history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  flex-wrap: wrap;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.patient-welcome {
  background: #f0f7ff;
  padding: clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.5rem);
  border-radius: 10px;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.patient-welcome h4 {
  color: var(--primary);
  margin-bottom: 0.5rem;
  font-weight: 500;
  font-size: clamp(0.95rem, 2.5vw, 1.1rem);
}

.logout-btn {
  background: var(--gray);
  color: white;
  border: none;
  padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-height: 36px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
}

.logout-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

.logout-btn:active {
  transform: translateY(0);
}

/* Input Error Styles */
.input-error {
  border-color: var(--danger) !important;
  background-color: var(--danger-light) !important;
}

.input-error:focus {
  box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1) !important;
}

.input-error-message {
  color: var(--danger);
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
  animation: fadeIn 0.3s ease;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Mobile Navigation Bar */
.mobile-nav {
  display: none; 
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  z-index: 1000;
  padding: 0.5rem clamp(0.5rem, 2vw, 1rem);
  border-top: 1px solid var(--gray-light);
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

.mobile-nav-items {
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: clamp(0.5rem, 1.5vw, 0.75rem);
  border-radius: 8px;
  transition: var(--transition);
  text-decoration: none;
  color: var(--gray);
  font-size: clamp(0.65rem, 1.8vw, 0.75rem);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  min-width: 60px;
}

.mobile-nav-item.active {
  color: var(--primary);
  background: rgba(74, 111, 165, 0.1);
  font-weight: 600;
}

.mobile-nav-item i {
  font-size: clamp(1.1rem, 3vw, 1.25rem);
}

/* Responsive Design */

/* Tablet Landscape */
@media (max-width: 1024px) {
  .features-list {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .patient-form {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .patient-details-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Tablet Portrait */
@media (max-width: 768px) {
  .hero {
    padding: clamp(2.5rem, 6vw, 3rem) clamp(1rem, 3vw, 1.5rem);
  }
  
  .features-list {
    grid-template-columns: 1fr;
  }
  
  .question-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .option-btn {
    padding: 1rem 1.25rem;
  }
  
  .results-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .results-actions .btn {
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
  }
  
  .nav-buttons {
    flex-direction: column-reverse;
    align-items: stretch;
  }
  
  .nav-buttons button {
    width: 100%;
  }
  
  .welcome-content {
    padding: 2rem 1.5rem;
  }
  
  .question-box, .result-box {
    padding: 1.5rem;
  }
  
  .progress-container, .progress-text {
    margin-left: 1.5rem;
    margin-right: 1.5rem;
  }
  
  .history-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .history-details {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
  }
  
  .history-actions {
    width: 100%;
    justify-content: flex-start;
  }
  
  .welcome-actions {
    max-width: 100%;
  }
  
  .review-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .patient-form {
    grid-template-columns: 1fr;
  }
  
  .patient-details-grid {
    grid-template-columns: 1fr;
  }
  
  .mobile-nav {
    display: block;
  }
  
  .input-error-message {
    font-size: 0.8rem;
  }
  
  .hero-features {
    gap: 2rem;
  }
  
  .feature {
    min-width: 80px;
  }
  
  .login-actions {
    flex-direction: column;
  }
  
  .logout-btn {
    align-self: flex-start;
  }
}

/* Mobile Landscape */
@media (max-width: 640px) {
  .hero h1 {
    font-size: 1.8rem;
    line-height: 1.3;
  }
  
  .hero p {
    font-size: 1rem;
  }
  
  .diagnosis-header h3 {
    font-size: 0.9rem;
  }
  
  .diagnosis-main h1 {
    font-size: 1.4rem;
  }
  
  .patient-history-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .response-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .edit-btn {
    align-self: flex-start;
  }
  
  .history-actions {
    width: 100%;
    justify-content: stretch;
  }
  
  .btn-view,
  .btn-download,
  .btn-delete {
    flex: 1;
    justify-content: center;
  }
}

/* Mobile Portrait */
@media (max-width: 480px) {
  .diagnosis-result {
    padding: 1.5rem;
  }
  
  .diagnosis-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .login-section {
    padding: 1.25rem;
  }
  
  .history-actions {
    flex-wrap: wrap;
  }
  
  .hero h1 {
    font-size: 1.6rem;
  }
  
  .hero p {
    font-size: 0.95rem;
  }
  
  .welcome-icon {
    font-size: 2.5rem;
  }
  
  .feature-item {
    padding: 1rem;
  }
  
  .question {
    padding: 1.5rem;
  }
  
  .diagnosis-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .diagnosis-probability {
    align-self: flex-start;
  }
  
  .patient-welcome {
    padding: 1rem;
  }
  
  .hero-features {
    gap: 1.5rem;
  }
  
  .feature {
    min-width: 70px;
  }
  
  .feature i {
    font-size: 1.5rem;
  }
  
  .feature span {
    font-size: 0.8rem;
  }
}

/* Small Mobile Devices */
@media (max-width: 360px) {
  .hero {
    padding: 2rem 1rem;
  }
  
  .hero h1 {
    font-size: 1.5rem;
  }
  
  .hero p {
    font-size: 0.9rem;
  }
  
  .container {
    padding: 0 1rem;
  }
  
  .welcome-content {
    padding: 1.5rem 1rem;
  }
  
  .question-box, .result-box {
    padding: 1rem;
  }
  
  .question {
    padding: 1.25rem;
  }
  
  .option-btn {
    padding: 0.875rem 1rem;
  }
  
  .keyboard-shortcut {
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
  }
  
  .diagnosis-result {
    padding: 1.25rem;
  }
  
  .patient-info-section {
    padding: 1.25rem;
  }
  
  .responses-section {
    padding: 1.25rem;
  }
  
  .history-item {
    padding: 1.25rem;
  }
  
  .login-section {
    padding: 1rem;
  }
  
  .btn-large {
    padding: 1rem 2rem;
  }
  
  .mobile-nav-item {
    padding: 0.5rem;
    min-width: 50px;
  }
  
  .mobile-nav-item i {
    font-size: 1.1rem;
  }
  
  .mobile-nav-item span {
    font-size: 0.65rem;
  }
}

/* Ultra Small Screens */
@media (max-width: 320px) {
  .hero h1 {
    font-size: 1.4rem;
  }
  
  .hero p {
    font-size: 0.85rem;
  }
  
  .question-text {
    font-size: 1rem;
  }
  
  .option-btn {
    font-size: 0.9rem;
  }
  
  .btn {
    font-size: 0.9rem;
    padding: 0.75rem 1.5rem;
  }
  
  .diagnosis-main h1 {
    font-size: 1.2rem;
  }
  
  .diagnosis-description {
    font-size: 0.9rem;
  }
  
  .hero-features {
    gap: 1rem;
  }
  
  .feature {
    min-width: 60px;
  }
  
  .feature i {
    font-size: 1.3rem;
  }
  
  .feature span {
    font-size: 0.75rem;
  }
}

/* For number input */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -webkit-appearance: textfield;
  -moz-appearance: textfield;
  appearance: textfield;
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  .option-btn:hover,
  .feature-item:hover,
  .btn:hover,
  .diagnosis-item:hover,
  .response-item:hover,
  .history-item:hover,
  .detail-item:hover,
  .edit-btn:hover,
  .btn-view:hover,
  .btn-download:hover,
  .btn-delete:hover,
  .logout-btn:hover {
    transform: none;
  }
  
  .option-btn:active,
  .feature-item:active,
  .btn:active,
  .diagnosis-item:active,
  .response-item:active,
  .history-item:active,
  .detail-item:active,
  .edit-btn:active,
  .btn-view:active,
  .btn-download:active,
  .btn-delete:active,
  .logout-btn:active {
    transform: scale(0.98);
  }
  
  /* Larger touch targets for very small screens */
  @media (max-width: 480px) {
    .option-btn,
    .btn,
    .edit-btn,
    .btn-view,
    .btn-download,
    .btn-delete,
    .logout-btn {
      min-height: 48px;
    }
    
    .mobile-nav-item {
      min-height: 44px;
    }
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .fade-in {
    animation: none;
    opacity: 1;
  }
  
  .screen.active {
    animation: none;
  }
  
  .spinner {
    animation: none;
    border-top-color: var(--gray-light);
  }
  
  #progressFill {
    transition: none;
  }
}

/* Print Styles */
@media print {
  .hero {
    background: var(--light) !important;
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
    padding: 2rem 0 !important;
    margin-bottom: 1rem !important;
  }
  
  .controls,
  .mobile-nav,
  .nav-buttons,
  .edit-btn,
  .btn-view,
  .btn-download,
  .btn-delete,
  .logout-btn,
  .progress-container {
    display: none;
  }
  
  .survey-card,
  .diagnosis-result,
  .patient-info-section,
  .responses-section,
  .history-item,
  .login-section {
    break-inside: avoid;
    box-shadow: none !important;
    border: 1px solid #ddd !important;
  }
  
  .btn {
    display: none !important;
  }
  
  .option-btn {
    border: 1px solid #ddd !important;
  }
  
  .option-btn.selected {
    background: #f0f0f0 !important;
    color: #333 !important;
  }
}

/* iOS-specific fixes */
@supports (-webkit-touch-callout: none) {
  .btn,
  .option-btn,
  .feature-item,
  .diagnosis-item,
  .response-item,
  .history-item,
  .detail-item,
  .edit-btn,
  .btn-view,
  .btn-download,
  .btn-delete,
  .logout-btn,
  .mobile-nav-item {
    cursor: pointer;
  }
  
  /* Fix for iOS Safari rounded corners with gradients */
.hero::before {
  -webkit-mask-image: -webkit-radial-gradient(white, black); /* iOS Safari */
  mask-image: radial-gradient(white, black);                /* Standard */
}
  
  /* Fix for iOS input zoom */
  @media screen and (max-width: 768px) {
    input,
    select,
    textarea {
      font-size: 16px !important;
    }
  }
}

/* Ensure all text is selectable but buttons and interactive elements are not */
p, h1, h2, h3, h4, h5, h6, span:not(.btn *):not(.option-btn *):not(.edit-btn *):not(.btn-view *):not(.btn-download *):not(.btn-delete *):not(.logout-btn *):not(.mobile-nav-item *) {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

.btn, .option-btn, .edit-btn, .btn-view, .btn-download, .btn-delete, .logout-btn, .mobile-nav-item {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Focus states for accessibility */
.btn:focus,
.option-btn:focus,
.edit-btn:focus,
.btn-view:focus,
.btn-download:focus,
.btn-delete:focus,
.logout-btn:focus,
.mobile-nav-item:focus,
input:focus,
select:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
  border-radius: 3px;
}





/* Add custom alert styles */
.custom-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ef4444;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    max-width: 400px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.custom-alert.show {
    transform: translateX(0);
}

.alert-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.alert-icon {
    font-size: 1.5rem;
}

.alert-message {
    flex: 1;
    font-size: 0.9rem;
}

.alert-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin: 0;
}

.input-error {
    border-color: #ef4444 !important;
}

.input-error-message {
    color: #ef4444;
    font-size: 0.8rem;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
</style>
</head>

<body>


  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <h1 id="hero-title"></h1>
      <p id="hero-description"></p>
      <div class="hero-features">
        <div class="feature">
          <i class="fas fa-shield-alt"></i>
          <span id="feature-secure"></span>
        </div>
        <div class="feature">
          <i class="fas fa-brain"></i>
          <span id="feature-clinical"></span>
        </div>
        <div class="feature">
          <i class="fas fa-chart-line"></i>
          <span id="feature-insights"></span>
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <div class="survey-card">
      <!-- Welcome Screen -->
      <div id="welcomeScreen" class="screen active">
        <div class="welcome-content">
          <div class="welcome-icon">ðŸ§ </div>
          <h2 id="welcome-title"></h2>
          <p id="welcome-description"></p>

          <div class="features-list">
            <div class="feature-item">
              <span class="feature-icon">ðŸ”’</span>
              <span id="feature-confidential"></span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">âš¡</span>
              <span id="feature-time"></span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ðŸ“Š</span>
              <span id="feature-evidence"></span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ðŸ’¡</span>
              <span id="feature-personalized"></span>
            </div>
          </div>

          <div class="welcome-actions">
            <button id="startBtn" class="btn btn-primary btn-large">
              <span id="start-button-text"></span>
              <span>â†’</span>
            </button>
            <button id="viewHistoryBtn" class="btn btn-secondary">
              <i class="fas fa-history"></i>
              <span id="view-history-button-text"></span>
            </button>
          </div>

          <div class="info-note">
            <strong id="important-note-title"></strong> 
            <span id="important-note-text"></span>
          </div>
        </div>
      </div>

      <!-- Questions Screen -->
      <div id="questionsScreen" class="screen">
        <div class="progress-text" id="progressText"></div>
        <div class="progress-container">
          <div id="progressFill"></div>
        </div>

        <div class="question-box">
          <div class="question">
            <div class="question-header">
              <div class="question-number" id="questionCategory"></div>
            </div>
            
            <div class="question-text" id="questionText"></div>

            <div class="options" id="optionsContainer"></div>

            <div class="nav-buttons">
              <button id="prevBtn" class="btn btn-secondary" disabled>
                <span id="previous-button-text"></span>
              </button>
              <button id="nextBtn" class="btn btn-primary" disabled>
                <span id="next-button-text"></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Screen -->
      <div id="loadingScreen" class="screen">
        <div class="loading-state">
          <div class="spinner"></div>
          <h2 id="processing-title"></h2>
          <p id="processing-description"></p>
          
          <div class="loading-details">
            <div class="loading-step" id="step-validating"></div>
            <div class="loading-step" id="step-calculating"></div>
            <div class="loading-step" id="step-analyzing"></div>
            <div class="loading-step" id="step-generating"></div>
            <div class="loading-step" id="step-finalizing"></div>
          </div>
        </div>
      </div>

      <!-- Edit Review Screen -->
      <div id="reviewScreen" class="screen">
        <div class="result-box">
          <div class="results-header">
            <h2 id="review-title"></h2>
            <p id="review-description"></p>
          </div>

          <div class="review-content">
            <div class="patient-info-section">
              <h3 id="patient-info-title"></h3>
                <div class="patient-form">
                  <div class="form-group">
                    <label for="patientName" id="patient-name-label"></label>
                    <input type="text" id="patientName" placeholder="">
                    <div class="validation-message" id="patient-name-validation"></div>
                  </div>
                  <div class="form-group">
                    <label for="patientNumber" id="patient-number-label"></label>
                    <input type="text" id="patientNumber" 
                          placeholder=""
                          maxlength="20"
                          title="">
                    <div class="validation-message" id="patient-number-validation">
                      <div class="validation-hint" id="patient-number-hint"></div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="patientAge" id="patient-age-label"></label>
                    <input type="number" id="patientAge" 
                          min="18" 
                          max="100" 
                          step="1"
                          placeholder=""
                          title="">
                    <div class="validation-message" id="patient-age-validation">
                      <div class="validation-hint" id="patient-age-hint"></div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="patientGender" id="patient-gender-label"></label>
                    <select id="patientGender">
                      <option value="" id="gender-default"></option>
                      <option value="Male" id="gender-male"></option>
                      <option value="Female" id="gender-female"></option>
                      <option value="Other" id="gender-other"></option>
                      <option value="Prefer not to say" id="gender-prefer-not"></option>
                    </select>
                  </div>
                </div>
              <div class="info-note" style="margin-top: 1rem;">
                <strong id="review-note-title"></strong> 
                <span id="review-note-text"></span>
              </div>
            </div>

            <div class="responses-section">
              <h3 id="responses-title"></h3>
              <div class="responses-list" id="responsesList"></div>
            </div>
          </div>

          <div class="review-actions">
            <button id="backToQuestionsBtn" class="btn btn-secondary">
              <span id="back-to-questions"></span>
            </button>
            <button id="submitFinalBtn" class="btn btn-primary">
              <span id="submit-assessment-button"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Results Screen -->
      <div id="resultsScreen" class="screen">
        <div class="result-box">
          <div class="results-header">
            <h2 id="results-complete"></h2>
            <div class="results-meta">
              <span id="resultsDate"></span>
              <span>â€¢</span>
              <span id="assessmentId"></span>
            </div>
          </div>

          <div class="primary-result">
            <div class="diagnosis-result diagnosis-normal">
              <div class="diagnosis-header">
                <h3 id="primary-result-title"></h3>
                <div class="confidence-badge" id="confidenceBadge"></div>
              </div>
              <div class="diagnosis-main">
                <h1 id="primaryDiagnosis"></h1>
                <p class="diagnosis-description" id="diagnosisDescription"></p>
              </div>
            </div>
          </div>

          <div class="additional-results">
            <div class="results-section">
              <h4 id="other-diagnoses-title"></h4>
              <div class="diagnoses-list" id="diagnosesList"></div>
            </div>

            <div class="results-section" id="questionsAnswersSection" style="display: none;">
              <h4 id="questions-answers-title"></h4>
              <div class="responses-list" id="historicalResponsesList"></div>
            </div>
          </div>

          <div class="info-note">
            <strong id="disclaimer-title"></strong> 
            <span id="disclaimer-text"></span>
          </div>

          <div class="results-actions">
            <button id="newAssessmentBtn" class="btn btn-secondary">
              <span id="new-assessment-button"></span>
            </button>
            <button id="learnMoreBtn" class="btn btn-info">
              <i class="fas fa-chart-line"></i> 
              <span id="learn-more-button"></span>
            </button>
            <button id="downloadBtn" class="btn btn-primary">
              <i class="fas fa-download"></i>
              <span id="download-button"></span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- History Screen -->
      <div id="historyScreen" class="screen">
        <div class="result-box">
          <div class="results-header">
            <h2 id="history-title"></h2>
            <p id="history-description"></p>
          </div>

          <!-- Login Section -->
          <div class="login-section" id="loginSection">
            <h3 id="access-history-title"></h3>
            <div class="login-form">
              <div class="form-group">
                <label for="loginPatientName" id="login-name-label"></label>
                <input type="text" id="loginPatientName" placeholder="">
                <div class="validation-message" id="login-name-validation"></div>
              </div>
              <div class="form-group">
                <label for="loginPatientNumber" id="login-number-label"></label>
                <input type="text" id="loginPatientNumber" 
                      placeholder=""
                      maxlength="20"
                      title="">
                <div class="validation-message" id="login-number-validation">
                  <div class="validation-hint" id="login-number-hint"></div>
                </div>
              </div>
              <div class="login-actions">
                <button class="btn btn-secondary" id="backToWelcomeFromLoginBtn">
                  <span id="login-back-button"></span>
                </button>
                <button class="btn btn-primary" id="loginBtn">
                  <i class="fas fa-sign-in-alt"></i> 
                  <span id="login-access-button"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Patient History Section -->
          <div id="patientHistorySection" style="display: none;">
            <div class="patient-history-header">
              <div class="patient-welcome">
                <h4 id="welcome-patient"></h4>
                <p>
                  <span id="login-number-label"></span>
                  <strong id="loggedInPatientNumber"></strong>
                </p>
              </div>
              <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> 
                <span id="logout-button"></span>
              </button>
            </div>

            <div class="history-content">
              <div class="history-list" id="patientHistoryList"></div>
            </div>
          </div>

          <div class="history-actions">
            <button id="backToWelcomeBtn" class="btn btn-secondary">
              <span id="history-back-button"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mobile Navigation -->
  <nav class="mobile-nav">
    <div class="mobile-nav-items">
      <a href="#" class="mobile-nav-item active" data-screen="welcomeScreen">
        <i class="fas fa-home"></i>
        <span id="mobile-home"></span>
      </a>
      <a href="#" class="mobile-nav-item" id="mobileAssessmentBtn">
        <i class="fas fa-question-circle"></i>
        <span id="mobile-assessment"></span>
      </a>
      <a href="#" class="mobile-nav-item" id="mobileHistoryBtn">
        <i class="fas fa-history"></i>
        <span id="mobile-history"></span>
      </a>
    </div>
  </nav>

  <!-- Footer will be loaded by components.js -->

  <!-- Load components.js first -->
  <script src="../js/components.js"></script>
  
  <!-- Main assessment script -->
  <script>
// ============================================
// MENTAL HEALTH ASSESSMENT 
// ============================================

// Wait for DOM and i18n system to be ready
document.addEventListener('DOMContentLoaded', function() {
    if (!window.i18n) {
        setTimeout(initializeAssessment, 100);
        return;
    }
    
    initializeAssessment();
});

function initializeAssessment() {
    const API_BASE_URL = window.location.origin;
    let ASSESSMENT_CONFIG = {};
    
    // Security Utilities
    class SecurityUtils {
        static getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                   this.getCookie('csrf_token');
        }
        
        static getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return null;
        }
        
        static generateSecureHeaders(method = 'GET') {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add CSRF token for state-changing operations
            if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                const csrfToken = this.getCSRFToken();
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }
            }
            
            return headers;
        }
        
        static sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/[<>"'`]/g, '').substring(0, 100);
        }

        static validateAge(age) {
            if (!age) return { valid: true, message: '' };
            
            age = age.toString().trim();
            
            // Dynamically get current language from i18n system
            const currentLang = window.i18n?.currentLang || 'en';
            const translations = window.i18n?.translations[currentLang]?.prediction?.validation?.age || {};
            
            if (!/^\d+$/.test(age)) {
                return { 
                    valid: false, 
                    message: translations.not_number || translations.invalid_number || 'Please enter numbers only (0-9)'
                };
            }
            
            const ageNum = parseInt(age, 10);
            if (ageNum < 12) {
                return { 
                    valid: false, 
                    message: translations.too_young || 'Age must be 12 or older'
                };
            }
            if (ageNum > 100) {
                return { 
                    valid: false, 
                    message: translations.too_old || 'Age must be 100 or younger'
                };
            }
            
            return { valid: true, message: '' };
        }

        static validatePatientNumber(number) {
            if (!number) return { valid: true, message: '' };
            
            const trimmed = number.trim();
            
            // Dynamically get current language from i18n system
            const currentLang = window.i18n?.currentLang || 'en';
            const translations = window.i18n?.translations[currentLang]?.prediction?.validation?.patient_number || {};
            
            if (trimmed.length < 6) {
                return { 
                    valid: false, 
                    message: translations.too_short || 'Patient number must be at least 6 characters'
                };
            }
            
            if (trimmed.length > 20) {
                return { 
                    valid: false, 
                    message: translations.too_long || 'Patient number cannot exceed 20 characters'
                };
            }
            
            if (!/[a-z]/.test(trimmed)) {
                return { 
                    valid: false, 
                    message: translations.no_lowercase || 'Must include at least one lowercase letter (a-z)'
                };
            }
            
            if (!/[A-Z]/.test(trimmed)) {
                return { 
                    valid: false, 
                    message: translations.no_uppercase || 'Must include at least one uppercase letter (A-Z)'
                };
            }
            
            if (!/[0-9]/.test(trimmed)) {
                return { 
                    valid: false, 
                    message: translations.no_digit || 'Must include at least one number (0-9)'
                };
            }
            
            if (/[^a-zA-Z0-9]/.test(trimmed)) {
                return { 
                    valid: false, 
                    message: translations.special_chars || 'Only letters and numbers allowed (no special characters)'
                };
            }
            
            return { valid: true, message: '' };
        }

        static validateName(name) {
            if (!name || name.trim().length === 0) {
                // Dynamically get current language from i18n system
                const currentLang = window.i18n?.currentLang || 'en';
                const translations = window.i18n?.translations[currentLang]?.prediction?.validation?.name || {};
                return { 
                    valid: false, 
                    message: translations.required || 'Name is required'
                };
            }
            
            const trimmed = name.trim();
            
            // Dynamically get current language from i18n system
            const currentLang = window.i18n?.currentLang || 'en';
            const translations = window.i18n?.translations[currentLang]?.prediction?.validation?.name || {};
            
            if (trimmed.length < 2) {
                return { 
                    valid: false, 
                    message: translations.too_short || 'Name must be at least 2 characters'
                };
            }
            
            if (trimmed.length > 50) {
                return { 
                    valid: false, 
                    message: translations.too_long || 'Name cannot exceed 50 characters'
                };
            }
            
            // Allow letters, spaces, hyphens, and apostrophes
            if (!/^[a-zA-ZÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿\s\-']+$/u.test(trimmed)) {
                return { 
                    valid: false, 
                    message: translations.invalid_format || 'Name can only contain letters, spaces, hyphens, and apostrophes'
                };
            }
            
            return { valid: true, message: '' };
        }
              
      
      }
        
    // ============================================
    // DISPLAY MANAGER CLASS
    // ============================================
    
    class AssessmentDisplayManager {
        constructor() {
            this.currentLanguage = window.i18n?.currentLang || 'en';
        }
        
        // ============================================
        // CORE DISPLAY FUNCTIONS
        // ============================================
        
        /**
         * Display 1: New Assessment Results
         */
        displayNewAssessmentResults(assessmentData, patientInfo) {
            // Ensure data is in canonical English format
            const canonicalData = this.ensureCanonicalEnglishData(assessmentData);
            
            return `
                <div class="result-box">
                    ${this.displayResultsHeader(canonicalData)}
                    ${this.displayPatientInfoSection(patientInfo)}
                    ${this.displayPrimaryDiagnosisSection(canonicalData)}
                    ${this.displayOtherDiagnosesSection(canonicalData)}
                    ${this.displayDisclaimerSection()}
                    ${this.displayNewAssessmentActions()}
                </div>
            `;
        }
        
        /**
         * Display 2: Historical Assessment Results
         */
        displayHistoricalAssessment(assessmentData) {
            // Ensure data is in canonical English format
            const canonicalData = this.ensureCanonicalEnglishData(assessmentData);
            
            return `
                <div class="result-box">
                    ${this.displayResultsHeader(canonicalData)}
                    ${this.displayPatientInfoSection(assessmentData.patient_info || {})}
                    ${this.displayPrimaryDiagnosisSection(canonicalData)}
                    ${this.displayOtherDiagnosesSection(canonicalData)}
                    ${this.displayQuestionsAnswersSection(canonicalData)}
                    ${this.displayDisclaimerSection()}
                    ${this.displayHistoricalActions()}
                </div>
            `;
        }
        
        // ============================================
        // COMPONENT 1: PATIENT INFORMATION
        // ============================================
        
        displayPatientInfoSection(patientInfo) {
            if (!patientInfo || Object.keys(patientInfo).length === 0) {
                return '';
            }
            
            const translations = this.getTranslations();
            const notProvided = translations.not_provided || 'Not provided';
            
            // Translate gender value
            let genderDisplay = notProvided;
            if (patientInfo.gender) {
                const genderKey = `patient-gender-${patientInfo.gender.toLowerCase().replace(/\s+/g, '-')}`;
                genderDisplay = translations[genderKey] || patientInfo.gender;
            }
            
            return `
                <div class="patient-info-section">
                    <h3>${translations['patient-info-title'] || 'Patient Information'}</h3>
                    <div class="patient-form">
                        <div class="form-group">
                            <label>${translations['patient-name-label'] || 'Name'}</label>
                            <div class="patient-info-value">${patientInfo.name || notProvided}</div>
                        </div>
                        <div class="form-group">
                            <label>${translations['patient-number-label'] || 'Patient Number'}</label>
                            <div class="patient-info-value">${patientInfo.number || notProvided}</div>
                        </div>
                        <div class="form-group">
                            <label>${translations['patient-age-label'] || 'Age'}</label>
                            <div class="patient-info-value">${patientInfo.age || notProvided}</div>
                        </div>
                        <div class="form-group">
                            <label>${translations['patient-gender-label'] || 'Gender'}</label>
                            <div class="patient-info-value">${genderDisplay}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // COMPONENT 2: PRIMARY DIAGNOSIS
        // ============================================
        
        displayPrimaryDiagnosisSection(assessmentData) {
            if (!assessmentData.primary_diagnosis) {
                return '<div class="diagnosis-error">No diagnosis available</div>';
            }
            
            const translations = this.getTranslations();
            const canonicalKey = assessmentData.primary_diagnosis;
            
            // Get translated diagnosis
            const translatedDiagnosis = this.translateDiagnosis(canonicalKey);
            
            // Get diagnosis description
            const diagnosisDesc = this.getDiagnosisDescription(canonicalKey) || 
                                translations.default_description || 
                                'Please consult with a healthcare professional for accurate diagnosis.';
            
            // Calculate confidence percentage
            const confidencePercent = assessmentData.confidence_percentage || 
                                    (assessmentData.confidence ? Math.round(assessmentData.confidence * 100) : 0);
            
            // Determine confidence color
            let confidenceColor = '#10b981'; // Green
            if (confidencePercent < 70) confidenceColor = '#f59e0b'; // Yellow
            if (confidencePercent < 50) confidenceColor = '#ef4444'; // Red
            
            return `
                <div class="primary-result">
                    <div class="diagnosis-result">
                        <div class="diagnosis-header">
                            <h3>${translations['primary-result-title'] || 'Primary Assessment Result'}</h3>
                            <div class="confidence-badge" style="background: ${confidenceColor};">
                                <span class="confidence-text">
                                    ${translations.confidence || 'Confidence'}: ${confidencePercent}%
                                </span>
                            </div>
                        </div>
                        <div class="diagnosis-main">
                            <h1>${translatedDiagnosis}</h1>
                            <p class="diagnosis-description">${diagnosisDesc}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // COMPONENT 3: OTHER DIAGNOSES
        // ============================================
        
        displayOtherDiagnosesSection(assessmentData) {
            const translations = this.getTranslations();
            const otherDiagnosesTitle = translations['other-diagnoses-title'] || 'Other Possible Diagnoses';
            
            if (!assessmentData.all_diagnoses || assessmentData.all_diagnoses.length <= 1) {
                return `
                    <div class="additional-results">
                        <div class="results-section">
                            <h4>${otherDiagnosesTitle}</h4>
                            <div class="no-other-diagnoses">
                                ${translations['errors.noOtherDiagnoses'] || 'No other diagnoses considered'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Skip primary diagnosis (index 0)
            const otherDiagnoses = assessmentData.all_diagnoses.slice(1, 5);
            
            const diagnosesHTML = otherDiagnoses.map(diagnosis => {
                const canonicalKey = diagnosis.original_diagnosis || diagnosis.diagnosis;
                const translatedDiagnosis = this.translateDiagnosis(canonicalKey);
                const confidence = diagnosis.confidence_percentage || 
                                 (diagnosis.probability ? Math.round(diagnosis.probability * 100) : 0);
                
                return `
                    <div class="diagnosis-item">
                        <span class="diagnosis-name">${translatedDiagnosis}</span>
                        <span class="diagnosis-probability">${confidence}%</span>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="additional-results">
                    <div class="results-section">
                        <h4>${otherDiagnosesTitle}</h4>
                        <div class="diagnoses-list">
                            ${diagnosesHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // COMPONENT 4: QUESTIONS & ANSWERS (Historical Only)
        // ============================================
        
        displayQuestionsAnswersSection(assessmentData) {
            const translations = this.getTranslations();
            const sectionTitle = translations['questions-answers-title'] || 'Assessment Questions & Answers';
            const answerLabel = translations.answerLabel || 'Answer:';
            const notAnswered = translations.notAnswered || 'Not answered';
            
            if (!assessmentData.responses || Object.keys(assessmentData.responses).length === 0) {
                return `
                    <div class="results-section">
                        <h4>${sectionTitle}</h4>
                        <div class="no-responses">
                            ${translations['errors.noResponses'] || 'No response data available'}
                        </div>
                    </div>
                `;
            }
            
            // Get question configuration from main assessment
            const questionsConfig = this.getQuestionsConfig();
            if (!questionsConfig || !questionsConfig.questions) {
                return '';
            }
            
            const responsesHTML = questionsConfig.questions.map(question => {
                const feature = question.feature;
                const responseValue = assessmentData.responses[feature];
                
                // Get translated question text
                const questionTranslations = translations.questions || {};
                const questionText = questionTranslations[question.questionId] || question.question;
                
                // Get translated answer
                let translatedAnswer = notAnswered;
                if (responseValue !== undefined && responseValue !== null && responseValue !== '') {
                    translatedAnswer = this.translateAnswerValue(responseValue, question.type);
                }
                
                return `
                    <div class="response-item">
                        <div class="response-question">
                            <div class="response-category">${question.category}</div>
                            <div class="response-text">${questionText}</div>
                            <div class="response-answer">
                                <strong>${answerLabel}</strong> ${translatedAnswer}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="results-section">
                    <h4>${sectionTitle}</h4>
                    <div class="responses-list">
                        ${responsesHTML}
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // SUPPORTING COMPONENTS
        // ============================================
        
        displayResultsHeader(assessmentData) {
            const translations = this.getTranslations();
            const timestamp = assessmentData.timestamp || new Date().toISOString();
            const dateText = this.formatDateForLocale(timestamp);
            const assessmentId = assessmentData.id || assessmentData.assessment_id || 'N/A';
            
            return `
                <div class="results-header">
                    <h2>${translations['results-complete'] || 'Assessment Complete'}</h2>
                    <div class="results-meta">
                        <span>${dateText}</span>
                        <span>â€¢</span>
                        <span>ID: ${assessmentId}</span>
                    </div>
                </div>
            `;
        }
        
        displayDisclaimerSection() {
            const translations = this.getTranslations();
            return `
                <div class="info-note">
                    <strong>${translations['disclaimer-title'] || 'Important Disclaimer:'}</strong> 
                    <span>${translations['disclaimer-text'] || 'This assessment is for informational purposes only...'}</span>
                </div>
            `;
        }
        
        displayNewAssessmentActions() {
            const translations = this.getTranslations();
            const navTranslations = translations.navigation || {};
            
            return `
                <div class="results-actions">
                    <button id="newAssessmentBtn" class="btn btn-secondary">
                        ${navTranslations['new-assessment'] || 'â†» New Assessment'}
                    </button>
                    <button id="learnMoreBtn" class="btn btn-info">
                        <i class="fas fa-chart-line"></i>
                        ${navTranslations['learn-more'] || 'Learn More'}
                    </button>
                    <button id="downloadBtn" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        ${navTranslations['download-report'] || 'Download Report'}
                    </button>
                </div>
            `;
        }
                
        displayHistoricalActions() {
            const translations = this.getTranslations();
            const navTranslations = translations.navigation || {};
            
            return `
                <div class="results-actions">
                    <button id="backToHistoryBtn" class="btn btn-secondary">
                        â† ${navTranslations['back-to-history'] || 'Back to History'}
                    </button>
                           <button id="learnMoreBtn" class="btn btn-info">
                        <i class="fas fa-chart-line"></i>
                        ${navTranslations['learn-more'] || 'Learn More'}
                    </button>
                    <button id="downloadHistoricalBtn" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        ${navTranslations['download-report'] || 'Download Report'}
                    </button>
                </div>
            `;
        }
        
        // ============================================
        // TRANSLATION HELPERS
        // ============================================
        
        getTranslations() {
            return window.i18n?.translations[this.currentLanguage]?.prediction || {};
        }
        
        translateDiagnosis(canonicalKey) {
            if (!canonicalKey) return 'Unknown';
            
            const translations = this.getTranslations();
            const pdfTranslations = window.i18n?.translations[this.currentLanguage]?.pdf_report || {};
            
            // Try prediction translations first
            const diagnosisTranslations = translations.diagnosisTranslations || {};
            let translated = diagnosisTranslations[canonicalKey];
            
            // If not found, try PDF translations
            if (!translated) {
                const pdfDiagnosisTranslations = pdfTranslations.diagnosisTranslations || {};
                translated = pdfDiagnosisTranslations[canonicalKey];
            }
            
            // Fall back to English or original key
            if (!translated) {
                const enTranslations = window.i18n?.translations['en']?.prediction?.diagnosisTranslations || {};
                translated = enTranslations[canonicalKey] || canonicalKey;
            }
            
            return translated;
        }
        
        getDiagnosisDescription(canonicalKey) {
            const translations = this.getTranslations();
            const pdfTranslations = window.i18n?.translations[this.currentLanguage]?.pdf_report || {};
            
            let diagnosisDescriptions = translations.diagnosisDescriptions || {};
            
            if (!diagnosisDescriptions || Object.keys(diagnosisDescriptions).length === 0) {
                diagnosisDescriptions = pdfTranslations.diagnosisDescription || {};
            }
            
            return diagnosisDescriptions[canonicalKey];
        }
        
        translateAnswerValue(answerValue, questionType) {
            if (answerValue === null || answerValue === undefined || answerValue === '') {
                const translations = this.getTranslations();
                return translations.notAnswered || 'Not answered';
            }
            
            const translations = this.getTranslations();
            const pdfTranslations = window.i18n?.translations[this.currentLanguage]?.pdf_report || {};
            
            let answerValues = translations.answer_values || {};
            
            if (!answerValues || Object.keys(answerValues).length === 0) {
                answerValues = pdfTranslations.answer_values || {};
            }
            
            const answerStr = String(answerValue).trim();
            const categoryMap = {
                'frequency': ['frequency'],
                'yesNo': ['yesNo'],
                'concentration': ['concentration'],
                'optimism': ['optimism'],
                'sexualActivity': ['sexualActivity']
            };
            
            const categories = categoryMap[questionType] || [questionType];
            
            for (const category of categories) {
                if (answerValues[category]) {
                    const categoryDict = answerValues[category];
                    
                    // Exact match
                    if (categoryDict[answerStr] !== undefined) {
                        return categoryDict[answerStr];
                    }
                    
                    // Case-insensitive match
                    for (const [key, value] of Object.entries(categoryDict)) {
                        if (key.toLowerCase() === answerStr.toLowerCase()) {
                            return value;
                        }
                    }
                }
            }
            
            // Fallback to English translations
            if (this.currentLanguage !== 'en') {
                const enTranslations = window.i18n?.translations['en']?.prediction?.answer_values || {};
                for (const category of categories) {
                    if (enTranslations[category]) {
                        const categoryDict = enTranslations[category];
                        if (categoryDict[answerStr] !== undefined) {
                            return categoryDict[answerStr];
                        }
                    }
                }
            }
            
            return answerStr;
        }
        
        // ============================================
        // DATA PROCESSING HELPERS
        // ============================================
        
        ensureCanonicalEnglishData(assessmentData) {
            const result = { ...assessmentData };
            
            // Ensure primary diagnosis is in canonical English format
            if (result.primary_diagnosis && !this.isCanonicalKey(result.primary_diagnosis)) {
                result.original_diagnosis = result.primary_diagnosis;
                result.primary_diagnosis = this.convertToCanonicalKey(result.primary_diagnosis);
            }
            
            // Ensure all diagnoses have canonical keys
            if (result.all_diagnoses && Array.isArray(result.all_diagnoses)) {
                result.all_diagnoses = result.all_diagnoses.map(diagnosis => {
                    if (diagnosis.original_diagnosis && this.isCanonicalKey(diagnosis.original_diagnosis)) {
                        return diagnosis;
                    }
                    
                    const canonicalKey = this.convertToCanonicalKey(diagnosis.diagnosis);
                    return {
                        ...diagnosis,
                        original_diagnosis: canonicalKey
                    };
                });
            }
            
            return result;
        }
        
        isCanonicalKey(text) {
            const canonicalKeys = ['Normal', 'Bipolar Type-1', 'Bipolar Type-2', 'Depression'];
            return canonicalKeys.includes(text);
        }
        
        convertToCanonicalKey(diagnosisText) {
            if (!diagnosisText) return 'Unknown';
            
            // Check if already canonical
            if (this.isCanonicalKey(diagnosisText)) {
                return diagnosisText;
            }
            
            // Try to find in translations
            const languages = ['en', 'vi', 'es', 'zh'];
            for (const lang of languages) {
                const translations = window.i18n?.translations[lang]?.prediction?.diagnosisTranslations || {};
                for (const [canonicalKey, translatedText] of Object.entries(translations)) {
                    if (translatedText === diagnosisText) {
                        return canonicalKey;
                    }
                }
            }
            
            // Heuristic matching
            const lowerText = diagnosisText.toLowerCase();
            if (lowerText.includes('bipolar') && lowerText.includes('type-1')) return 'Bipolar Type-1';
            if (lowerText.includes('bipolar') && lowerText.includes('type-2')) return 'Bipolar Type-2';
            if (lowerText.includes('depression')) return 'Depression';
            if (lowerText.includes('normal')) return 'Normal';
            
            return diagnosisText;
        }
        
        formatDateForLocale(dateString) {
            if (!dateString || dateString === 'N/A') return 'Unknown';
            try {
                const date = new Date(dateString);
                
                if (this.currentLanguage === 'vi') {
                    const months = ['thÃ¡ng 1', 'thÃ¡ng 2', 'thÃ¡ng 3', 'thÃ¡ng 4', 'thÃ¡ng 5', 'thÃ¡ng 6',
                                  'thÃ¡ng 7', 'thÃ¡ng 8', 'thÃ¡ng 9', 'thÃ¡ng 10', 'thÃ¡ng 11', 'thÃ¡ng 12'];
                    return `NgÃ y ${date.getDate()} ${months[date.getMonth()]} nÄƒm ${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else if (this.currentLanguage === 'zh') {
                    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else if (this.currentLanguage === 'es') {
                    const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                                  'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                    return `${date.getDate()} de ${months[date.getMonth()]} de ${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    // English and other languages
                    const monthNames = {
                        'en': ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December']
                    };
                    
                    const monthList = monthNames[this.currentLanguage] || monthNames['en'];
                    return `${date.getDate()} ${monthList[date.getMonth()]} ${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }
            } catch (error) {
                return dateString;
            }
        }
        
        getQuestionsConfig() {
            return ASSESSMENT_CONFIG;
        }
        
        setLanguage(language) {
            this.currentLanguage = language;
        }
    }
    
    // ============================================
    // MAIN ASSESSMENT CLASS
    // ============================================
    
    class MentalHealthAssessment {
        constructor() {
            this.displayManager = new AssessmentDisplayManager();
            this.currentLanguage = window.i18n?.currentLang || 'en';
            this.userSessionId = null;
            this.currentPatient = null;
            this.currentQuestionIndex = 0;
            this.responses = {};
            this.isSubmitting = false;
            this.patientInfo = { name: '', number: '', age: '', gender: '' };
            this.assessmentHistory = [];
            this.assessmentStartTime = null;
            this.currentAssessmentData = null;
            
            this.initializeElements();
            this.attachEventListeners();
            this.attachKeyboardListeners();
            this.attachMobileNavigationListeners();
            
            setTimeout(() => {
                this.updateAllTexts();
                this.initializeAssessmentConfig();
                this.setupAgeValidation();
                this.setupPatientNumberValidation();
                this.setupNameValidation();
            }, 300);
        }
        
        // ============================================
        // INITIALIZATION METHODS
        // ============================================
        
        initializeElements() {
            // Screen elements
            this.welcomeScreen = document.getElementById('welcomeScreen');
            this.questionsScreen = document.getElementById('questionsScreen');
            this.loadingScreen = document.getElementById('loadingScreen');
            this.resultsScreen = document.getElementById('resultsScreen');
            this.reviewScreen = document.getElementById('reviewScreen');
            this.historyScreen = document.getElementById('historyScreen');
            
            // Welcome screen elements
            this.startBtn = document.getElementById('startBtn');
            this.viewHistoryBtn = document.getElementById('viewHistoryBtn');
            
            // Questions screen elements
            this.progressFill = document.getElementById('progressFill');
            this.progressText = document.getElementById('progressText');
            this.questionCategory = document.getElementById('questionCategory');
            this.questionText = document.getElementById('questionText');
            this.optionsContainer = document.getElementById('optionsContainer');
            this.prevBtn = document.getElementById('prevBtn');
            this.nextBtn = document.getElementById('nextBtn');
            
            // Review screen elements
            this.responsesList = document.getElementById('responsesList');
            this.backToQuestionsBtn = document.getElementById('backToQuestionsBtn');
            this.submitFinalBtn = document.getElementById('submitFinalBtn');
            this.patientName = document.getElementById('patientName');
            this.patientNumber = document.getElementById('patientNumber');
            this.patientAge = document.getElementById('patientAge');
            this.patientGender = document.getElementById('patientGender');
            
            // Results screen elements
            this.newAssessmentBtn = document.getElementById('newAssessmentBtn');
            this.downloadBtn = document.getElementById('downloadBtn');
            this.learnMoreBtn = document.getElementById('learnMoreBtn');
            
            // History screen elements
            this.loginSection = document.getElementById('loginSection');
            this.patientHistorySection = document.getElementById('patientHistorySection');
            this.loginPatientName = document.getElementById('loginPatientName');
            this.loginPatientNumber = document.getElementById('loginPatientNumber');
            this.loginBtn = document.getElementById('loginBtn');
            this.logoutBtn = document.getElementById('logoutBtn');
            this.backToWelcomeFromLoginBtn = document.getElementById('backToWelcomeFromLoginBtn');
            this.loggedInPatientNumber = document.getElementById('loggedInPatientNumber');
            this.patientHistoryList = document.getElementById('patientHistoryList');
            this.backToWelcomeBtn = document.getElementById('backToWelcomeBtn');
        }
        
        initializeAssessmentConfig() {
            const translations = window.i18n.translations[this.currentLanguage]?.prediction || {};
            const pdfTranslations = window.i18n.translations[this.currentLanguage]?.pdf_report || {};
            
            // Get question translations
            const questionCategories = translations.questionCategories || pdfTranslations.question_categories || {};
            const questionTranslations = translations.questions || pdfTranslations.questions || {};
            
            // Define the canonical English questions configuration
            const questions = [
                {
                    category: questionCategories["Mood & Emotions"] || "Mood & Emotions",
                    question: questionTranslations.moodSwing || "Do you experience sudden changes in your mood?",
                    feature: "Mood Swing",
                    type: "yesNo",
                    questionId: "moodSwing"
                },
                {
                    category: questionCategories["Mood & Emotions"] || "Mood & Emotions",
                    question: questionTranslations.sadness || "How often do you feel sad or emotionally low?",
                    feature: "Sadness",
                    type: "frequency",
                    questionId: "sadness"
                },
                {
                    category: questionCategories["Mood & Emotions"] || "Mood & Emotions",
                    question: questionTranslations.euphoric || "How often do you experience unusually high energy or euphoria?",
                    feature: "Euphoric",
                    type: "frequency",
                    questionId: "euphoric"
                },
                {
                    category: questionCategories["Sleep & Energy"] || "Sleep & Energy",
                    question: questionTranslations.sleepDisorder || "How often do you struggle with sleep, such as difficulty falling or staying asleep?",
                    feature: "Sleep disorder",
                    type: "frequency",
                    questionId: "sleepDisorder"
                },
                {
                    category: questionCategories["Sleep & Energy"] || "Sleep & Energy",
                    question: questionTranslations.exhausted || "How often do you feel tired or drained of energy?",
                    feature: "Exhausted",
                    type: "frequency",
                    questionId: "exhausted"
                },
                {
                    category: questionCategories["Safety Assessment"] || "Safety Assessment",
                    question: questionTranslations.suicidalThoughts || "Have you had thoughts of harming yourself?",
                    feature: "Suicidal thoughts",
                    type: "yesNo",
                    questionId: "suicidalThoughts"
                },
                {
                    category: questionCategories["Behavioral Patterns"] || "Behavioral Patterns",
                    question: questionTranslations.aggressiveResponse || "Do you become aggressive or hostile during conflicts?",
                    feature: "Aggressive Response",
                    type: "yesNo",
                    questionId: "aggressiveResponse"
                },
                {
                    category: questionCategories["Behavioral Patterns"] || "Behavioral Patterns",
                    question: questionTranslations.nervousBreakdown || "Have you experienced a moment where you felt emotionally overwhelmed or unable to cope?",
                    feature: "Nervous Breakdown",
                    type: "yesNo",
                    questionId: "nervousBreakdown"
                },
                {
                    category: questionCategories["Anxiety & Worry"] || "Anxiety & Worry",
                    question: questionTranslations.overthinking || "Do you find yourself worrying or overthinking more than you'd like?",
                    feature: "Overthinking",
                    type: "yesNo",
                    questionId: "overthinking"
                },
                {
                    category: questionCategories["Physical Health"] || "Physical Health",
                    question: questionTranslations.anorexia || "Have you noticed major changes in your appetite or eating habits?",
                    feature: "Anorexia",
                    type: "yesNo",
                    questionId: "anorexia"
                },
                {
                    category: questionCategories["Social Behavior"] || "Social Behavior",
                    question: questionTranslations.authorityRespect || "Do you generally follow rules and respect authority figures?",
                    feature: "Authority Respect",
                    type: "yesNo",
                    questionId: "authorityRespect"
                },
                {
                    category: questionCategories["Conflict Resolution"] || "Conflict Resolution",
                    question: questionTranslations.tryExplanation || "When conflicts happen, do you try to explain your point of view?",
                    feature: "Try Explanation",
                    type: "yesNo",
                    questionId: "tryExplanation"
                },
                {
                    category: questionCategories["Conflict Resolution"] || "Conflict Resolution",
                    question: questionTranslations.ignoreMoveOn || "Do you tend to avoid problems rather than addressing them?",
                    feature: "Ignore & Move-On",
                    type: "yesNo",
                    questionId: "ignoreMoveOn"
                },
                {
                    category: questionCategories["Self-Reflection"] || "Self-Reflection",
                    question: questionTranslations.admitMistakes || "Are you comfortable admitting when you're wrong?",
                    feature: "Admit Mistakes",
                    type: "yesNo",
                    questionId: "admitMistakes"
                },
                {
                    category: questionCategories["Cognitive Function"] || "Cognitive Function",
                    question: questionTranslations.concentration || "How would you rate your ability to stay focused?",
                    feature: "Concentration",
                    type: "concentration",
                    questionId: "concentration"
                },
                {
                    category: questionCategories["Cognitive Function"] || "Cognitive Function",
                    question: questionTranslations.optimism || "How would you describe your general outlook on life?",
                    feature: "Optimism",
                    type: "optimism",
                    questionId: "optimism"
                },
                {
                    category: questionCategories["Sexual Health"] || "Sexual Health",
                    question: questionTranslations.sexualActivity || "How would you describe your level of interest in sexual activity?",
                    feature: "Sexual Activity",
                    type: "sexualActivity",
                    questionId: "sexualActivity"
                }
            ];
            
            // Add options based on question type
            questions.forEach(question => {
                const answerValues = translations.answer_values || pdfTranslations.answer_values || {};
                
                switch(question.type) {
                    case 'yesNo':
                        question.options = [
                            { value: "NO", label: answerValues.yesNo?.NO || "No", score: 0 },
                            { value: "YES", label: answerValues.yesNo?.YES || "Yes", score: 1 }
                        ];
                        break;
                    case 'frequency':
                        question.options = [
                            { value: "Seldom", label: answerValues.frequency?.Seldom || "Seldom", score: 0 },
                            { value: "Sometimes", label: answerValues.frequency?.Sometimes || "Sometimes", score: 1 },
                            { value: "Usually", label: answerValues.frequency?.Usually || "Usually", score: 2 },
                            { value: "Most-Often", label: answerValues.frequency?.["Most-Often"] || "Most Often", score: 3 }
                        ];
                        break;
                    case 'concentration':
                        question.options = [
                            { value: "Cannot concentrate", label: answerValues.concentration?.["Cannot concentrate"] || "Cannot concentrate", score: 0 },
                            { value: "Poor concentration", label: answerValues.concentration?.["Poor concentration"] || "Poor concentration", score: 1 },
                            { value: "Average concentration", label: answerValues.concentration?.["Average concentration"] || "Average concentration", score: 2 },
                            { value: "Good concentration", label: answerValues.concentration?.["Good concentration"] || "Good concentration", score: 3 },
                            { value: "Excellent concentration", label: answerValues.concentration?.["Excellent concentration"] || "Excellent concentration", score: 4 }
                        ];
                        break;
                    case 'optimism':
                        question.options = [
                            { value: "Extremely pessimistic", label: answerValues.optimism?.["Extremely pessimistic"] || "Extremely pessimistic", score: 0 },
                            { value: "Pessimistic", label: answerValues.optimism?.Pessimistic || "Pessimistic", score: 1 },
                            { value: "Neutral outlook", label: answerValues.optimism?.["Neutral outlook"] || "Neutral outlook", score: 2 },
                            { value: "Optimistic", label: answerValues.optimism?.Optimistic || "Optimistic", score: 3 },
                            { value: "Extremely optimistic", label: answerValues.optimism?.["Extremely optimistic"] || "Extremely optimistic", score: 4 }
                        ];
                        break;
                    case 'sexualActivity':
                        question.options = [
                            { value: "No interest", label: answerValues.sexualActivity?.["No interest"] || "No interest", score: 0 },
                            { value: "Low interest", label: answerValues.sexualActivity?.["Low interest"] || "Low interest", score: 1 },
                            { value: "Moderate interest", label: answerValues.sexualActivity?.["Moderate interest"] || "Moderate interest", score: 2 },
                            { value: "High interest", label: answerValues.sexualActivity?.["High interest"] || "High interest", score: 3 },
                            { value: "Very high interest", label: answerValues.sexualActivity?.["Very high interest"] || "Very high interest", score: 4 }
                        ];
                        break;
                }
            });
            
            ASSESSMENT_CONFIG = { questions };
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        attachEventListeners() {
            // Welcome screen
            this.startBtn.addEventListener('click', () => this.startAssessment());
            this.viewHistoryBtn.addEventListener('click', () => this.showHistoryScreen());
            
            // Questions screen
            this.prevBtn.addEventListener('click', () => this.previousQuestion());
            this.nextBtn.addEventListener('click', () => this.nextQuestion());
            
            // Review screen
            this.backToQuestionsBtn.addEventListener('click', () => this.backToQuestions());
            this.submitFinalBtn.addEventListener('click', () => this.submitFinalAssessment());
            
            // Patient info inputs
            this.patientName.addEventListener('input', (e) => {
                this.patientInfo.name = SecurityUtils.sanitizeInput(e.target.value);
            });
            this.patientNumber.addEventListener('input', (e) => {
                this.patientInfo.number = SecurityUtils.sanitizeInput(e.target.value);
            });
            this.patientAge.addEventListener('input', (e) => {
                this.patientInfo.age = SecurityUtils.sanitizeInput(e.target.value);
            });
            this.patientGender.addEventListener('change', (e) => {
                this.patientInfo.gender = e.target.value;
            });
            
            // History screen
            this.loginBtn.addEventListener('click', () => this.handleLogin());
            this.logoutBtn.addEventListener('click', () => this.handleLogout());
            this.backToWelcomeFromLoginBtn.addEventListener('click', () => this.showScreen(this.welcomeScreen));
            this.backToWelcomeBtn.addEventListener('click', () => this.showScreen(this.welcomeScreen));
            
            // Language change listener
            document.addEventListener('languageChanged', async (e) => {
                if (e.detail && e.detail.language) {
                    await this.changeLanguage(e.detail.language);
                }
            });
        }
        
        attachKeyboardListeners() {
            document.addEventListener('keydown', (e) => {
                if (!this.questionsScreen.classList.contains('active')) return;
                
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        this.handleEnterKey();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.previousQuestion();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.nextQuestion();
                        break;
                    case 'Backspace':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            this.previousQuestion();
                        }
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                        e.preventDefault();
                        this.selectOptionByNumber(parseInt(e.key));
                        break;
                }
            });
        }
        
        attachMobileNavigationListeners() {
            const mobileAssessmentBtn = document.getElementById('mobileAssessmentBtn');
            if (mobileAssessmentBtn) {
                mobileAssessmentBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.startAssessment();
                    this.updateMobileNavActiveState('mobileAssessmentBtn');
                });
            }
            
            const mobileHistoryBtn = document.getElementById('mobileHistoryBtn');
            if (mobileHistoryBtn) {
                mobileHistoryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showHistoryScreen();
                    this.updateMobileNavActiveState('mobileHistoryBtn');
                });
            }
            
            const mobileHomeItems = document.querySelectorAll('.mobile-nav-item[data-screen="welcomeScreen"]');
            mobileHomeItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showScreen(this.welcomeScreen);
                    this.updateMobileNavActiveState('welcomeScreen');
                });
            });
        }
        
        // ============================================
        // ASSESSMENT FLOW METHODS
        // ============================================
        
        startAssessment() {
            if (!ASSESSMENT_CONFIG || !ASSESSMENT_CONFIG.questions) {
                this.showAlert('configError', 'Assessment is still loading. Please wait a moment and try again.');
                return;
            }
            
            this.assessmentStartTime = new Date().toISOString();
            
            this.showScreen(this.questionsScreen);
            this.updateProgress();
            this.displayCurrentQuestion();
            this.updateMobileNavActiveState('mobileAssessmentBtn');
            this.updateNextButtonText();
        }
        
        displayCurrentQuestion() {
            if (!ASSESSMENT_CONFIG || !ASSESSMENT_CONFIG.questions || 
                !ASSESSMENT_CONFIG.questions[this.currentQuestionIndex]) {
                return;
            }
            
            const question = ASSESSMENT_CONFIG.questions[this.currentQuestionIndex];
            
            this.questionCategory.textContent = question.category;
            this.questionText.textContent = question.question;
            this.renderOptions(question.options);
            this.updateNavigationButtons();
        }
        
        renderOptions(options) {
            this.optionsContainer.innerHTML = '';
            
            options.forEach((option, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.textContent = option.label;
                optionBtn.dataset.value = option.value;
                optionBtn.dataset.score = option.score;
                optionBtn.setAttribute('tabindex', '0');
                
                const numberIndicator = document.createElement('span');
                numberIndicator.className = 'keyboard-shortcut';
                numberIndicator.textContent = `${index + 1}`;
                optionBtn.prepend(numberIndicator);
                
                const currentQuestion = ASSESSMENT_CONFIG.questions[this.currentQuestionIndex];
                if (this.responses[currentQuestion.feature] === option.value) {
                    optionBtn.classList.add('selected');
                }
                
                optionBtn.addEventListener('click', () => this.selectOption(optionBtn, option));
                
                this.optionsContainer.appendChild(optionBtn);
            });
        }
        
        selectOption(optionBtn, option) {
            this.optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            optionBtn.classList.add('selected');
            
            const currentQuestion = ASSESSMENT_CONFIG.questions[this.currentQuestionIndex];
            this.responses[currentQuestion.feature] = option.value;
            
            this.nextBtn.disabled = false;
            
            const isLastQuestion = this.currentQuestionIndex === ASSESSMENT_CONFIG.questions.length - 1;
            if (isLastQuestion) {
                this.updateNextButtonText();
            }
            
            if (!isLastQuestion) {
                setTimeout(() => {
                    if (this.questionsScreen.classList.contains('active')) {
                        this.nextQuestion();
                    }
                }, 500);
            }
        }
        
        previousQuestion() {
            if (this.currentQuestionIndex > 0) {
                this.currentQuestionIndex--;
                this.updateProgress();
                this.displayCurrentQuestion();
                this.updateNextButtonText();
            }
        }
        
        nextQuestion() {
            if (!ASSESSMENT_CONFIG) {
                return;
            }
            
            const currentQuestion = ASSESSMENT_CONFIG.questions[this.currentQuestionIndex];
            
            if (!this.responses[currentQuestion.feature]) {
                this.showAlert('selectOption', 'Please select an option before continuing.');
                return;
            }

            if (this.currentQuestionIndex < ASSESSMENT_CONFIG.questions.length - 1) {
                this.currentQuestionIndex++;
                this.updateProgress();
                this.displayCurrentQuestion();
                this.updateNextButtonText();
            } else {
                this.showReviewScreen();
            }
        }
        
        showReviewScreen() {
            this.showScreen(this.reviewScreen);
            this.displayReviewResponses();
        }
        
        displayReviewResponses() {
            this.responsesList.innerHTML = '';
            
            const translations = this.displayManager.getTranslations();
            const editButtonText = translations.editButton || 'Edit';
            const answerLabel = translations.answerLabel || 'Answer:';
            
            if (!ASSESSMENT_CONFIG || !ASSESSMENT_CONFIG.questions) {
                return;
            }
            
            ASSESSMENT_CONFIG.questions.forEach((question, index) => {
                const responseItem = document.createElement('div');
                responseItem.className = 'response-item';
                
                const response = this.responses[question.feature];
                const translatedAnswer = this.displayManager.translateAnswerValue(response, question.type);
                
                responseItem.innerHTML = `
                    <div class="response-question">
                        <div class="response-category">${question.category}</div>
                        <div class="response-text">${question.question}</div>
                        <div class="response-answer"><strong>${answerLabel}</strong> ${translatedAnswer}</div>
                    </div>
                    <div class="response-actions">
                        <button class="edit-btn" onclick="window.mentalHealthAssessment.editResponse(${index})">
                            ${editButtonText}
                        </button>
                    </div>
                `;
                
                this.responsesList.appendChild(responseItem);
            });
        }
        
        editResponse(questionIndex) {
            this.currentQuestionIndex = questionIndex;
            this.showScreen(this.questionsScreen);
            this.updateProgress();
            this.displayCurrentQuestion();
        }
        
        backToQuestions() {
            this.currentQuestionIndex = ASSESSMENT_CONFIG.questions.length - 1;
            this.showScreen(this.questionsScreen);
            this.updateProgress();
            this.displayCurrentQuestion();
        }
        
        // ============================================
        // ASSESSMENT SUBMISSION (Display 1)
        // ============================================
        
        async submitFinalAssessment() {
            // Validate inputs with current language
            const ageValidation = SecurityUtils.validateAge(this.patientAge.value);
            if (!ageValidation.valid) {
                this.showAlert('ageError', ageValidation.message);
                return;
            }

            const nameValidation = SecurityUtils.validateName(this.patientName.value);
            if (!nameValidation.valid) {
                this.showAlert('nameError', nameValidation.message);
                return;
            }

            const numberValidation = SecurityUtils.validatePatientNumber(this.patientNumber.value);
            if (!numberValidation.valid) {
                this.showAlert('numberError', numberValidation.message);
                return;
            }

            this.showScreen(this.loadingScreen);
            this.isSubmitting = true;

            try {
                // Show loading animation
                await this.simulateProcessing();
                
                // Send assessment to backend with security headers
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                const response = await fetch(`${API_BASE_URL}/api/predict`, {
                    method: 'POST',
                    headers: {
                        ...SecurityUtils.generateSecureHeaders('POST'), 
                        'X-Client-Timezone': userTimezone 
                    },
                    body: JSON.stringify({
                        responses: this.responses,
                        patientInfo: this.patientInfo,
                        assessment_start_time: this.assessmentStartTime,
                        language: 'en'
                    })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        this.showAlert('csrfError', 'Security validation failed. Please refresh the page and try again.');
                        return;
                    }
                    
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const resultData = await response.json();
                resultData.patientInfo = this.patientInfo;
                
                if (this.assessmentStartTime && !resultData.assessment_timestamp) {
                    resultData.assessment_timestamp = this.assessmentStartTime;
                }
                
                // Display results using Display 1
                this.displayNewAssessmentResults(resultData);

            } catch (error) {
                this.showAlert('submitError', 'Failed to process assessment: ' + error.message);
            } finally {
                this.isSubmitting = false;
            }
        }
        
        displayNewAssessmentResults(resultData) {
            // Show results screen
            this.showScreen(this.resultsScreen);
            
            // Store assessment data
            this.currentAssessmentData = {
                ...resultData,
                patient_info: this.patientInfo,
                responses: this.responses,
                language: this.currentLanguage
            };
            
            // Display using Display 1
            const resultsHTML = this.displayManager.displayNewAssessmentResults(
                resultData, 
                this.patientInfo
            );
            
            // Insert into DOM
            const resultsContainer = document.querySelector('#resultsScreen .result-box');
            if (resultsContainer) {
                resultsContainer.innerHTML = resultsHTML;
            } else {
                const surveyCard = document.querySelector('.survey-card');
                if (surveyCard) {
                    surveyCard.innerHTML = resultsHTML;
                }
            }
            
            // Reattach event listeners for the new assessment results screen
            setTimeout(() => this.attachResultsScreenListeners(), 100);
        }
        
        attachResultsScreenListeners() {
            // Reattach listeners after DOM update
            const newAssessmentBtn = document.getElementById('newAssessmentBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const learnMoreBtn = document.getElementById('learnMoreBtn');
            const backToHistoryBtn = document.getElementById('backToHistoryBtn');
            const downloadHistoricalBtn = document.getElementById('downloadHistoricalBtn');
            
            if (newAssessmentBtn) {
                newAssessmentBtn.addEventListener('click', () => this.resetAssessment());
            }
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadReport();
                });
            }
            
            if (learnMoreBtn) {
                learnMoreBtn.addEventListener('click', () => {
                    // Get current language for the redirect
                    const currentLang = this.currentLanguage || localStorage.getItem('preferred-language') || 'en';
                    
                    // Get the diagnosis from current assessment data
                    const diagnosis = this.currentAssessmentData?.primary_diagnosis || '';
                    
                    // Get canonical diagnosis for URL parameter
                    const canonicalDiagnosis = this.displayManager.convertToCanonicalKey(diagnosis);
                    
                    // Build URL with diagnosis parameter and language
                    const url = `MenHel_analogy.html?diagnosis=${encodeURIComponent(canonicalDiagnosis)}&lang=${currentLang}`;
                    
                    // Redirect to Condition Visualizer
                    window.location.href = url;
                });
            }
            
            if (backToHistoryBtn) {
                backToHistoryBtn.addEventListener('click', () => this.showHistoryScreen());
            }
            
            if (downloadHistoricalBtn) {
                downloadHistoricalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.downloadReport();
                });
            }
        }
        
        // ============================================
        // HISTORICAL ASSESSMENTS (Display 2)
        // ============================================
        
        async handleLogin() {
            const name = SecurityUtils.sanitizeInput(this.loginPatientName.value);
            const number = SecurityUtils.sanitizeInput(this.loginPatientNumber.value);
            
            // Validate with current language
            const nameValidation = SecurityUtils.validateName(name);
            if (!nameValidation.valid) {
                this.showAlert('nameError', nameValidation.message);
                return;
            }

            const numberValidation = SecurityUtils.validatePatientNumber(number);
            if (!numberValidation.valid) {
                this.showAlert('numberError', numberValidation.message);
                return;
            }

            try {
                const translations = this.displayManager.getTranslations();
                const loadingText = translations.loading || 'Loading...';
                this.loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
                this.loginBtn.disabled = true;
                
                const response = await fetch(`${API_BASE_URL}/api/get-patient-assessments`, {
                    method: 'POST',
                    headers: SecurityUtils.generateSecureHeaders('POST'),
                    body: JSON.stringify({
                        name: name,
                        number: number,
                        language: 'en' // Always request English data from backend
                    })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        this.showAlert('csrfError', 'Security validation failed. Please refresh the page and try again.');
                        return;
                    }
                    
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success || !result.assessments || result.assessments.length === 0) {
                    this.showAlert('noHistoryFound', 'No assessment history found for the provided name and patient number.');
                    return;
                }

                this.currentPatient = { name, number };
                this.showPatientHistory(result.assessments);

            } catch (error) {
                this.showAlert('loginError', 'Error accessing assessment history. Please try again.');
            } finally {
                const translations = this.displayManager.getTranslations();
                const accessText = translations['navigation.login-access'] || 'Access History';
                this.loginBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> ${accessText}`;
                this.loginBtn.disabled = false;
            }
        }
        
        showPatientHistory(assessments) {
            const translations = this.displayManager.getTranslations();
            const welcomeText = (translations['welcome-patient'] || 'Welcome, {name}').replace('{name}', this.currentPatient.name);
            
            const welcomePatientElement = document.getElementById('welcome-patient');
            if (welcomePatientElement) {
                welcomePatientElement.textContent = welcomeText;
            }
            
            this.loggedInPatientNumber.textContent = this.currentPatient.number;
            
            this.loginSection.style.display = 'none';
            this.patientHistorySection.style.display = 'block';
            
            this.displayPatientHistoryList(assessments);
        }
        
        displayPatientHistoryList(assessments) {
            const translations = this.displayManager.getTranslations();
            const pdfTranslations = window.i18n?.translations[this.currentLanguage]?.pdf_report || {};
            
            this.patientHistoryList.innerHTML = '';
            
            if (!assessments || assessments.length === 0) {
                this.patientHistoryList.innerHTML = `
                    <div class="no-history">
                        <p>No assessment history found.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            assessments.sort((a, b) => {
                const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                return dateB - dateA;
            });
            
            const startedLabel = translations.history?.['started-label'] || 'Started:';
            const submittedLabel = translations.history?.['submitted-label'] || 'Submitted:';
            const confidenceLabel = translations.history?.['confidence-label'] || 'Confidence:';
            const assessmentIdLabel = translations.assessment?.['id-label'] || 'Assessment ID:';
            const viewText = translations.history?.['view-button'] || 'View';
            const downloadText = translations.history?.['download-button'] || 'Download';
            const deleteText = translations.history?.['delete-button'] || 'Delete';
            
            const diagnosisTranslations = translations.diagnosisTranslations || 
                                       pdfTranslations.diagnosisTranslations || {};
            
            assessments.forEach((assessment) => {
                let primaryDiagnosis = assessment.primary_diagnosis || 'No diagnosis';
                let confidencePercentage = assessment.confidence_percentage || 
                                        (assessment.confidence ? Math.round(assessment.confidence * 100) : 0);
                
                if ((!primaryDiagnosis || primaryDiagnosis === '') && 
                    assessment.all_diagnoses && assessment.all_diagnoses.length > 0) {
                    primaryDiagnosis = assessment.all_diagnoses[0].diagnosis || 'No diagnosis';
                    confidencePercentage = assessment.all_diagnoses[0].confidence_percentage || 0;
                }
                
                const canonicalKey = this.displayManager.convertToCanonicalKey(primaryDiagnosis);
                const translatedDiagnosis = diagnosisTranslations[canonicalKey] || primaryDiagnosis;
                
                const diagnosisClass = canonicalKey 
                    ? canonicalKey.toLowerCase().replace(/\s+/g, '-')
                    : 'unknown';
                
                const formatDateTimeSafely = (dateString) => {
                    if (!dateString || dateString === 'N/A') return 'Unknown';
                    try {
                        const date = new Date(dateString);
                        return this.displayManager.formatDateForLocale(dateString);
                    } catch (error) {
                        return 'Unknown';
                    }
                };
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-header">
                        <div class="history-patient">
                            <strong>${assessmentIdLabel} ${assessment.id || 'Unknown'}</strong>
                            <span class="history-id">${startedLabel} ${formatDateTimeSafely(assessment.assessment_timestamp)}</span>
                            <span class="history-id">${submittedLabel} ${formatDateTimeSafely(assessment.timestamp)}</span>
                        </div>
                        <div class="history-diagnosis ${diagnosisClass}">
                            ${translatedDiagnosis}
                            <span class="history-confidence">${confidenceLabel} ${confidencePercentage}%</span>
                        </div>
                    </div>
                    <div class="history-details">
                        <div></div>
                        <div class="history-actions">
                            <button class="btn-view" data-assessment-id="${assessment.id}">
                                <i class="fas fa-eye"></i> ${viewText}
                            </button>
                            <button class="btn-download" data-assessment-id="${assessment.id}">
                                <i class="fas fa-download"></i> ${downloadText}
                            </button>
                            <button class="btn-delete" data-assessment-id="${assessment.id}">
                                <i class="fas fa-trash"></i> ${deleteText}
                            </button>
                        </div>
                    </div>
                `;
                
                const viewBtn = historyItem.querySelector('.btn-view');
                const downloadBtn = historyItem.querySelector('.btn-download');
                const deleteBtn = historyItem.querySelector('.btn-delete');
                
                viewBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.viewHistoricalAssessment(assessment.id, e);
                });
                
                downloadBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const originalHTML = downloadBtn.innerHTML;
                    const originalDisabled = downloadBtn.disabled;
                    
                    const translations = this.displayManager.getTranslations();
                    const generatingText = translations.generatingPDF || 'Generating PDF...';
                    downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${generatingText}`;
                    downloadBtn.disabled = true;
                    
                    try {
                        await this.downloadHistoricalAssessment(assessment.id);
                    } finally {
                        const downloadText = translations.history?.['download-button'] || 'Download';
                        downloadBtn.innerHTML = `<i class="fas fa-download"></i> ${downloadText}`;
                        downloadBtn.disabled = false;
                    }
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.deletePatientAssessment(assessment.id, e);
                });
                
                this.patientHistoryList.appendChild(historyItem);
            });
        }
        
        async viewHistoricalAssessment(assessmentId, event = null) {
            try {
                if (!this.currentPatient) {
                    this.showAlert('noPatientLoggedIn', 'No patient logged in.');
                    return;
                }

                let viewBtn;
                if (event) {
                    viewBtn = event.target.closest('.btn-view');
                } else {
                    viewBtn = document.querySelector(`.btn-view[data-assessment-id="${assessmentId}"]`);
                }
                
                if (viewBtn) {
                    const translations = this.displayManager.getTranslations();
                    const loadingText = translations.loading || 'Loading...';
                    const originalText = viewBtn.innerHTML;
                    viewBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
                    viewBtn.disabled = true;
                }

                // Load assessment from backend
                const response = await fetch(`${API_BASE_URL}/api/get-single-assessment`, {
                    method: 'POST',
                    headers: SecurityUtils.generateSecureHeaders('POST'),
                    body: JSON.stringify({
                        name: this.currentPatient.name,
                        number: this.currentPatient.number,
                        assessment_id: assessmentId
                    })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        this.showAlert('csrfError', 'Security validation failed. Please refresh the page and try again.');
                        return;
                    }
                    
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success || !result.assessment) {
                    this.showAlert('assessmentNotFound', 'Assessment not found. Please try reloading your history.');
                    return;
                }

                const assessmentData = result.assessment;
                
                // Display using Display 2
                this.displayHistoricalAssessment(assessmentData);

            } catch (error) {
                this.showAlert('loadError', 'Error loading assessment. Please try again.');
            } finally {
                const translations = this.displayManager.getTranslations();
                const viewText = translations.history?.['view-button'] || 'View';
                const viewBtns = document.querySelectorAll('.btn-view');
                viewBtns.forEach(btn => {
                    btn.innerHTML = `<i class="fas fa-eye"></i> ${viewText}`;
                    btn.disabled = false;
                });
            }
        }
        
        displayHistoricalAssessment(assessmentData) {
            // Show results screen
            this.showScreen(this.resultsScreen);
            
            // Store as current assessment data
            this.currentAssessmentData = assessmentData;
            
            // Display using Display 2
            const historicalHTML = this.displayManager.displayHistoricalAssessment(assessmentData);
            
            // Insert into DOM
            const resultsContainer = document.querySelector('#resultsScreen .result-box');
            if (resultsContainer) {
                resultsContainer.innerHTML = historicalHTML;
            } else {
                const surveyCard = document.querySelector('.survey-card');
                if (surveyCard) {
                    surveyCard.innerHTML = historicalHTML;
                }
            }
            
            // Reattach event listeners for historical view
            setTimeout(() => this.attachResultsScreenListeners(), 100);
        }
        
        // ============================================
        // BACKEND INTEGRATION METHODS
        // ============================================
        
        async deletePatientAssessment(assessmentId, event = null) {
            if (!this.currentPatient) {
                this.showAlert('noPatientLoggedIn', 'No patient logged in.');
                return;
            }

            const translations = this.displayManager.getTranslations();
            const confirmMessage = translations.errors?.deleteConfirm || 'Are you sure you want to delete this assessment? This action cannot be undone.';
            
            if (confirm(confirmMessage)) {
                try {
                    let deleteBtn;
                    if (event) {
                        deleteBtn = event.target.closest('.btn-delete');
                        if (deleteBtn) {
                            const loadingText = translations.loading || 'Loading...';
                            deleteBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
                            deleteBtn.disabled = true;
                        }
                    }

                    const response = await fetch(`${API_BASE_URL}/api/delete-assessment`, {
                        method: 'POST',
                        headers: SecurityUtils.generateSecureHeaders('POST'),
                        body: JSON.stringify({
                            patient_number: this.currentPatient.number,
                            assessment_id: assessmentId
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 403) {
                            this.showAlert('csrfError', 'Security validation failed. Please refresh the page and try again.');
                            return;
                        }
                        
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success) {
                        // Reload history
                        await this.handleLogin();
                    } else {
                        this.showAlert('deleteError', result.error || 'Failed to delete assessment.');
                    }
                    
                } catch (error) {
                    this.showAlert('deleteError', 'Error deleting assessment. Please try again.');
                }
            }
        }
        
        // ============================================
        // UTILITY METHODS
        // ============================================
        
        showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');

            if (screen === this.welcomeScreen) {
                this.updateMobileNavActiveState('welcomeScreen');
            } else if (screen === this.questionsScreen) {
                this.updateMobileNavActiveState('mobileAssessmentBtn');
            } else if (screen === this.historyScreen) {
                this.updateMobileNavActiveState('mobileHistoryBtn');
            } else if (screen === this.resultsScreen) {
                this.updateMobileNavActiveState('mobileAssessmentBtn');
            }
        }
        
        updateProgress() {
            if (!ASSESSMENT_CONFIG || !ASSESSMENT_CONFIG.questions) return;
            
            const progress = ((this.currentQuestionIndex + 1) / ASSESSMENT_CONFIG.questions.length) * 100;
            this.progressFill.style.width = `${progress}%`;
            
            const translations = this.displayManager.getTranslations();
            const progressText = (translations.questionOf || 'Question {current} of {total}')
                .replace('{current}', this.currentQuestionIndex + 1)
                .replace('{total}', ASSESSMENT_CONFIG.questions.length);
            this.progressText.textContent = progressText;
        }
        
        updateNavigationButtons() {
            this.prevBtn.disabled = this.currentQuestionIndex === 0;
            
            const currentQuestion = ASSESSMENT_CONFIG.questions[this.currentQuestionIndex];
            const hasResponse = this.responses[currentQuestion.feature] !== undefined;
            this.nextBtn.disabled = !hasResponse;
            
            this.updateNextButtonText();
        }
        
        updateNextButtonText() {
            if (!this.nextBtn || !ASSESSMENT_CONFIG || !ASSESSMENT_CONFIG.questions) return;
            
            const translations = this.displayManager.getTranslations();
            const navTranslations = translations.navigation || {};
            const nextButtonSpan = this.nextBtn.querySelector('span');
            
            if (nextButtonSpan) {
                if (this.currentQuestionIndex === ASSESSMENT_CONFIG.questions.length - 1) {
                    nextButtonSpan.textContent = navTranslations['review-button'] || 'Review Answers';
                } else {
                    nextButtonSpan.textContent = navTranslations['next-button'] || 'Next â†’';
                }
            }
        }
                
        updateAllTexts() {
            const translations = this.displayManager.getTranslations();
            
            // Get navigation translations (they're nested under 'navigation')
            const navTranslations = translations.navigation || {};
            
            // Get validation translations
            const validationTranslations = translations.validation || {};
            const nameValidation = validationTranslations.name || {};
            const ageValidation = validationTranslations.age || {};
            const patientNumberValidation = validationTranslations.patient_number || {};
            
            // Update all text elements using the translations
            const textElements = [
                ['hero-title', translations['hero-title'] || 'Mental Health Self-Assessment'],
                ['hero-description', translations['hero-description'] || 'Take a secure assessment...'],
                ['feature-secure', translations['feature-secure'] || 'Secure & Private'],
                ['feature-clinical', translations['feature-clinical'] || 'Clinically Based'],
                ['feature-insights', translations['feature-insights'] || 'Personalized Insights'],
                
                ['welcome-title', translations['welcome-title'] || 'Welcome to Assessment'],
                ['welcome-description', translations['welcome-description'] || 'This comprehensive assessment...'],
                ['feature-confidential', translations['feature-confidential'] || 'Completely Confidential'],
                ['feature-time', translations['feature-time'] || '10-15 Minute Assessment'],
                ['feature-evidence', translations['feature-evidence'] || 'Evidence-Based Analysis'],
                ['feature-personalized', translations['feature-personalized'] || 'Personalized Insights'],
                ['start-button-text', translations['start-button-text'] || 'Start New Assessment'],
                ['view-history-button-text', translations['view-history-button-text'] || 'View Assessment History'],
                ['important-note-title', translations['important-note-title'] || 'Important Note:'],
                ['important-note-text', translations['important-note-text'] || 'This assessment is for informational purposes...'],
                
                // NAVIGATION BUTTONS - using navTranslations object
                ['previous-button-text', navTranslations['previous-button'] || 'â† Previous'],
                ['next-button-text', navTranslations['next-button'] || 'Next â†’'],
                ['back-to-questions', navTranslations['back-to-questions'] || 'â† Back to questions'],
                ['submit-assessment-button', navTranslations['submit-assessment-button'] || 'Submit Assessment âœ“'],
                ['new-assessment-button', navTranslations['new-assessment'] || 'â†» New Assessment'],
                ['learn-more-button', navTranslations['learn-more'] || 'Learn more about your condition'],
                ['download-button', navTranslations['download-report'] || 'Download Report'],
                ['login-back-button', navTranslations['login-back'] || 'â† Back'],
                ['login-access-button', navTranslations['login-access'] || 'Access History'],
                ['logout-button', navTranslations['logout'] || 'Logout'],
                ['history-back-button', navTranslations['history-back'] || 'Back to Welcome Screen'],
                
                ['review-title', translations['review-title'] || 'Review Your Answers'],
                ['review-description', translations['review-description'] || 'Please review your answers...'],
                ['patient-info-title', translations['patient-info-title'] || 'Patient Information'],
                ['patient-name-label', nameValidation.label || 'Patient Name:'],
                ['patient-number-label', patientNumberValidation.label || 'Patient Number:'],
                ['patient-age-label', ageValidation.label || 'Age:'],
                ['patient-gender-label', translations['patient-gender-label'] || 'Gender:'],
                ['gender-default', translations['patient-gender-default'] || 'Select Gender'],
                ['gender-male', translations['patient-gender-male'] || 'Male'],
                ['gender-female', translations['patient-gender-female'] || 'Female'],
                ['gender-other', translations['patient-gender-other'] || 'Other'],
                ['gender-prefer-not', translations['patient-gender-prefer-not'] || 'Prefer not to disclose'],
                ['review-note-title', translations['review-note-title'] || 'ðŸ“ Important:'],
                ['review-note-text', translations['review-note-text'] || 'To save your assessment...'],
                ['responses-title', translations['responses-title'] || 'Your Responses'],
                
                ['results-complete', translations['results-complete'] || 'Assessment Complete'],
                ['primary-result-title', translations['primary-result-title'] || 'Primary Assessment Result'],
                ['other-diagnoses-title', translations['other-diagnoses-title'] || 'Other Possible Diagnoses'],
                ['questions-answers-title', translations['questions-answers-title'] || 'Assessment Questions & Answers'],
                ['disclaimer-title', translations['disclaimer-title'] || 'Important Disclaimer:'],
                ['disclaimer-text', translations['disclaimer-text'] || 'This assessment is for informational purposes...'],
                
                ['history-title', translations['history-title'] || 'Assessment History'],
                ['history-description', translations['history-description'] || 'View and manage your previous assessments'],
                ['access-history-title', translations['access-history-title'] || 'Access Your Assessment History'],
                ['login-name-label', nameValidation.label || 'Patient Name:'],
                ['login-number-label', patientNumberValidation.label || 'Patient Number:'],
                
                ['mobile-home', translations['mobile.home'] || 'Home'],
                ['mobile-assessment', translations['mobile.assessment'] || 'Assessment'],
                ['mobile-history', translations['mobile.history'] || 'History']
            ];
            
            textElements.forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = text;
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = text;
                    } else {
                        element.textContent = text;
                    }
                }
            });
            
            // ============================================
            // UPDATE VALIDATION MESSAGES AND INPUT ATTRIBUTES
            // ============================================
            
            // Update patient form inputs
            const patientNameInput = document.getElementById('patientName');
            if (patientNameInput) {
                patientNameInput.placeholder = nameValidation.placeholder || 'Enter patient name';
                patientNameInput.title = nameValidation.title || 'Enter patient name (2-50 characters)';
            }
            
            const patientNameHint = document.getElementById('patient-name-hint');
            if (patientNameHint) {
                patientNameHint.textContent = nameValidation.hint || 'Enter patient name (2-50 characters)';
            }
            
            const patientNumberInput = document.getElementById('patientNumber');
            if (patientNumberInput) {
                patientNumberInput.placeholder = patientNumberValidation.placeholder || 'Enter patient number';
                patientNumberInput.title = patientNumberValidation.title || '6-20 characters with at least one uppercase letter, one lowercase letter, and one number';
            }
            
            const patientNumberHint = document.getElementById('patient-number-hint');
            if (patientNumberHint) {
                patientNumberHint.textContent = patientNumberValidation.hint || '6-20 characters with uppercase, lowercase, and numbers';
            }
            
            const patientAgeInput = document.getElementById('patientAge');
            if (patientAgeInput) {
                patientAgeInput.placeholder = ageValidation.placeholder || 'Enter age (12-100)';
                patientAgeInput.title = ageValidation.title || 'Enter a number between 12 and 100';
            }
            
            const patientAgeHint = document.getElementById('patient-age-hint');
            if (patientAgeHint) {
                patientAgeHint.textContent = ageValidation.hint || 'Enter age between 12-100';
            }
            
            // Update login form inputs
            const loginPatientNameInput = document.getElementById('loginPatientName');
            if (loginPatientNameInput) {
                loginPatientNameInput.placeholder = nameValidation.placeholder || 'Enter patient name';
                loginPatientNameInput.title = nameValidation.title || 'Enter patient name (2-50 characters)';
            }
            
            const loginPatientNumberInput = document.getElementById('loginPatientNumber');
            if (loginPatientNumberInput) {
                loginPatientNumberInput.placeholder = patientNumberValidation.placeholder || 'Enter patient number';
                loginPatientNumberInput.title = patientNumberValidation.title || '6-20 characters with at least one uppercase letter, one lowercase letter, and one number';
            }
            
            const loginNumberHint = document.getElementById('login-number-hint');
            if (loginNumberHint) {
                loginNumberHint.textContent = patientNumberValidation.hint || '6-20 characters with uppercase, lowercase, and numbers';
            }
        }   

        async changeLanguage(newLanguage) {
            const oldLanguage = this.currentLanguage;
            this.currentLanguage = newLanguage;
            this.displayManager.setLanguage(newLanguage);
            
            // Update all texts
            this.updateAllTexts();
            this.initializeAssessmentConfig();
            
            // Update current screen
            const activeScreen = this.getActiveScreen();
            
            switch(activeScreen) {
                case 'questionsScreen':
                    this.displayCurrentQuestion();
                    this.updateNavigationButtons();
                    this.updateNextButtonText();
                    break;
                    
                case 'reviewScreen':
                    this.displayReviewResponses();
                    break;
                    
                case 'resultsScreen':
                    if (this.currentAssessmentData) {
                        // Redisplay current results with new language
                        if (this.currentPatient) {
                            // Historical view
                            this.displayHistoricalAssessment(this.currentAssessmentData);
                        } else {
                            // New assessment view
                            this.displayNewAssessmentResults(this.currentAssessmentData);
                        }
                    }
                    break;
                    
                case 'historyScreen':
                    if (this.currentPatient) {
                        // Reload history with new language
                        await this.handleLogin();
                    }
                    break;
            }
        }
        
        getActiveScreen() {
            if (this.questionsScreen.classList.contains('active')) return 'questionsScreen';
            if (this.reviewScreen.classList.contains('active')) return 'reviewScreen';
            if (this.resultsScreen.classList.contains('active')) return 'resultsScreen';
            if (this.historyScreen.classList.contains('active')) return 'historyScreen';
            return 'welcomeScreen';
        }
        
        async simulateProcessing() {
            const steps = document.querySelectorAll('.loading-step');
            
            for (let i = 0; i < steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 800));
                steps[i].classList.add('active');
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        handleEnterKey() {
            const currentQuestion = ASSESSMENT_CONFIG.questions[this.currentQuestionIndex];
            
            if (this.responses[currentQuestion.feature]) {
                this.nextQuestion();
            } else {
                const firstOption = this.optionsContainer.querySelector('.option-btn');
                if (firstOption) {
                    firstOption.focus();
                }
            }
        }
        
        selectOptionByNumber(number) {
            const options = this.optionsContainer.querySelectorAll('.option-btn');
            if (options[number - 1]) {
                const option = options[number - 1];
                const optionData = {
                    value: option.dataset.value,
                    score: option.dataset.score
                };
                this.selectOption(option, optionData);
            }
        }
        
        updateMobileNavActiveState(activeItem) {
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (activeItem === 'welcomeScreen') {
                const homeItem = document.querySelector('.mobile-nav-item[data-screen="welcomeScreen"]');
                if (homeItem) homeItem.classList.add('active');
            } else if (activeItem === 'mobileAssessmentBtn') {
                const assessmentItem = document.getElementById('mobileAssessmentBtn');
                if (assessmentItem) assessmentItem.classList.add('active');
            } else if (activeItem === 'mobileHistoryBtn') {
                const historyItem = document.getElementById('mobileHistoryBtn');
                if (historyItem) historyItem.classList.add('active');
            }
        }
        
        showHistoryScreen() {
            this.showScreen(this.historyScreen);
            this.updateMobileNavActiveState('mobileHistoryBtn');
            
            this.currentPatient = null;
            this.loginSection.style.display = 'block';
            this.patientHistorySection.style.display = 'none';
            this.patientHistoryList.innerHTML = '';
            this.loginPatientName.value = '';
            this.loginPatientNumber.value = '';
        }
        
        handleLogout() {
            this.currentPatient = null;
            this.assessmentHistory = [];
            this.loginSection.style.display = 'block';
            this.patientHistorySection.style.display = 'none';
            this.loginPatientName.value = '';
            this.loginPatientNumber.value = '';
        }
        
        resetAssessment() {
            this.currentQuestionIndex = 0;
            this.responses = {};
            this.isSubmitting = false;
            this.patientInfo = { name: '', number: '', age: '', gender: '' };
            this.currentAssessmentData = null;
            
            this.patientName.value = '';
            this.patientNumber.value = '';
            this.patientAge.value = '';
            this.patientGender.value = '';
            
            this.showScreen(this.welcomeScreen);
            this.updateProgress();
        }
        
        setupAgeValidation() {
            const ageInput = document.getElementById('patientAge');
            const loginAgeInput = document.getElementById('loginPatientAge'); // if exists
            
            const setupValidation = (inputElement) => {
                if (!inputElement) return;
                
                // Helper function to validate and show error
                const validateAndShowError = () => {
                    const validation = SecurityUtils.validateAge(inputElement.value);
                    if (!validation.valid) {
                        this.showInputError(inputElement, validation.message);
                    } else {
                        this.clearInputError(inputElement);
                    }
                };
                
                // Validate on keypress (for non-numeric characters)
                inputElement.addEventListener('keypress', (e) => {
                    const charCode = e.charCode || e.keyCode || e.which;
                    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                        e.preventDefault();
                        // Get translation dynamically
                        const currentLang = window.i18n?.currentLang || 'en';
                        const translations = window.i18n?.translations[currentLang]?.prediction?.validation?.age || {};
                        const errorMsg = translations.not_number || 'Please enter numbers only (0-9)';
                        this.showInputError(inputElement, errorMsg);
                        return false;
                    }
                    // Clear any previous error when valid character is typed
                    this.clearInputError(inputElement);
                });
                
                // Validate on input (as user types)
                inputElement.addEventListener('input', (e) => {
                    this.clearInputError(inputElement);
                    // Real-time validation as they type
                    validateAndShowError();
                });
                
                // Validate on blur (when focus leaves)
                inputElement.addEventListener('blur', () => {
                    validateAndShowError();
                });
                
                // Validate when language changes
                const validateOnLanguageChange = () => {
                    if (inputElement.value.trim() !== '') {
                        validateAndShowError();
                    }
                };
                
                // Listen for language changes
                document.addEventListener('languageChanged', validateOnLanguageChange);
                
                // Clean up listener when input is removed (optional)
                inputElement.addEventListener('DOMNodeRemoved', () => {
                    document.removeEventListener('languageChanged', validateOnLanguageChange);
                });
            };
            
            setupValidation(ageInput);
            if (loginAgeInput) setupValidation(loginAgeInput);
        }

        setupPatientNumberValidation() {
            const numberInput = document.getElementById('patientNumber');
            const loginNumberInput = document.getElementById('loginPatientNumber');
            
            const setupValidation = (inputElement) => {
                if (!inputElement) return;
                
                // Helper function to validate and show error
                const validateAndShowError = () => {
                    const value = inputElement.value.trim();
                    if (value !== '') {
                        const validation = SecurityUtils.validatePatientNumber(value);
                        if (!validation.valid) {
                            this.showInputError(inputElement, validation.message);
                        } else {
                            this.clearInputError(inputElement);
                        }
                    } else {
                        this.clearInputError(inputElement);
                    }
                };
                
                // Validate on keypress (for special characters)
                inputElement.addEventListener('keypress', (e) => {
                    const charCode = e.charCode || e.keyCode || e.which;
                    
                    const isValidChar = 
                        (charCode >= 65 && charCode <= 90) ||   // A-Z
                        (charCode >= 97 && charCode <= 122) ||  // a-z
                        (charCode >= 48 && charCode <= 57);     // 0-9
                        
                    if (!isValidChar) {
                        e.preventDefault();
                        // Get translation dynamically
                        const currentLang = window.i18n?.currentLang || 'en';
                        const translations = window.i18n?.translations[currentLang]?.prediction?.validation?.patient_number || {};
                        const errorMsg = translations.special_chars || 'Only letters and numbers allowed (no special characters)';
                        this.showInputError(inputElement, errorMsg);
                        return false;
                    }
                    // Clear any previous error when valid character is typed
                    this.clearInputError(inputElement);
                });
                
                // Validate on input (as user types)
                inputElement.addEventListener('input', (e) => {
                    this.clearInputError(inputElement);
                    // Real-time validation as they type
                    validateAndShowError();
                });
                
                // Validate on blur (when focus leaves)
                inputElement.addEventListener('blur', () => {
                    validateAndShowError();
                });
                
                // Validate when language changes
                const validateOnLanguageChange = () => {
                    if (inputElement.value.trim() !== '') {
                        validateAndShowError();
                    }
                };
                
                // Listen for language changes
                document.addEventListener('languageChanged', validateOnLanguageChange);
                
                // Clean up listener when input is removed (optional)
                inputElement.addEventListener('DOMNodeRemoved', () => {
                    document.removeEventListener('languageChanged', validateOnLanguageChange);
                });
            };
            
            setupValidation(numberInput);
            setupValidation(loginNumberInput);
        }
        
        setupNameValidation() {
            const nameInput = document.getElementById('patientName');
            const loginNameInput = document.getElementById('loginPatientName');
            
            const setupValidation = (inputElement) => {
                if (!inputElement) return;
                
                // Helper function to validate and show error
                const validateAndShowError = () => {
                    const validation = SecurityUtils.validateName(inputElement.value);
                    if (!validation.valid) {
                        this.showInputError(inputElement, validation.message);
                    } else {
                        this.clearInputError(inputElement);
                    }
                };
                
                // Validate on input (as user types)
                inputElement.addEventListener('input', (e) => {
                    this.clearInputError(inputElement);
                    // Validate after a short delay to avoid validation on every keystroke
                    setTimeout(() => {
                        validateAndShowError();
                    }, 300);
                });
                
                // Validate on blur (when focus leaves)
                inputElement.addEventListener('blur', () => {
                    validateAndShowError();
                });
                
                // Validate when language changes
                const validateOnLanguageChange = () => {
                    if (inputElement.value.trim() !== '') {
                        validateAndShowError();
                    }
                };
                
                // Listen for language changes
                document.addEventListener('languageChanged', validateOnLanguageChange);
                
                // Clean up listener when input is removed (optional)
                inputElement.addEventListener('DOMNodeRemoved', () => {
                    document.removeEventListener('languageChanged', validateOnLanguageChange);
                });
            };
            
            setupValidation(nameInput);
            setupValidation(loginNameInput);
        }

        showInputError(inputElement, message) {
            this.clearInputError(inputElement);
            
            inputElement.classList.add('input-error');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'input-error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            
            inputElement.parentNode.appendChild(errorDiv);
            inputElement.focus();
        }
        
        clearInputError(inputElement) {
            inputElement.classList.remove('input-error');
            
            const parent = inputElement.parentNode;
            const errorMsg = parent.querySelector('.input-error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }
        
        showAlert(alertKey, defaultMessage) {
            const translations = this.displayManager.getTranslations();
            const alerts = translations.errors || translations.alerts || {};
            const message = alerts[alertKey] || defaultMessage;
            
            // Create a nice alert modal instead of default alert
            this.createModalAlert(message);
        }
        
        createModalAlert(message) {
            // Remove existing alert if any
            const existingAlert = document.querySelector('.custom-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'custom-alert';
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-message">${message}</div>
                    <button class="alert-close">&times;</button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Show alert
            setTimeout(() => alertDiv.classList.add('show'), 10);
            
            // Close on button click
            const closeBtn = alertDiv.querySelector('.alert-close');
            closeBtn.addEventListener('click', () => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            });
            
            // Auto close after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 5000);
        }
        
        async downloadReport() {
            try {
                if (!this.currentAssessmentData) {
                    this.showAlert('noDataForDownload', 'No assessment data available for download. Please complete an assessment first.');
                    return;
                }
                
                const translations = this.displayManager.getTranslations();
                const generatingText = translations.generatingPDF || 'Generating PDF...';
                
                // Update button text for either download button
                const downloadBtn = document.getElementById('downloadBtn') || 
                                  document.getElementById('downloadHistoricalBtn');
                
                if (downloadBtn) {
                    const originalHTML = downloadBtn.innerHTML;
                    downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${generatingText}`;
                    downloadBtn.disabled = true;
                    
                    setTimeout(() => {
                        const navTranslations = translations.navigation || {};
                        downloadBtn.innerHTML = `<i class="fas fa-download"></i> ${navTranslations['download-report'] || 'Download Report'}`;
                        downloadBtn.disabled = false;
                    }, 2000);
                }
                
                // Generate PDF report
                await this.generatePDFReport(this.currentAssessmentData);
                
            } catch (error) {
                this.showAlert('pdfError', 'Failed to generate PDF report');
                
                // Reset button if error occurs
                const downloadBtn = document.getElementById('downloadBtn') || 
                                  document.getElementById('downloadHistoricalBtn');
                if (downloadBtn) {
                    const translations = this.displayManager.getTranslations();
                    const navTranslations = translations.navigation || {};
                    downloadBtn.innerHTML = `<i class="fas fa-download"></i> ${navTranslations['download-report'] || 'Download Report'}`;
                    downloadBtn.disabled = false;
                }
            }
        }

        async generatePDFReport(assessment) {
            try {
                // Language-based filename translations
                const filenameMap = {
                    en: "Mental_Health_Report",
                    es: "Informe_de_Salud_Mental",
                    fr: "Rapport_de_SantÃ©_Mentale",
                    de: "Bericht_Ã¼ber_die_psychische_Gesundheit",
                    vi: "Bao_cao_Suc_khoe_Tinh_than",
                    zh: "å¿ƒç†å¥åº·æŠ¥å‘Š",
                    ja: "ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ",
                    ko: "ì •ì‹ ê±´ê°•ë³´ê³ ì„œ"
                };

                const reportTitle = filenameMap[this.currentLanguage] || filenameMap["en"];
                const headers = SecurityUtils.generateSecureHeaders('POST');
                headers['X-Language'] = this.currentLanguage;

                const response = await fetch(`${API_BASE_URL}/api/generate-pdf-report`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        assessment_data: assessment,
                        language: this.currentLanguage
                    })
                });


                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Security validation failed');
                    }
                    throw new Error(`Server error: ${response.status}`);
                }

                const pdfBlob = await response.blob();
                const url = window.URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;

                const timestamp = new Date().toISOString().split('T')[0];
                const patientName = assessment.patient_info?.name?.replace(/\s+/g, '_') || 'patient';

                // Final filename with translated prefix
                const filename = `${reportTitle}_${patientName}_${timestamp}_${this.currentLanguage}.pdf`;

                a.download = filename;
                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);

            } catch (error) {
                throw error;
            }
        }

        async downloadHistoricalAssessment(assessmentId) {
            try {
                if (!this.currentPatient) {
                    this.showAlert('noPatientLoggedIn', 'No patient logged in.');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/get-single-assessment`, {
                    method: 'POST',
                    headers: SecurityUtils.generateSecureHeaders('POST'),
                    body: JSON.stringify({
                        name: this.currentPatient.name,
                        number: this.currentPatient.number,
                        assessment_id: assessmentId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.assessment) {
                    const assessment = result.assessment;
                    assessment.language = this.currentLanguage;
                    await this.generatePDFReport(assessment);
                } else {
                    this.showAlert('assessmentNotFound', 'Assessment not found. Please try reloading your history.');
                }

            } catch (error) {
                this.showAlert('downloadError', 'Error downloading assessment. Please try again.');
            }
        }
    }

    // ============================================
    // INITIALIZE APPLICATION
    // ============================================
    
    window.mentalHealthAssessment = new MentalHealthAssessment();
}
</script>

</body>
</html>