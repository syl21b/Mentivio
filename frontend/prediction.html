<!DOCTYPE html>
<html lang="en">
<head>
  <title id="page-title"></title>
    <!-- Add base tag to ensure all relative URLs work correctly -->
    <base href="/">
    
    <!-- Load scripts in correct order -->
    <script src="frontend/js/components.js" defer></script>
    <script src="frontend/js/load-navbar.js" defer></script>
    <script src="frontend/js/load-footer.js" defer></script>
    <script src="frontend/js/main.js" defer></script>
 <script src="../frontend/js/head-content.js" defer></script>
 
  <style>/* Consolidated CSS - matched to Home.html color scheme */
:root {
  --primary: #4a6fa5;    /* Calming blue - matches Home.html */
  --primary-light: #88a4c7;
  --primary-dark: #3a5a80;
  --secondary: #7ba05b;  /* Natural green - matches Home.html */
  --accent: #d4a5a5;     /* Soft pink - matches Home.html */
  --light: #f8f9fa;
  --dark: #2c3e50;
  --success: #4caf50;
  --warning: #ff9800;
  --danger: #f44336;
  --danger-light: #ffebee;
  --danger-dark: #d32f2f;
  --gray: #6c757d;
  --gray-light: #e9ecef;
  --transition: all 0.3s ease;
  --radius: 12px;
  --white: #ffffff;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 8px 15px rgba(0, 0, 0, 0.1);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
  text-size-adjust: 100%;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  line-height: 1.6;
  color: var(--dark);
  background-color: var(--white);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: min(95%, 1200px);
  margin: 0 auto;
  padding: 0 clamp(1rem, 3vw, 1.5rem);
}

/* Hero Section - Matched to Home.html */
.hero {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  color: var(--dark);
  padding: clamp(3rem, 8vw, 6rem) clamp(1rem, 4vw, 2.5rem);
  text-align: center;
  position: relative;
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800" opacity="0.02"><path fill="%234a6fa5" d="M0,0V800H1200V0ZM600,400C600,267,709.5,160,850,160S1100,267,1100,400,990.5,640,850,640,600,533,600,400ZM100,400c0-133,109.5-240,250-240S600,267,600,400,490.5,640,350,640,100,533,100,400Z"/></svg>');
  background-size: cover;
  pointer-events: none;
}

.hero-content {
  max-width: min(95%, 800px);
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

.hero h1 {
  font-size: clamp(1.8rem, 5vw, 2.8rem);
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-weight: 300;
  line-height: 1.2;
  word-wrap: break-word;
  overflow-wrap: break-word;
  animation: fadeInUp 0.8s ease 0.2s forwards;
  opacity: 0;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hero h1 strong {
  font-weight: 600;
  color: var(--primary);
}

.hero p {
  font-size: clamp(1rem, 2.5vw, 1.2rem);
  color: var(--gray);
  max-width: min(95%, 700px);
  margin: 0 auto clamp(1.5rem, 4vw, 2.5rem);
  line-height: 1.6;
  word-wrap: break-word;
  overflow-wrap: break-word;
  animation: fadeInUp 0.8s ease 0.4s forwards;
  opacity: 0;
}

.hero-features {
  display: flex;
  justify-content: center;
  gap: clamp(1rem, 4vw, 2.5rem);
  flex-wrap: wrap;
  margin-top: clamp(1.5rem, 4vw, 2rem);
}

.feature {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  min-width: 100px;
  -webkit-tap-highlight-color: transparent;
}

.feature i {
  font-size: clamp(1.5rem, 4vw, 1.8rem);
  margin-bottom: 0.25rem;
  color: var(--primary);
  opacity: 0.9;
}

.feature span {
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  font-weight: 500;
  color: var(--gray);
  text-align: center;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Card Layout - Matched to Home.html */
.survey-card {
  background: var(--white);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-light);
  animation: fadeIn 0.8s ease 0.6s forwards;
  opacity: 0;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}

/* Progress Bar - Updated colors */
.progress-text {
  text-align: center;
  margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
  font-weight: 600;
  color: var(--gray);
  padding: clamp(1rem, 3vw, 1.5rem) clamp(1.5rem, 4vw, 2rem) 0;
  font-size: clamp(0.9rem, 2.5vw, 1.05rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.progress-container {
  height: clamp(6px, 1.5vw, 8px);
  background: var(--light);
  border-radius: 10px;
  margin: 0 clamp(1.5rem, 4vw, 2rem) clamp(1.5rem, 4vw, 2rem);
  overflow: hidden;
}

#progressFill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--primary-light));
  width: 0%;
  transition: width 0.5s ease;
  border-radius: 10px;
}

/* Screens */
.screen {
  display: none;
}

.screen.active {
  display: block;
  animation: fadeInSlide 0.5s ease;
}

@keyframes fadeInSlide {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Welcome Screen - Updated style */
.welcome-content {
  text-align: center;
  max-width: min(95%, 700px);
  margin: 0 auto;
  padding: clamp(2rem, 5vw, 3rem) clamp(1rem, 4vw, 2rem);
}

.welcome-icon {
  font-size: clamp(3rem, 8vw, 4rem);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  color: var(--primary);
  display: inline-block;
}

.welcome-content h2 {
  font-size: clamp(1.4rem, 4vw, 2rem);
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-weight: 300;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.welcome-content h2 strong {
  font-weight: 600;
  color: var(--primary);
}

.welcome-content p {
  font-size: clamp(0.95rem, 2.5vw, 1.15rem);
  color: var(--gray);
  line-height: 1.6;
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.features-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.25rem);
  margin: clamp(1.5rem, 4vw, 2.5rem) 0;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: clamp(0.75rem, 2vw, 1rem);
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: var(--radius);
  font-weight: 500;
  color: var(--gray);
  transition: var(--transition);
  border: 1px solid var(--gray-light);
  -webkit-tap-highlight-color: transparent;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.feature-item:hover {
  transform: translateY(-3px);
  border-color: var(--gray-light);
  box-shadow: var(--shadow);
}

.feature-item:active {
  transform: translateY(-1px);
}

.feature-icon {
  font-size: clamp(1.2rem, 3vw, 1.4rem);
  color: var(--primary);
  flex-shrink: 0;
}

/* Buttons - Updated colors */
.btn {
  padding: clamp(0.75rem, 2vw, 0.875rem) clamp(1.25rem, 3vw, 1.75rem);
  border: none;
  border-radius: 50px;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-family: inherit;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-decoration: none;
  min-height: 44px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  position: relative;
  overflow: hidden;
}

.btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: inherit;
  background: rgba(255, 255, 255, 0.1);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.btn:hover::after {
  opacity: 1;
}

.btn-primary {
  background-color: var(--primary);
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background-color: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
}

.btn-secondary:hover {
  background-color: rgba(74, 111, 165, 0.1);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-large {
  padding: clamp(1rem, 3vw, 1.25rem) clamp(2rem, 5vw, 2.5rem);
  font-size: clamp(1rem, 3vw, 1.15rem);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-info {
  background: var(--secondary);
  color: white;
  border: none;
}

.btn-info:hover {
  transform: translateY(-2px);
  background: #699449;
  box-shadow: var(--shadow);
}

/* Focus states */
.btn:focus,
.option-btn:focus,
input:focus,
select:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.btn:focus:not(:focus-visible) {
  outline: none;
}

/* Question Box - Updated style */
.question-box {
  padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1rem, 3vw, 2rem);
}

.question {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(1rem, 3vw, 1.75rem);
  flex-wrap: wrap;
  gap: 1rem;
}

.question-number {
  font-weight: 600;
  color: var(--primary);
  font-size: clamp(0.9rem, 2.5vw, 1.05rem);
  background: rgba(74, 111, 165, 0.1);
  padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 20px;
  flex-shrink: 0;
}

.question-text {
  font-size: clamp(1.1rem, 3vw, 1.35rem);
  font-weight: 500;
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  color: var(--dark);
  line-height: 1.5;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.options {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 0.875rem);
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.option-btn {
  padding: clamp(1rem, 3vw, 1.25rem) clamp(1.25rem, 3vw, 1.5rem);
  border: 2px solid var(--gray-light);
  border-radius: 10px;
  background: white;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: clamp(0.5rem, 2vw, 0.75rem);
  color: var(--gray);
  text-align: left;
  position: relative;
  min-height: 44px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
}

.option-btn:hover {
  transform: translateY(-2px);
  border-color: var(--primary-light);
  background: #f8fafc;
}

.option-btn.selected {
  border-color: var(--primary);
  background: rgba(74, 111, 165, 0.1);
  color: var(--primary);
  font-weight: 600;
}

.option-btn:active {
  transform: translateY(0);
}

.keyboard-shortcut {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: clamp(20px, 5vw, 24px);
  height: clamp(20px, 5vw, 24px);
  background: var(--gray-light);
  border-radius: 4px;
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  font-weight: 600;
  margin-right: 0.5rem;
  color: var(--gray);
  flex-shrink: 0;
}

.option-btn.selected .keyboard-shortcut {
  background: var(--primary);
  color: white;
}

.nav-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: clamp(1.5rem, 4vw, 2.5rem);
  gap: clamp(0.75rem, 2vw, 1rem);
}

/* Loading Screen */
.loading-state {
  text-align: center;
  padding: clamp(3rem, 8vw, 5rem) clamp(1rem, 4vw, 2rem);
}

.spinner {
  border: 5px solid var(--gray-light);
  border-top: 5px solid var(--primary);
  border-radius: 50%;
  width: clamp(50px, 12vw, 60px);
  height: clamp(50px, 12vw, 60px);
  animation: spin 1s linear infinite;
  margin: clamp(1rem, 3vw, 1.5rem) auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-details {
  margin-top: clamp(1.5rem, 4vw, 2.5rem);
  max-width: min(95%, 400px);
  margin-left: auto;
  margin-right: auto;
}

.loading-step {
  margin: clamp(0.75rem, 2vw, 1rem) 0;
  color: var(--gray);
  padding: clamp(0.5rem, 1.5vw, 0.75rem);
  border-radius: 8px;
  transition: var(--transition);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.loading-step.active {
  color: var(--primary);
  font-weight: 600;
  background: rgba(74, 111, 165, 0.1);
}

/* Results Screen - Updated style */
.result-box {
  padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1rem, 3vw, 2rem);
}

.results-header {
  text-align: center;
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.results-header h2 {
  font-size: clamp(1.4rem, 4vw, 2rem);
  color: var(--dark);
  margin-bottom: clamp(0.5rem, 1.5vw, 0.75rem);
  font-weight: 300;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.results-header h2 strong {
  font-weight: 600;
  color: var(--primary);
}

.results-meta {
  color: var(--gray);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: clamp(0.5rem, 2vw, 1rem);
  flex-wrap: wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.primary-result {
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.diagnosis-result {
  background: white;
  border-radius: var(--radius);
  padding: clamp(1.5rem, 4vw, 2.5rem);
  border: 1px solid var(--gray-light);
  transition: var(--transition);
  box-shadow: var(--shadow);
  -webkit-tap-highlight-color: transparent;
}

.diagnosis-result:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg);
}

.diagnosis-result:active {
  transform: translateY(-1px);
}

.diagnosis-normal {
  border-left: clamp(4px, 1vw, 6px) solid var(--secondary);
}

.diagnosis-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(1rem, 3vw, 1.75rem);
  flex-wrap: wrap;
  gap: clamp(0.5rem, 2vw, 1rem);
}

.diagnosis-header h3 {
  color: var(--gray);
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.confidence-badge {
  background: var(--secondary);
  color: white;
  padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 20px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 600;
  flex-shrink: 0;
}

.diagnosis-main h1 {
  font-size: clamp(1.3rem, 4vw, 1.75rem);
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.25rem);
  font-weight: 600;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.diagnosis-description {
  color: var(--gray);
  font-size: clamp(0.95rem, 2.5vw, 1.05rem);
  line-height: 1.6;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.additional-results {
  display: grid;
  gap: clamp(1.5rem, 4vw, 2rem);
  margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
}

.results-section h4 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.25rem);
  font-size: clamp(1rem, 3vw, 1.2rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.diagnoses-list {
  display: grid;
  gap: clamp(0.75rem, 2vw, 0.875rem);
}

.diagnosis-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: 10px;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}

.diagnosis-item:hover {
  transform: translateY(-2px);
  background: #f1f5f9;
}

.diagnosis-item:active {
  transform: translateY(0);
}

.diagnosis-name {
  font-weight: 500;
  color: var(--dark);
  flex: 1;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.diagnosis-probability {
  background: var(--gray-light);
  padding: clamp(0.3rem, 1vw, 0.4rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 15px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 600;
  color: #475569;
  flex-shrink: 0;
}

.info-note {
  background: #f0f7ff;
  padding: clamp(1rem, 3vw, 1.25rem);
  border-radius: 10px;
  margin: clamp(1rem, 3vw, 1.5rem) 0;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  line-height: 1.5;
  color: var(--dark);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.info-note strong {
  color: var(--primary);
}

.results-actions {
  display: flex;
  gap: clamp(0.75rem, 2vw, 1rem);
  justify-content: center;
  margin-top: clamp(1.5rem, 4vw, 2rem);
  flex-wrap: wrap;
}

/* Review Screen - Updated style */
.review-content {
  display: grid;
  gap: clamp(1.5rem, 4vw, 2rem);
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
}

.patient-info-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
}

.patient-info-section h3 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-size: clamp(1.1rem, 3vw, 1.3rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.patient-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.5rem);
}

/* Patient Details Grid for Results Screen */
.patient-details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: clamp(1rem, 3vw, 1.5rem);
  margin-top: clamp(1rem, 3vw, 1.5rem);
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: 8px;
  border: 1px solid var(--gray-light);
  transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}

.detail-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.detail-item:active {
  transform: translateY(0);
}

.detail-label {
  font-weight: 500;
  color: var(--gray);
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.detail-value {
  font-size: clamp(0.9rem, 2.5vw, 1.05rem);
  color: var(--dark);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Adjust patient-info-section for results */
.patient-info-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
}

.patient-info-section h3 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  font-size: clamp(1.1rem, 3vw, 1.3rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Patient Info Values */
.patient-info-value {
  padding: clamp(0.5rem, 1.5vw, 0.75rem) 1rem;
  background: var(--light);
  border: 1px solid var(--gray-light);
  border-radius: 8px;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  color: var(--dark);
  min-height: 44px; /* Minimum touch target */
  display: flex;
  align-items: center;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Adjust form-group for patient info display */
.patient-info-section .form-group {
  margin-bottom: 0;
}

.patient-info-section .form-group label {
  font-weight: 500;
  color: var(--gray);
  margin-bottom: 0.5rem;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group label {
  font-weight: 500;
  color: var(--gray);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.form-group input,
.form-group select {
  padding: clamp(0.5rem, 1.5vw, 0.75rem) 1rem;
  border: 2px solid var(--gray-light);
  border-radius: 8px;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  font-family: inherit;
  transition: var(--transition);
  background: white;
  min-height: 44px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
}

.responses-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  border: 1px solid var(--gray-light);
}

.responses-list {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.response-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: clamp(1rem, 3vw, 1.25rem);
  background: var(--light);
  border-radius: 10px;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  transition: var(--transition);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.response-item:hover {
  transform: translateY(-2px);
  background: #f1f5f9;
}

.response-item:active {
  transform: translateY(0);
}

.response-question {
  flex: 1;
  min-width: 0;
}

.response-category {
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  color: var(--gray);
  font-weight: 500;
  margin-bottom: 0.25rem;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.response-text {
  font-weight: 500;
  color: var(--dark);
  margin-bottom: 0.5rem;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.response-answer {
  color: var(--primary);
  font-weight: 600;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.edit-btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 500;
  transition: var(--transition);
  min-height: 36px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  flex-shrink: 0;
}

.edit-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.edit-btn:active {
  transform: translateY(0);
}

.review-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: clamp(1.5rem, 4vw, 2rem);
  padding-top: clamp(1.5rem, 4vw, 2rem);
  border-top: 1px solid var(--gray-light);
  gap: clamp(0.75rem, 2vw, 1rem);
}

/* History Screen - Updated style */
.history-content {
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.history-item {
  background: white;
  border-radius: var(--radius);
  padding: clamp(1rem, 3vw, 1.5rem);
  border: 1px solid var(--gray-light);
  transition: var(--transition);
  -webkit-tap-highlight-color: transparent;
}

.history-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.history-item:active {
  transform: translateY(0);
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(0.75rem, 2vw, 1rem);
  flex-wrap: wrap;
  gap: clamp(0.5rem, 2vw, 1rem);
}

.history-patient {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  flex: 1;
  min-width: 0;
}

.history-patient strong {
  color: var(--dark);
  font-size: clamp(1rem, 2.5vw, 1.1rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.history-id {
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  color: var(--gray);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.history-diagnosis {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: clamp(0.4rem, 1vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 20px;
  font-weight: 600;
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  flex-shrink: 0;
}

.history-diagnosis.normal {
  background: #e8f5e9;
  color: #2e7d32;
}

.history-diagnosis.depression {
  background: #ffebee;
  color: #c62828;
}

.history-diagnosis.bipolar-type-1,
.history-diagnosis.bipolar-type-2 {
  background: #f3e5f5;
  color: #7b1fa2;
}

.history-confidence {
  background: white;
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  font-size: clamp(0.7rem, 1.8vw, 0.8rem);
}

.history-details {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.history-actions {
  display: flex;
  gap: clamp(0.25rem, 1vw, 0.5rem);
  flex-wrap: wrap;
}

.btn-view,
.btn-download,
.btn-delete {
  padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border: none;
  border-radius: 6px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-height: 36px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
}

.btn-view {
  background: var(--primary);
  color: white;
}

.btn-view:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.btn-download {
  background: var(--secondary);
  color: white;
}

.btn-download:hover {
  background: #699449;
  transform: translateY(-1px);
}

.btn-delete {
  background: var(--danger);
  color: white;
}

.btn-delete:hover {
  background: var(--danger-dark);
  transform: translateY(-1px);
}

.btn-view:active,
.btn-download:active,
.btn-delete:active {
  transform: translateY(0);
}

.no-history {
  text-align: center;
  padding: clamp(2rem, 5vw, 3rem) clamp(1rem, 4vw, 2rem);
  color: var(--gray);
  font-size: clamp(0.95rem, 2.5vw, 1.1rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.welcome-actions {
  display: flex;
  flex-direction: column;
  gap: clamp(0.75rem, 2vw, 1rem);
  margin: clamp(1.5rem, 4vw, 2rem) 0;
  max-width: min(95%, 300px);
  margin-left: auto;
  margin-right: auto;
}

/* Login Section */
.login-section {
  background: white;
  padding: clamp(1.5rem, 4vw, 2rem);
  border-radius: var(--radius);
  margin-bottom: clamp(1.5rem, 4vw, 2rem);
  max-width: min(95%, 500px);
  margin-left: auto;
  margin-right: auto;
  border: 1px solid var(--gray-light);
}

.login-section h3 {
  color: var(--dark);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  text-align: center;
  font-size: clamp(1.1rem, 3vw, 1.3rem);
  font-weight: 500;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.login-form {
  display: flex;
  flex-direction: column;
  gap: clamp(1rem, 3vw, 1.5rem);
}

.login-actions {
  display: flex;
  gap: clamp(0.75rem, 2vw, 1rem);
  margin-top: clamp(0.75rem, 2vw, 1rem);
}

.login-actions .btn {
  flex: 1;
}

.patient-history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  flex-wrap: wrap;
  gap: clamp(0.75rem, 2vw, 1rem);
}

.patient-welcome {
  background: #f0f7ff;
  padding: clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.5rem);
  border-radius: 10px;
  border-left: clamp(3px, 1vw, 4px) solid var(--primary);
  margin-bottom: clamp(1rem, 3vw, 1.5rem);
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.patient-welcome h4 {
  color: var(--primary);
  margin-bottom: 0.5rem;
  font-weight: 500;
  font-size: clamp(0.95rem, 2.5vw, 1.1rem);
}

.logout-btn {
  background: var(--gray);
  color: white;
  border: none;
  padding: clamp(0.4rem, 1.5vw, 0.5rem) clamp(0.75rem, 2vw, 1rem);
  border-radius: 6px;
  cursor: pointer;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-height: 36px; /* Minimum touch target */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
}

.logout-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

.logout-btn:active {
  transform: translateY(0);
}

/* Validation Hint Styles */
.validation-hint {
  font-size: clamp(0.7rem, 1.8vw, 0.8rem);
  color: #6c757d; /* Gray color for hints */
  margin-top: 4px;
  line-height: 1.4;
  opacity: 0.8;
}

/* For specific hint containers */
#patient-number-hint,
#patient-age-hint,
#patient-name-hint,
#login-number-hint {
  font-size: clamp(0.7rem, 1.8vw, 0.8rem);
  color: #6c757d; /* Gray color for hints */
  margin-top: 4px;
  line-height: 1.4;
  opacity: 0.8;
}

/* Adjust the parent container to better contain hints */
.form-group .validation-message {
  min-height: 24px; /* Reserve space for hint/error messages */
}

/* Make input placeholders lighter */
.form-group input::placeholder,
.form-group select::placeholder {
  color: #adb5bd; /* Lighter gray for placeholders */
  opacity: 0.8;
}

/* Ensure error messages remain prominent */
.input-error-message {
  color: #ef4444;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
  opacity: 1 !important; /* Override any opacity inheritance */
}

/* For disabled/readonly hint states */
.form-group input[readonly] + .validation-hint,
.form-group input:disabled + .validation-hint {
  opacity: 0.6;
}

/* Responsive adjustments for hints */
@media (max-width: 768px) {
  .validation-hint,
  #patient-number-hint,
  #patient-age-hint,
  #patient-name-hint,
  #login-number-hint {
    font-size: 0.7rem;
    line-height: 1.3;
  }
}

@media (max-width: 480px) {
  .validation-hint,
  #patient-number-hint,
  #patient-age-hint,
  #patient-name-hint,
  #login-number-hint {
    font-size: 0.65rem;
    margin-top: 3px;
  }
}

/* Input Error Styles */
.input-error {
  border-color: var(--danger) !important;
  background-color: var(--danger-light) !important;
}

.input-error:focus {
  box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1) !important;
}

.input-error-message {
  color: var(--danger);
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
  animation: fadeIn 0.3s ease;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Mobile Navigation Bar */
.mobile-nav {
  display: none; 
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  z-index: 1000;
  padding: 0.5rem clamp(0.5rem, 2vw, 1rem);
  border-top: 1px solid var(--gray-light);
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

.mobile-nav-items {
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: clamp(0.5rem, 1.5vw, 0.75rem);
  border-radius: 8px;
  transition: var(--transition);
  text-decoration: none;
  color: var(--gray);
  font-size: clamp(0.65rem, 1.8vw, 0.75rem);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  min-width: 60px;
}

.mobile-nav-item.active {
  color: var(--primary);
  background: rgba(74, 111, 165, 0.1);
  font-weight: 600;
}

.mobile-nav-item i {
  font-size: clamp(1.1rem, 3vw, 1.25rem);
}

/* Responsive Design */

/* Tablet Landscape */
@media (max-width: 1024px) {
  .features-list {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .patient-form {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .patient-details-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Tablet Portrait */
@media (max-width: 768px) {
  .hero {
    padding: clamp(2.5rem, 6vw, 3rem) clamp(1rem, 3vw, 1.5rem);
  }
  
  .features-list {
    grid-template-columns: 1fr;
  }
  
  .question-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .option-btn {
    padding: 1rem 1.25rem;
  }
  
  .results-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .results-actions .btn {
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
  }
  
  .nav-buttons {
    flex-direction: column-reverse;
    align-items: stretch;
  }
  
  .nav-buttons button {
    width: 100%;
  }
  
  .welcome-content {
    padding: 2rem 1.5rem;
  }
  
  .question-box, .result-box {
    padding: 1.5rem;
  }
  
  .progress-container, .progress-text {
    margin-left: 1.5rem;
    margin-right: 1.5rem;
  }
  
  .history-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .history-details {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
  }
  
  .history-actions {
    width: 100%;
    justify-content: flex-start;
  }
  
  .welcome-actions {
    max-width: 100%;
  }
  
  .review-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .patient-form {
    grid-template-columns: 1fr;
  }
  
  .patient-details-grid {
    grid-template-columns: 1fr;
  }
  
  .mobile-nav {
    display: block;
  }
  
  .input-error-message {
    font-size: 0.8rem;
  }
  
  .hero-features {
    gap: 2rem;
  }
  
  .feature {
    min-width: 80px;
  }
  
  .login-actions {
    flex-direction: column;
  }
  
  .logout-btn {
    align-self: flex-start;
  }
}

/* Mobile Landscape */
@media (max-width: 640px) {
  .hero h1 {
    font-size: 1.8rem;
    line-height: 1.3;
  }
  
  .hero p {
    font-size: 1rem;
  }
  
  .diagnosis-header h3 {
    font-size: 0.9rem;
  }
  
  .diagnosis-main h1 {
    font-size: 1.4rem;
  }
  
  .patient-history-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .response-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .edit-btn {
    align-self: flex-start;
  }
  
  .history-actions {
    width: 100%;
    justify-content: stretch;
  }
  
  .btn-view,
  .btn-download,
  .btn-delete {
    flex: 1;
    justify-content: center;
  }
}

/* Mobile Portrait */
@media (max-width: 480px) {
  .diagnosis-result {
    padding: 1.5rem;
  }
  
  .diagnosis-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .login-section {
    padding: 1.25rem;
  }
  
  .history-actions {
    flex-wrap: wrap;
  }
  
  .hero h1 {
    font-size: 1.6rem;
  }
  
  .hero p {
    font-size: 0.95rem;
  }
  
  .welcome-icon {
    font-size: 2.5rem;
  }
  
  .feature-item {
    padding: 1rem;
  }
  
  .question {
    padding: 1.5rem;
  }
  
  .diagnosis-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .diagnosis-probability {
    align-self: flex-start;
  }
  
  .patient-welcome {
    padding: 1rem;
  }
  
  .hero-features {
    gap: 1.5rem;
  }
  
  .feature {
    min-width: 70px;
  }
  
  .feature i {
    font-size: 1.5rem;
  }
  
  .feature span {
    font-size: 0.8rem;
  }
}

/* Small Mobile Devices */
@media (max-width: 360px) {
  .hero {
    padding: 2rem 1rem;
  }
  
  .hero h1 {
    font-size: 1.5rem;
  }
  
  .hero p {
    font-size: 0.9rem;
  }
  
  .container {
    padding: 0 1rem;
  }
  
  .welcome-content {
    padding: 1.5rem 1rem;
  }
  
  .question-box, .result-box {
    padding: 1rem;
  }
  
  .question {
    padding: 1.25rem;
  }
  
  .option-btn {
    padding: 0.875rem 1rem;
  }
  
  .keyboard-shortcut {
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
  }
  
  .diagnosis-result {
    padding: 1.25rem;
  }
  
  .patient-info-section {
    padding: 1.25rem;
  }
  
  .responses-section {
    padding: 1.25rem;
  }
  
  .history-item {
    padding: 1.25rem;
  }
  
  .login-section {
    padding: 1rem;
  }
  
  .btn-large {
    padding: 1rem 2rem;
  }
  
  .mobile-nav-item {
    padding: 0.5rem;
    min-width: 50px;
  }
  
  .mobile-nav-item i {
    font-size: 1.1rem;
  }
  
  .mobile-nav-item span {
    font-size: 0.65rem;
  }
}

/* Ultra Small Screens */
@media (max-width: 320px) {
  .hero h1 {
    font-size: 1.4rem;
  }
  
  .hero p {
    font-size: 0.85rem;
  }
  
  .question-text {
    font-size: 1rem;
  }
  
  .option-btn {
    font-size: 0.9rem;
  }
  
  .btn {
    font-size: 0.9rem;
    padding: 0.75rem 1.5rem;
  }
  
  .diagnosis-main h1 {
    font-size: 1.2rem;
  }
  
  .diagnosis-description {
    font-size: 0.9rem;
  }
  
  .hero-features {
    gap: 1rem;
  }
  
  .feature {
    min-width: 60px;
  }
  
  .feature i {
    font-size: 1.3rem;
  }
  
  .feature span {
    font-size: 0.75rem;
  }
}

/* For number input */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type="number"] {
  -webkit-appearance: textfield;
  -moz-appearance: textfield;
  appearance: textfield;
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
  .option-btn:hover,
  .feature-item:hover,
  .btn:hover,
  .diagnosis-item:hover,
  .response-item:hover,
  .history-item:hover,
  .detail-item:hover,
  .edit-btn:hover,
  .btn-view:hover,
  .btn-download:hover,
  .btn-delete:hover,
  .logout-btn:hover {
    transform: none;
  }
  
  .option-btn:active,
  .feature-item:active,
  .btn:active,
  .diagnosis-item:active,
  .response-item:active,
  .history-item:active,
  .detail-item:active,
  .edit-btn:active,
  .btn-view:active,
  .btn-download:active,
  .btn-delete:active,
  .logout-btn:active {
    transform: scale(0.98);
  }
  
  /* Larger touch targets for very small screens */
  @media (max-width: 480px) {
    .option-btn,
    .btn,
    .edit-btn,
    .btn-view,
    .btn-download,
    .btn-delete,
    .logout-btn {
      min-height: 48px;
    }
    
    .mobile-nav-item {
      min-height: 44px;
    }
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .fade-in {
    animation: none;
    opacity: 1;
  }
  
  .screen.active {
    animation: none;
  }
  
  .spinner {
    animation: none;
    border-top-color: var(--gray-light);
  }
  
  #progressFill {
    transition: none;
  }
}

/* Print Styles */
@media print {
  .hero {
    background: var(--light) !important;
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
    padding: 2rem 0 !important;
    margin-bottom: 1rem !important;
  }
  
  .controls,
  .mobile-nav,
  .nav-buttons,
  .edit-btn,
  .btn-view,
  .btn-download,
  .btn-delete,
  .logout-btn,
  .progress-container {
    display: none;
  }
  
  .survey-card,
  .diagnosis-result,
  .patient-info-section,
  .responses-section,
  .history-item,
  .login-section {
    break-inside: avoid;
    box-shadow: none !important;
    border: 1px solid #ddd !important;
  }
  
  .btn {
    display: none !important;
  }
  
  .option-btn {
    border: 1px solid #ddd !important;
  }
  
  .option-btn.selected {
    background: #f0f0f0 !important;
    color: #333 !important;
  }
}

/* iOS-specific fixes */
@supports (-webkit-touch-callout: none) {
  .btn,
  .option-btn,
  .feature-item,
  .diagnosis-item,
  .response-item,
  .history-item,
  .detail-item,
  .edit-btn,
  .btn-view,
  .btn-download,
  .btn-delete,
  .logout-btn,
  .mobile-nav-item {
    cursor: pointer;
  }
  
  /* Fix for iOS Safari rounded corners with gradients */
.hero::before {
  -webkit-mask-image: -webkit-radial-gradient(white, black); /* iOS Safari */
  mask-image: radial-gradient(white, black);                /* Standard */
}
  
  /* Fix for iOS input zoom */
  @media screen and (max-width: 768px) {
    input,
    select,
    textarea {
      font-size: 16px !important;
    }
  }
}

/* Ensure all text is selectable but buttons and interactive elements are not */
p, h1, h2, h3, h4, h5, h6, span:not(.btn *):not(.option-btn *):not(.edit-btn *):not(.btn-view *):not(.btn-download *):not(.btn-delete *):not(.logout-btn *):not(.mobile-nav-item *) {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

.btn, .option-btn, .edit-btn, .btn-view, .btn-download, .btn-delete, .logout-btn, .mobile-nav-item {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Focus states for accessibility */
.btn:focus,
.option-btn:focus,
.edit-btn:focus,
.btn-view:focus,
.btn-download:focus,
.btn-delete:focus,
.logout-btn:focus,
.mobile-nav-item:focus,
input:focus,
select:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
  border-radius: 3px;
}





/* Add custom alert styles */
.custom-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ef4444;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    max-width: 400px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.custom-alert.show {
    transform: translateX(0);
}

.alert-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.alert-icon {
    font-size: 1.5rem;
}

.alert-message {
    flex: 1;
    font-size: 0.9rem;
}

.alert-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin: 0;
}

.input-error {
    border-color: #ef4444 !important;
}

.input-error-message {
    color: #ef4444;
    font-size: 0.8rem;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
</style>
</head>
<body>
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <h1 id="hero-title"></h1>
      <p id="hero-description"></p>
      <div class="hero-features">
        <div class="feature">
          <i class="fas fa-shield-alt"></i>
          <span id="feature-secure"></span>
        </div>
        <div class="feature">
          <i class="fas fa-brain"></i>
          <span id="feature-clinical"></span>
        </div>
        <div class="feature">
          <i class="fas fa-chart-line"></i>
          <span id="feature-insights"></span>
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <div class="survey-card">
      <!-- Welcome Screen -->
      <div id="welcomeScreen" class="screen active">
        <div class="welcome-content">
          <div class="welcome-icon">ðŸ§ </div>
          <h2 id="welcome-title"></h2>
          <p id="welcome-description"></p>

          <div class="features-list">
            <div class="feature-item">
              <span class="feature-icon">ðŸ”’</span>
              <span id="feature-confidential"></span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">âš¡</span>
              <span id="feature-time"></span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ðŸ“Š</span>
              <span id="feature-evidence"></span>
            </div>
            <div class="feature-item">
              <span class="feature-icon">ðŸ’¡</span>
              <span id="feature-personalized"></span>
            </div>
          </div>

          <div class="welcome-actions">
            <button id="startBtn" class="btn btn-primary btn-large">
              <span id="start-button-text"></span>
              <span>â†’</span>
            </button>
            <button id="viewHistoryBtn" class="btn btn-secondary">
              <i class="fas fa-history"></i>
              <span id="view-history-button-text"></span>
            </button>
          </div>

          <div class="info-note">
            <strong id="important-note-title"></strong> 
            <span id="important-note-text"></span>
          </div>
        </div>
      </div>

      <!-- Questions Screen -->
      <div id="questionsScreen" class="screen">
        <div class="progress-text" id="progressText"></div>
        <div class="progress-container">
          <div id="progressFill"></div>
        </div>

        <div class="question-box">
          <div class="question">
            <div class="question-header">
              <div class="question-number" id="questionCategory"></div>
            </div>
            
            <div class="question-text" id="questionText"></div>

            <div class="options" id="optionsContainer"></div>

            <div class="nav-buttons">
              <button id="prevBtn" class="btn btn-secondary" disabled>
                <span id="previous-button-text"></span>
              </button>
              <button id="nextBtn" class="btn btn-primary" disabled>
                <span id="next-button-text"></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Screen -->
      <div id="loadingScreen" class="screen">
        <div class="loading-state">
          <div class="spinner"></div>
          <h2 id="processing-title"></h2>
          <p id="processing-description"></p>
          
          <div class="loading-details">
            <div class="loading-step" id="step-validating"></div>
            <div class="loading-step" id="step-calculating"></div>
            <div class="loading-step" id="step-analyzing"></div>
            <div class="loading-step" id="step-generating"></div>
            <div class="loading-step" id="step-finalizing"></div>
          </div>
        </div>
      </div>

      <!-- Edit Review Screen -->
      <div id="reviewScreen" class="screen">
        <div class="result-box">
          <div class="results-header">
            <h2 id="review-title"></h2>
            <p id="review-description"></p>
          </div>

          <div class="review-content">
            <div class="patient-info-section">
              <h3 id="patient-info-title"></h3>
                <div class="patient-form">
                  <div class="form-group">
                    <label for="patientName" id="patient-name-label"></label>
                    <input type="text" id="patientName" placeholder="">
                    <div class="validation-message" id="patient-name-validation"></div>
                  </div>
                  <div class="form-group">
                    <label for="patientNumber" id="patient-number-label"></label>
                    <input type="text" id="patientNumber" 
                          placeholder=""
                          maxlength="20"
                          title="">
                    <div class="validation-message" id="patient-number-validation">
                      <div class="validation-hint" id="patient-number-hint"></div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="patientAge" id="patient-age-label"></label>
                    <input type="number" id="patientAge" 
                          min="12" 
                          max="100" 
                          step="1"
                          placeholder=""
                          title="">
                    <div class="validation-message" id="patient-age-validation">
                      <div class="validation-hint" id="patient-age-hint"></div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="patientGender" id="patient-gender-label"></label>
                    <select id="patientGender">
                      <option value="" id="gender-default"></option>
                      <option value="Male" id="gender-male"></option>
                      <option value="Female" id="gender-female"></option>
                      <option value="Other" id="gender-other"></option>
                      <option value="Prefer not to say" id="gender-prefer-not"></option>
                    </select>
                  </div>
                </div>
              <div class="info-note" style="margin-top: 1rem;">
                <strong id="review-note-title"></strong> 
                <span id="review-note-text"></span>
              </div>
            </div>

            <div class="responses-section">
              <h3 id="responses-title"></h3>
              <div class="responses-list" id="responsesList"></div>
            </div>
          </div>

          <div class="review-actions">
            <button id="backToQuestionsBtn" class="btn btn-secondary">
              <span id="back-to-questions"></span>
            </button>
            <button id="submitFinalBtn" class="btn btn-primary">
              <span id="submit-assessment-button"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Results Screen -->
      <div id="resultsScreen" class="screen">
        <div class="result-box">
          <!-- Results content will be dynamically generated -->
        </div>
      </div>
      
      <!-- History Screen -->
      <div id="historyScreen" class="screen">
        <div class="result-box">
          <div class="results-header">
            <h2 id="history-title"></h2>
            <p id="history-description"></p>
          </div>

          <!-- Login Section -->
          <div class="login-section" id="loginSection">
            <h3 id="access-history-title"></h3>
            <div class="login-form">
              <div class="form-group">
                <label for="loginPatientName" id="login-name-label"></label>
                <input type="text" id="loginPatientName" placeholder="">
                <div class="validation-message" id="login-name-validation"></div>
              </div>
              <div class="form-group">
                <label for="loginPatientNumber" id="login-number-label"></label>
                <input type="text" id="loginPatientNumber" 
                      placeholder=""
                      maxlength="20"
                      title="">
                <div class="validation-message" id="login-number-validation">
                  <div class="validation-hint" id="login-number-hint"></div>
                </div>
              </div>
              <div class="login-actions">
                <button class="btn btn-secondary" id="backToWelcomeFromLoginBtn">
                  <span id="login-back-button"></span>
                </button>
                <button class="btn btn-primary" id="loginBtn">
                  <i class="fas fa-sign-in-alt"></i> 
                  <span id="login-access-button"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Patient History Section -->
          <div id="patientHistorySection" style="display: none;">
            <div class="patient-history-header">
              <div class="patient-welcome">
                <h4 id="welcome-patient"></h4>
                <p>
                  <span id="login-number-label"></span>
                  <strong id="loggedInPatientNumber"></strong>
                </p>
              </div>
              <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> 
                <span id="logout-button"></span>
              </button>
            </div>

            <div class="history-content">
              <div class="history-list" id="patientHistoryList"></div>
            </div>
          </div>

          <div class="history-actions">
            <button id="backToWelcomeBtn" class="btn btn-secondary">
              <span id="history-back-button"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mobile Navigation -->
  <nav class="mobile-nav">
    <div class="mobile-nav-items">
      <a href="#" class="mobile-nav-item active" data-screen="welcomeScreen">
        <i class="fas fa-home"></i>
        <span id="mobile-home"></span>
      </a>
      <a href="#" class="mobile-nav-item" id="mobileAssessmentBtn">
        <i class="fas fa-question-circle"></i>
        <span id="mobile-assessment"></span>
      </a>
      <a href="#" class="mobile-nav-item" id="mobileHistoryBtn">
        <i class="fas fa-history"></i>
        <span id="mobile-history"></span>
      </a>
    </div>
  </nav>

  
  <!-- Main assessment script -->
  <script>
// ============================================
// MENTAL HEALTH ASSESSMENT SYSTEM
// ============================================

class MentalHealthAssessmentSystem {
    constructor() {
        this.API_BASE_URL = window.location.origin;
        this.currentLanguage = window.globalLangManager?.currentLang || 'en';
        this.currentPatient = null;
        this.currentQuestionIndex = 0;
        this.responses = {};
        this.patientInfo = { name: '', number: '', age: '', gender: '' };
        this.currentAssessmentData = null;
        this.assessmentConfig = null;
        
        // Initialize constants
        this.initConstants();
        // Initialize system
        this.init();
    }

    // ============================================
    // CONSTANTS AND MAPPINGS (NO TRANSLATIONS)
    // ============================================

    initConstants() {
        // Question codes
        this.QUESTION_CODES = {
            Q1: 'Q1', Q2: 'Q2', Q3: 'Q3', Q4: 'Q4', Q5: 'Q5',
            Q6: 'Q6', Q7: 'Q7', Q8: 'Q8', Q9: 'Q9', Q10: 'Q10',
            Q11: 'Q11', Q12: 'Q12', Q13: 'Q13', Q14: 'Q14',
            Q15: 'Q15', Q16: 'Q16', Q17: 'Q17'
        };

        // Category codes mapping
        this.QUESTION_TO_CATEGORY = {
            Q1: 'CAT1', Q2: 'CAT1', Q3: 'CAT1',
            Q4: 'CAT2', Q5: 'CAT2',
            Q6: 'CAT3',
            Q7: 'CAT4', Q8: 'CAT4',
            Q9: 'CAT5',
            Q10: 'CAT6',
            Q11: 'CAT7',
            Q12: 'CAT8', Q13: 'CAT8',
            Q14: 'CAT9',
            Q15: 'CAT10', Q16: 'CAT10',
            Q17: 'CAT11'
        };

        // Answer type mapping
        this.QUESTION_TO_ANSWER_TYPE = {
            Q1: 'YN', Q2: 'FR', Q3: 'FR', Q4: 'FR', Q5: 'FR',
            Q6: 'YN', Q7: 'YN', Q8: 'YN', Q9: 'YN', Q10: 'YN',
            Q11: 'YN', Q12: 'YN', Q13: 'YN', Q14: 'YN',
            Q15: 'CO', Q16: 'OP', Q17: 'SA'
        };

        // Feature mapping for model (English only)
        this.QUESTION_TO_FEATURE = {
            Q1: 'Mood Swing', Q2: 'Sadness', Q3: 'Euphoric',
            Q4: 'Sleep disorder', Q5: 'Exhausted',
            Q6: 'Suicidal thoughts', Q7: 'Aggressive Response',
            Q8: 'Nervous Breakdown', Q9: 'Overthinking',
            Q10: 'Anorexia', Q11: 'Authority Respect',
            Q12: 'Try Explanation', Q13: 'Ignore & Move-On',
            Q14: 'Admit Mistakes', Q15: 'Concentration',
            Q16: 'Optimism', Q17: 'Sexual Activity'
        };

        // Answer code mappings (English only for backend)
        this.ANSWER_CODES = {
            YN: { NO: 'YN1', YES: 'YN2' },
            FR: {
                Seldom: 'FR1',
                Sometimes: 'FR2',
                Usually: 'FR3',
                'Most-Often': 'FR4'
            },
            CO: {
                'Cannot concentrate': 'CO1',
                'Poor concentration': 'CO2',
                'Average concentration': 'CO3',
                'Good concentration': 'CO4',
                'Excellent concentration': 'CO5'
            },
            OP: {
                'Extremely pessimistic': 'OP1',
                'Pessimistic': 'OP2',
                'Neutral outlook': 'OP3',
                'Optimistic': 'OP4',
                'Extremely optimistic': 'OP5'
            },
            SA: {
                'No interest': 'SA1',
                'Low interest': 'SA2',
                'Moderate interest': 'SA3',
                'High interest': 'SA4',
                'Very high interest': 'SA5'
            }
        };

        // CODE TO ENGLISH MAPPING (For backend only)
        this.CODE_TO_ENGLISH = {
            CATEGORIES: {
                CAT1: 'Mood & Emotions',
                CAT2: 'Sleep & Energy',
                CAT3: 'Safety Assessment',
                CAT4: 'Behavioral Patterns',
                CAT5: 'Anxiety & Worry',
                CAT6: 'Physical Health',
                CAT7: 'Social Behavior',
                CAT8: 'Conflict Resolution',
                CAT9: 'Self-Reflection',
                CAT10: 'Cognitive Function',
                CAT11: 'Sexual Health'
            },
            ANSWERS: {
                YN1: 'NO', YN2: 'YES',
                FR1: 'Seldom', FR2: 'Sometimes', FR3: 'Usually', FR4: 'Most-Often',
                CO1: 'Cannot concentrate', CO2: 'Poor concentration', CO3: 'Average concentration',
                CO4: 'Good concentration', CO5: 'Excellent concentration',
                OP1: 'Extremely pessimistic', OP2: 'Pessimistic', OP3: 'Neutral outlook',
                OP4: 'Optimistic', OP5: 'Extremely optimistic',
                SA1: 'No interest', SA2: 'Low interest', SA3: 'Moderate interest',
                SA4: 'High interest', SA5: 'Very high interest'
            }
        };
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    init() {
        this.cacheElements();
        this.attachEventListeners();
        this.setupValidations();
        this.initializeConfig();
        
        // Update UI texts
        this.updateAllTexts();
        
        // Listen for language changes
        this.setupLanguageListener();
    }

    cacheElements() {
        // Helper to map ID strings to DOM elements
        const getMap = (ids) => Object.entries(ids).reduce((acc, [key, id]) => {
            acc[key] = document.getElementById(id);
            return acc;
        }, {});

        this.elements = {
            screens: getMap({
                welcome: 'welcomeScreen',
                questions: 'questionsScreen',
                loading: 'loadingScreen',
                review: 'reviewScreen',
                results: 'resultsScreen',
                history: 'historyScreen'
            }),
            buttons: getMap({
                start: 'startBtn',
                viewHistory: 'viewHistoryBtn',
                prev: 'prevBtn',
                next: 'nextBtn',
                backToQuestions: 'backToQuestionsBtn',
                submitFinal: 'submitFinalBtn',
                login: 'loginBtn',
                logout: 'logoutBtn',
                backToWelcomeFromLogin: 'backToWelcomeFromLoginBtn',
                backToWelcome: 'backToWelcomeBtn'
            }),
            questionElements: getMap({
                category: 'questionCategory',
                text: 'questionText',
                options: 'optionsContainer',
                progressFill: 'progressFill',
                progressText: 'progressText'
            }),
            reviewElements: getMap({
                responsesList: 'responsesList',
                patientName: 'patientName',
                patientNumber: 'patientNumber',
                patientAge: 'patientAge',
                patientGender: 'patientGender'
            }),
            historyElements: getMap({
                loginSection: 'loginSection',
                patientHistorySection: 'patientHistorySection',
                loginPatientName: 'loginPatientName',
                loginPatientNumber: 'loginPatientNumber',
                loggedInPatientNumber: 'loggedInPatientNumber',
                patientHistoryList: 'patientHistoryList'
            })
        };
    }

    setupLanguageListener() {
        document.addEventListener('languageChanged', (e) => {
            if (e.detail?.language) {
                this.currentLanguage = e.detail.language;
                this.updateAllTexts();
                this.refreshCurrentScreen();
            }
        });
    }

    // ============================================
    // CONFIGURATION
    // ============================================

    initializeConfig() {
        // Question order
        const questionOrder = [
            'Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8',
            'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15',
            'Q16', 'Q17'
        ];

        this.assessmentConfig = {
            questions: questionOrder.map(qCode => ({
                code: qCode,
                categoryCode: this.QUESTION_TO_CATEGORY[qCode],
                feature: this.QUESTION_TO_FEATURE[qCode],
                answerType: this.QUESTION_TO_ANSWER_TYPE[qCode]
            }))
        };
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

// Replace the getTranslation method in MentalHealthAssessmentSystem class
// Replace the getTranslation method in MentalHealthAssessmentSystem class
getTranslation(path, defaultValue = '') {
    // First check if globalLangManager exists
    if (!window.globalLangManager) {
        return defaultValue;
    }
    
    // If globalLangManager has a t() method, use it
    if (typeof window.globalLangManager.t === 'function') {
        // Don't extract anything - let the t() method handle it
        const result = window.globalLangManager.t(path, 'prediction');
        // If the result is the same as the path, it might not have found the translation
        if (result && result !== path) {
            return result;
        }
    }
    
    // Fallback: manually search in translations
    const translations = window.globalLangManager.translations || {};
    const currentLang = this.currentLanguage;
    
    // Try multiple possible structures
    let value = defaultValue;
    
    // Structure 1: { en: { pdf_report: {...} } }
    if (translations[currentLang] && translations[currentLang][path]) {
        value = translations[currentLang][path];
    }
    // Structure 2: { en: { pdf_report: { title: '...' } } } - nested
    else if (translations[currentLang]) {
        const parts = path.split('.');
        let current = translations[currentLang];
        
        for (const part of parts) {
            if (current && current[part] !== undefined) {
                current = current[part];
            } else {
                current = null;
                break;
            }
        }
        
        if (current !== null && typeof current === 'string') {
            value = current;
        }
    }
    // Structure 3: { pdf_report: { title: '...' } } - not nested by language
    else if (translations[path]) {
        value = translations[path];
    }
    // Structure 4: { pdf_report: { title: '...' } } - nested in root
    else {
        const parts = path.split('.');
        let current = translations;
        
        for (const part of parts) {
            if (current && current[part] !== undefined) {
                current = current[part];
            } else {
                current = null;
                break;
            }
        }
        
        if (current !== null && typeof current === 'string') {
            value = current;
        }
    }
    
    return value || defaultValue;
}


    showScreen(screenElement) {
        // Hide all screens
        Object.values(this.elements.screens).forEach(screen => {
            screen?.classList.remove('active');
        });
        
        // Show target screen
        screenElement?.classList.add('active');
        
        // Update mobile nav
        this.updateMobileNav(screenElement);
    }

    updateMobileNav(screenElement) {
        const navItems = document.querySelectorAll('.mobile-nav-item');
        navItems.forEach(item => item.classList.remove('active'));

        if (screenElement === this.elements.screens.welcome) {
            document.querySelector('.mobile-nav-item[data-screen="welcomeScreen"]')?.classList.add('active');
        } else if (screenElement === this.elements.screens.questions || 
                   screenElement === this.elements.screens.results) {
            document.getElementById('mobileAssessmentBtn')?.classList.add('active');
        } else if (screenElement === this.elements.screens.history) {
            document.getElementById('mobileHistoryBtn')?.classList.add('active');
        }
    }

    // ============================================
    // ASSESSMENT FLOW (USING CODES ONLY)
    // ============================================

    startAssessment() {
        this.currentQuestionIndex = 0;
        this.responses = {};
        this.showScreen(this.elements.screens.questions);
        this.updateProgress();
        this.displayCurrentQuestion();
    }

    displayCurrentQuestion() {
        if (!this.assessmentConfig) return;

        const question = this.assessmentConfig.questions[this.currentQuestionIndex];
        
        // Get translated text for display only
        const categoryText = this.getTranslation(`prediction.questionCategories.${question.categoryCode}`) || 
                           this.CODE_TO_ENGLISH.CATEGORIES[question.categoryCode];
        const questionText = this.getTranslation(`prediction.questions.${question.code}`);

        this.elements.questionElements.category.textContent = categoryText;
        this.elements.questionElements.text.textContent = questionText;

        this.renderOptions(question);
        this.updateNavigationButtons();
    }

    renderOptions(question) {
        const container = this.elements.questionElements.options;
        container.innerHTML = '';

        const answerOptions = this.getAnswerOptions(question.answerType);
        
        answerOptions.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            
            // Display text from translation, store code
            const displayText = this.getAnswerDisplayText(question.answerType, option.label);
            button.textContent = displayText;
            button.dataset.code = option.code;
            
            // Add keyboard shortcut
            const shortcut = document.createElement('span');
            shortcut.className = 'keyboard-shortcut';
            shortcut.textContent = `${index + 1}`;
            button.prepend(shortcut);

            if (this.responses[question.code] === option.code) {
                button.classList.add('selected');
            }

            button.addEventListener('click', () => this.selectOption(button, option, question.code));
            container.appendChild(button);
        });
    }

    getAnswerDisplayText(answerType, englishLabel) {
        // Get translation for display only
        const translationMap = {
            'YN': 'yesNo',
            'FR': 'frequency',
            'CO': 'concentration',
            'OP': 'optimism',
            'SA': 'sexualActivity'
        };
        
        const category = translationMap[answerType];
        if (!category) return englishLabel;
        
        return this.getTranslation(`prediction.answer_values.${category}.${englishLabel}`) || englishLabel;
    }

    selectOption(button, option, questionCode) {
        this.elements.questionElements.options.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('selected');
        });

        button.classList.add('selected');
        this.responses[questionCode] = option.code; // Store code only
        
        this.elements.buttons.next.disabled = false;

        if (this.currentQuestionIndex < this.assessmentConfig.questions.length - 1) {
            setTimeout(() => this.nextQuestion(), 300);
        }
    }

    nextQuestion() {
        const currentQuestion = this.assessmentConfig.questions[this.currentQuestionIndex];
        
        if (!this.responses[currentQuestion.code]) {
            this.showAlert('selectOption', 'Please select an option before continuing.');
            return;
        }

        if (this.currentQuestionIndex < this.assessmentConfig.questions.length - 1) {
            this.currentQuestionIndex++;
            this.updateProgress();
            this.displayCurrentQuestion();
        } else {
            this.showReviewScreen();
        }
    }

    previousQuestion() {
        if (this.currentQuestionIndex > 0) {
            this.currentQuestionIndex--;
            this.updateProgress();
            this.displayCurrentQuestion();
        }
    }

    updateProgress() {
        if (!this.assessmentConfig) return;

        const progress = ((this.currentQuestionIndex + 1) / this.assessmentConfig.questions.length) * 100;
        this.elements.questionElements.progressFill.style.width = `${progress}%`;

        const progressText = this.getTranslation('prediction.questionOf', 'Question {current} of {total}')
            .replace('{current}', this.currentQuestionIndex + 1)
            .replace('{total}', this.assessmentConfig.questions.length);
        
        this.elements.questionElements.progressText.textContent = progressText;
    }

    updateNavigationButtons() {
        this.elements.buttons.prev.disabled = this.currentQuestionIndex === 0;
        
        const currentQuestion = this.assessmentConfig.questions[this.currentQuestionIndex];
        const hasResponse = this.responses[currentQuestion.code] !== undefined;
        this.elements.buttons.next.disabled = !hasResponse;

        const nextButtonSpan = this.elements.buttons.next.querySelector('span');
        if (nextButtonSpan) {
            const isLastQuestion = this.currentQuestionIndex === this.assessmentConfig.questions.length - 1;
            if (isLastQuestion) {
                nextButtonSpan.textContent = this.getTranslation('prediction.navigation.review-button', 'Review Answers');
            } else {
                nextButtonSpan.textContent = this.getTranslation('prediction.navigation.next-button', 'Next â†’');
            }
        }
    }

    // ============================================
    // REVIEW SCREEN
    // ============================================

    showReviewScreen() {
        this.showScreen(this.elements.screens.review);
        this.displayReviewResponses();
    }

    displayReviewResponses() {
        const container = this.elements.reviewElements.responsesList;
        container.innerHTML = '';
        
        this.assessmentConfig.questions.forEach((question, index) => {
            const responseItem = document.createElement('div');
            responseItem.className = 'response-item';

            const answerCode = this.responses[question.code];
            const displayAnswer = this.getAnswerDisplayTextForCode(answerCode, question.answerType);
            
            const categoryText = this.getTranslation(`prediction.questionCategories.${question.categoryCode}`) || 
                               this.CODE_TO_ENGLISH.CATEGORIES[question.categoryCode];
            const questionText = this.getTranslation(`prediction.questions.${question.code}`);

            responseItem.innerHTML = `
                <div class="response-question">
                    <div class="response-category">${categoryText}</div>
                    <div class="response-text">${questionText}</div>
                    <div class="response-answer">
                        <strong>${this.getTranslation('prediction.answerLabel', 'Answer:')}</strong> ${displayAnswer}
                    </div>
                </div>
                <div class="response-actions">
                    <button class="edit-btn" data-index="${index}">
                        ${this.getTranslation('prediction.editButton', 'Edit')}
                    </button>
                </div>
            `;

            responseItem.querySelector('.edit-btn').addEventListener('click', 
                () => this.editResponse(index));

            container.appendChild(responseItem);
        });
    }

    getAnswerDisplayTextForCode(answerCode, answerType) {
        if (!answerCode) return this.getTranslation('prediction.notAnswered', 'Not answered');
        
        // Get English text from code
        const englishText = this.CODE_TO_ENGLISH.ANSWERS[answerCode];
        if (!englishText) return answerCode;

        // Convert to display text based on answer type
        return this.getAnswerDisplayText(answerType, englishText) || englishText;
    }

    editResponse(index) {
        this.currentQuestionIndex = index;
        this.showScreen(this.elements.screens.questions);
        this.updateProgress();
        this.displayCurrentQuestion();
    }

    backToQuestions() {
        this.currentQuestionIndex = this.assessmentConfig.questions.length - 1;
        this.showScreen(this.elements.screens.questions);
        this.updateProgress();
        this.displayCurrentQuestion();
    }

    // ============================================
    // SUBMISSION AND RESULTS
    // ============================================

    async submitAssessment() {
        if (!this.validatePatientInfo()) return;

        this.showScreen(this.elements.screens.loading);
        
        try {
            await this.simulateProcessing();
            
            // Prepare data for API - Convert codes to English for model
            const requestData = {
                responses: this.convertResponsesForModel(), // English values for model
                coded_responses: this.responses, // Original codes
                patientInfo: this.patientInfo,
                assessment_start_time: new Date().toISOString(),
                language: 'en' // Model always uses English
            };

            const response = await fetch(`${this.API_BASE_URL}/api/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Client-Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const resultData = await response.json();
            resultData.patientInfo = this.patientInfo;
            resultData.coded_responses = this.responses;
            resultData.displayLanguage = this.currentLanguage;
            
            this.displayResults(resultData);

        } catch (error) {
            this.showAlert('submitError', `Failed to process assessment: ${error.message}`);
        }
    }

    convertResponsesForModel() {
        const modelInput = {};
        for (const [questionCode, answerCode] of Object.entries(this.responses)) {
            const feature = this.QUESTION_TO_FEATURE[questionCode];
            const englishText = this.CODE_TO_ENGLISH.ANSWERS[answerCode]; // Convert code to English
            if (feature && englishText) {
                modelInput[feature] = englishText; // Send English to model
            }
        }
        return modelInput;
    }

    displayResults(assessmentData) {
        this.currentAssessmentData = assessmentData;
        this.showScreen(this.elements.screens.results);
        
        const resultsContainer = document.querySelector('#resultsScreen .result-box');
        resultsContainer.innerHTML = this.generateResultsHTML(assessmentData);
        
        setTimeout(() => this.attachResultsListeners(), 50);
    }

    generateResultsHTML(data) {
        // Format date
        const formatDate = (dateString) => {
            try {
                return new Date(dateString).toLocaleDateString(this.currentLanguage, {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch {
                return dateString;
            }
        };

        // Get diagnosis translation
        const getDiagnosisText = (diagnosis) => {
            return this.getTranslation(`prediction.diagnosisTranslations.${diagnosis}`) || diagnosis;
        };

        // Get diagnosis description
        const getDiagnosisDescription = (diagnosis) => {
            return this.getTranslation(`prediction.diagnosisDescriptions.${diagnosis}`) || 
                   this.getTranslation('prediction.diagnosisDescriptions.default_description', 'Evaluation completed successfully.');
        };

        const confidence = data.confidence_percentage || 
                          (data.confidence ? Math.round(data.confidence * 100) : 0);

        return `
            <div class="results-header">
                <h2>${this.getTranslation('prediction.results-complete', 'Assessment Complete')}</h2>
                <div class="results-meta">
                    <span>${formatDate(data.timestamp)}</span>
                    <span>â€¢</span>
                    <span>${this.getTranslation('prediction.assessment.id-label', 'ID:')} ${data.id || 'N/A'}</span>
                </div>
            </div>

            ${this.generatePatientInfoHTML(data.patientInfo)}

            <div class="primary-result">
                <div class="diagnosis-result">
                    <div class="diagnosis-header">
                        <h3>${this.getTranslation('prediction.primary-result-title', 'Primary Assessment Result')}</h3>
                        <div class="confidence-badge" style="background: ${this.getConfidenceColor(confidence)};">
                            ${this.getTranslation('prediction.confidence', 'Confidence')}: ${confidence}%
                        </div>
                    </div>
                    <div class="diagnosis-main">
                        <h1>${getDiagnosisText(data.primary_diagnosis)}</h1>
                        <p class="diagnosis-description">${getDiagnosisDescription(data.primary_diagnosis)}</p>
                    </div>
                </div>
            </div>

            ${this.generateOtherDiagnosesHTML(data.all_diagnoses)}

            <div class="info-note">
                <strong>${this.getTranslation('prediction.disclaimer-title', 'Important Disclaimer:')}</strong> 
                <span>${this.getTranslation('prediction.disclaimer-text', 'This assessment is for informational purposes only...')}</span>
            </div>
        
        <div class="results-actions">
            <button id="newAssessmentBtn" class="btn btn-secondary">
                ${this.getTranslation('prediction.navigation.new-assessment', 'â†» New Assessment')}
            </button>
            <button id="learnMoreBtn" class="btn btn-info">
                <i class="fas fa-chart-line"></i>
                ${this.getTranslation('prediction.navigation.learn-more', 'Learn More')}
            </button>
            <button id="downloadBtn" class="btn btn-primary" onclick="window.mentalHealthAssessment.downloadReport()">
                <i class="fas fa-download"></i>
                ${this.getTranslation('prediction.navigation.download-report', 'Download Report')}
            </button>
        </div>
    `;
}

    getTranslatedGender(genderKey) {
        if (!genderKey) return this.getPDFTranslation('pdf_report.not_provided');
        
        // Use translation system instead of hardcoded English map
        const translationMap = {
            'Male': 'pdf_report.gender.Male',
            'Female': 'pdf_report.gender.Female', 
            'Other': 'pdf_report.gender.Other',
            'Prefer not to say': 'pdf_report.gender.Prefer not to say'
        };
        
        const translationKey = translationMap[genderKey];
        if (translationKey) {
            return this.getTranslation(translationKey, genderKey);
        }
        
        return genderKey;
    }

    generatePatientInfoHTML(patientInfo) {
        if (!patientInfo || Object.keys(patientInfo).length === 0) return '';

        const notProvided = this.getTranslation('prediction.not_provided', 'Not provided');
        const translatedGender = this.getTranslatedGender(patientInfo.gender); // Get translated gender

        return `
            <div class="patient-info-section">
                <h3>${this.getTranslation('prediction.patient-info-title', 'Patient Information')}</h3>
                <div class="patient-form">
                    <div class="form-group">
                        <label>${this.getTranslation('prediction.patient-name-label', 'Name')}</label>
                        <div class="patient-info-value">${patientInfo.name || notProvided}</div>
                    </div>
                    <div class="form-group">
                        <label>${this.getTranslation('prediction.patient-number-label', 'Patient Number')}</label>
                        <div class="patient-info-value">${patientInfo.number || notProvided}</div>
                    </div>
                    <div class="form-group">
                        <label>${this.getTranslation('prediction.patient-age-label', 'Age')}</label>
                        <div class="patient-info-value">${patientInfo.age || notProvided}</div>
                    </div>
                    <div class="form-group">
                        <label>${this.getTranslation('prediction.patient-gender-label', 'Gender')}</label>
                        <div class="patient-info-value">${translatedGender || notProvided}</div> <!-- Use translated gender -->
                    </div>
                </div>
            </div>
        `;
    }

    generateOtherDiagnosesHTML(diagnoses) {
        if (!diagnoses || diagnoses.length <= 1) {
            return `
                <div class="additional-results">
                    <div class="results-section">
                        <h4>${this.getTranslation('prediction.other-diagnoses-title', 'Other Possible Diagnoses')}</h4>
                        <div class="no-other-diagnoses">
                            ${this.getTranslation('prediction.errors.noOtherDiagnoses', 'No other diagnoses considered')}
                        </div>
                    </div>
                </div>
            `;
        }

        const otherDiagnoses = diagnoses.slice(1, 5);
        const diagnosesHTML = otherDiagnoses.map(diagnosis => {
            const diagnosisText = this.getTranslation(`prediction.diagnosisTranslations.${diagnosis.diagnosis}`) || diagnosis.diagnosis;
            const confidence = diagnosis.confidence_percentage || 
                             (diagnosis.probability ? Math.round(diagnosis.probability * 100) : 0);

            return `
                <div class="diagnosis-item">
                    <span class="diagnosis-name">${diagnosisText}</span>
                    <span class="diagnosis-probability">${confidence}%</span>
                </div>
            `;
        }).join('');

        return `
            <div class="additional-results">
                <div class="results-section">
                    <h4>${this.getTranslation('prediction.other-diagnoses-title', 'Other Possible Diagnoses')}</h4>
                    <div class="diagnoses-list">
                        ${diagnosesHTML}
                    </div>
                </div>
            </div>
        `;
    }

    attachResultsListeners() {
        document.getElementById('newAssessmentBtn')?.addEventListener('click', 
            () => this.resetAssessment());
        
        document.getElementById('downloadBtn')?.addEventListener('click', 
            () => this.downloadReport());
        
        document.getElementById('learnMoreBtn')?.addEventListener('click', 
            () => this.redirectToAnalogy());
    }

    // ============================================
    // HISTORY MANAGEMENT
    // ============================================

    showHistoryScreen() {
        this.showScreen(this.elements.screens.history);
        this.resetHistoryState();
    }

    resetHistoryState() {
        this.currentPatient = null;
        this.elements.historyElements.loginSection.style.display = 'block';
        this.elements.historyElements.patientHistorySection.style.display = 'none';
        this.elements.historyElements.loginPatientName.value = '';
        this.elements.historyElements.loginPatientNumber.value = '';
    }

    async handleLogin() {
        const name = this.elements.historyElements.loginPatientName.value.trim();
        const number = this.elements.historyElements.loginPatientNumber.value.trim();

        if (!this.validateLoginInputs(name, number)) return;

        await this.loadPatientHistory(name, number);
    }

    async loadPatientHistory(name, number) {
        try {
            this.setButtonLoading(this.elements.buttons.login, true);

            const response = await fetch(`${this.API_BASE_URL}/api/get-patient-assessments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name, 
                    number, 
                    language: this.currentLanguage 
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();

            if (!result.success || !result.assessments?.length) {
                throw new Error('No assessments found');
            }

            this.currentPatient = { name, number };
            this.displayPatientHistory(result.assessments);

        } catch (error) {
            this.showAlert('loginError', 'Error accessing assessment history. Please try again.');
        } finally {
            this.setButtonLoading(this.elements.buttons.login, false);
        }
    }

    displayPatientHistory(assessments) {
        this.elements.historyElements.loginSection.style.display = 'none';
        this.elements.historyElements.patientHistorySection.style.display = 'block';

        // Update welcome message
        this.updateHistoryWelcomeMessage();

        this.elements.historyElements.loggedInPatientNumber.textContent = this.currentPatient.number;
        this.renderHistoryList(assessments);
    }

    renderHistoryList(assessments) {
        const container = this.elements.historyElements.patientHistoryList;
        container.innerHTML = '';

        assessments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        assessments.forEach(assessment => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';

            const primaryDiagnosis = assessment.primary_diagnosis || 
                                   (assessment.all_diagnoses?.[0]?.diagnosis || 'No diagnosis');
            
            const confidence = assessment.confidence_percentage || 
                             (assessment.confidence ? Math.round(assessment.confidence * 100) : 0);

            const diagnosisText = this.getTranslation(`prediction.diagnosisTranslations.${primaryDiagnosis}`) || primaryDiagnosis;

            historyItem.innerHTML = `
                <div class="history-header">
                    <div class="history-patient">
                        <strong>${this.getTranslation('prediction.assessment.id-label', 'ID:')} ${assessment.id || 'Unknown'}</strong>
                        <span class="history-id">${this.getTranslation('prediction.history.started-label', 'Started:')} ${this.formatDate(assessment.assessment_timestamp)}</span>
                        <span class="history-id">${this.getTranslation('prediction.history.submitted-label', 'Submitted:')} ${this.formatDate(assessment.timestamp)}</span>
                    </div>
                    <div class="history-diagnosis">
                        ${diagnosisText}
                        <span class="history-confidence">${this.getTranslation('prediction.history.confidence-label', 'Confidence:')} ${confidence}%</span>
                    </div>
                </div>
                <div class="history-details">
                    <div></div>
                    <div class="history-actions">
                        <button class="btn-view" data-id="${assessment.id}">
                            <i class="fas fa-eye"></i> ${this.getTranslation('prediction.history.view-button', 'View')}
                        </button>
                        <button class="btn-download" data-id="${assessment.id}">
                            <i class="fas fa-download"></i> ${this.getTranslation('prediction.history.download-button', 'Download')}
                        </button>
                        <button class="btn-delete" data-id="${assessment.id}">
                            <i class="fas fa-trash"></i> ${this.getTranslation('prediction.history.delete-button', 'Delete')}
                        </button>
                    </div>
                </div>
            `;

            // Attach event listeners
            historyItem.querySelector('.btn-view').addEventListener('click', 
                () => this.viewHistoricalAssessment(assessment.id));
            
            historyItem.querySelector('.btn-download').addEventListener('click', 
                () => this.downloadHistoricalAssessment(assessment.id));
            
            historyItem.querySelector('.btn-delete').addEventListener('click', 
                () => this.deleteHistoricalAssessment(assessment.id));

            container.appendChild(historyItem);
        });
    }

    async viewHistoricalAssessment(assessmentId) {
        try {
            const response = await fetch(`${this.API_BASE_URL}/api/get-single-assessment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: this.currentPatient.name,
                    number: this.currentPatient.number,
                    assessment_id: assessmentId,
                    language: this.currentLanguage
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            if (!result.success) throw new Error('Assessment not found');

            this.displayResults(result.assessment);

        } catch (error) {
            this.showAlert('loadError', 'Error loading assessment. Please try again.');
        }
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    getAnswerOptions(answerType) {
        const answerMap = {
            YN: ['NO', 'YES'],
            FR: ['Seldom', 'Sometimes', 'Usually', 'Most-Often'],
            CO: ['Cannot concentrate', 'Poor concentration', 'Average concentration', 
                 'Good concentration', 'Excellent concentration'],
            OP: ['Extremely pessimistic', 'Pessimistic', 'Neutral outlook', 
                 'Optimistic', 'Extremely optimistic'],
            SA: ['No interest', 'Low interest', 'Moderate interest', 
                 'High interest', 'Very high interest']
        };

        const answers = answerMap[answerType] || ['NO', 'YES'];
        return answers.map((label) => ({
            label, // English label for reference
            code: this.getAnswerCode(answerType, label), // Code for storage
            value: label.toLowerCase().replace(/\s+/g, '-')
        }));
    }

    getAnswerCode(answerType, englishLabel) {
        const typeMap = this.ANSWER_CODES[answerType];
        if (!typeMap) return null;

        return typeMap[englishLabel] || null;
    }

    getConfidenceColor(percentage) {
        if (percentage >= 70) return '#10b981'; // Green
        if (percentage >= 50) return '#f59e0b'; // Yellow
        return '#ef4444'; // Red
    }

    formatDate(dateString) {
        if (!dateString) return this.getTranslation('prediction.not_provided', 'Unknown');
        try {
            return new Date(dateString).toLocaleDateString(this.currentLanguage, {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        } catch {
            return dateString;
        }
    }

    setButtonLoading(button, isLoading) {
        if (!button) return;
        
        if (isLoading) {
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${this.getTranslation('prediction.loading', 'Loading...')}`;
            button.disabled = true;
        } else {
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
                delete button.dataset.originalText;
            }
            button.disabled = false;
        }
    }

    // ============================================
    // VALIDATION
    // ============================================

    setupValidations() {
        this.setupInputValidation('patientName', this.validateName.bind(this));
        this.setupInputValidation('patientNumber', this.validatePatientNumber.bind(this));
        this.setupInputValidation('patientAge', this.validateAge.bind(this));
        
        // Also for login inputs
        this.setupInputValidation('loginPatientName', this.validateName.bind(this));
        this.setupInputValidation('loginPatientNumber', this.validatePatientNumber.bind(this));

        // Update patient info on input
        this.elements.reviewElements.patientName.addEventListener('input', (e) => {
            this.patientInfo.name = e.target.value.trim();
        });
        this.elements.reviewElements.patientNumber.addEventListener('input', (e) => {
            this.patientInfo.number = e.target.value.trim();
        });
        this.elements.reviewElements.patientAge.addEventListener('input', (e) => {
            this.patientInfo.age = e.target.value.trim();
        });
        this.elements.reviewElements.patientGender.addEventListener('change', (e) => {
            this.patientInfo.gender = e.target.value;
        });
    }

    setupInputValidation(inputId, validationFn) {
        const input = document.getElementById(inputId);
        if (!input) return;

        input.addEventListener('blur', () => {
            const error = validationFn(input.value);
            if (error) {
                this.showInputError(input, error);
            } else {
                this.clearInputError(input);
            }
        });

        input.addEventListener('input', () => {
            this.clearInputError(input);
        });
    }

    validatePatientInfo() {
        const errors = [];
        
        const nameError = this.validateName(this.patientInfo.name);
        if (nameError) errors.push(`Name: ${nameError}`);
        
        const numberError = this.validatePatientNumber(this.patientInfo.number);
        if (numberError) errors.push(`Patient Number: ${numberError}`);
        
        const ageError = this.validateAge(this.patientInfo.age);
        if (ageError) errors.push(`Age: ${ageError}`);
        
        if (errors.length > 0) {
            this.showAlert('validationError', errors.join('\n'));
            return false;
        }
        
        return true;
    }

    validateLoginInputs(name, number) {
        const nameError = this.validateName(name);
        const numberError = this.validatePatientNumber(number);
        
        if (nameError || numberError) {
            this.showAlert('validationError', 
                `${nameError ? `Name: ${nameError}\n` : ''}${numberError ? `Patient Number: ${numberError}` : ''}`);
            return false;
        }
        
        return true;
    }

    validateName(name) {
        name = (name || '').trim();
        if (!name) return this.getTranslation('prediction.validation.name.required', 'Name is required');
        if (name.length < 2) return this.getTranslation('prediction.validation.name.too_short', 'Name must be at least 2 characters');
        if (name.length > 50) return this.getTranslation('prediction.validation.name.too_long', 'Name cannot exceed 50 characters');
        if (!/^[a-zA-ZÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿\s\-']+$/u.test(name)) {
            return this.getTranslation('prediction.validation.name.invalid_format', 'Name can only contain letters, spaces, hyphens, and apostrophes');
        }
        return null;
    }

    validatePatientNumber(number) {
        number = (number || '').trim();
        if (!number) return this.getTranslation('prediction.validation.patient_number.required', 'Patient number is required');
        if (number.length < 6) return this.getTranslation('prediction.validation.patient_number.too_short', 'Patient number must be at least 6 characters');
        if (number.length > 20) return this.getTranslation('prediction.validation.patient_number.too_long', 'Patient number cannot exceed 20 characters');
        if (!/[a-z]/.test(number)) return this.getTranslation('prediction.validation.patient_number.no_lowercase', 'Must include at least one lowercase letter');
        if (!/[A-Z]/.test(number)) return this.getTranslation('prediction.validation.patient_number.no_uppercase', 'Must include at least one uppercase letter');
        if (!/[0-9]/.test(number)) return this.getTranslation('prediction.validation.patient_number.no_digit', 'Must include at least one number');
        if (/[^a-zA-Z0-9]/.test(number)) return this.getTranslation('prediction.validation.patient_number.special_chars', 'Only letters and numbers allowed');
        return null;
    }

    validateAge(age) {
        age = (age || '').trim();
        if (!age) return this.getTranslation('prediction.validation.age.required', 'Age is required');
        if (!/^\d+$/.test(age)) return this.getTranslation('prediction.validation.age.not_number', 'Please enter numbers only');
        
        const ageNum = parseInt(age, 10);
        if (ageNum < 12) return this.getTranslation('prediction.validation.age.too_young', 'Age must be 12 or older');
        if (ageNum > 100) return this.getTranslation('prediction.validation.age.too_old', 'Age must be 100 or younger');
        return null;
    }

    showInputError(input, message) {
        this.clearInputError(input);
        input.classList.add('input-error');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'input-error-message';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        input.parentNode.appendChild(errorDiv);
    }

    clearInputError(input) {
        input.classList.remove('input-error');
        const parent = input.parentNode;
        const errorMsg = parent.querySelector('.input-error-message');
        if (errorMsg) errorMsg.remove();
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================

    attachEventListeners() {
        // Welcome screen
        this.elements.buttons.start.addEventListener('click', () => this.startAssessment());
        this.elements.buttons.viewHistory.addEventListener('click', () => this.showHistoryScreen());

        // Questions screen
        this.elements.buttons.prev.addEventListener('click', () => this.previousQuestion());
        this.elements.buttons.next.addEventListener('click', () => this.nextQuestion());

        // Review screen
        this.elements.buttons.backToQuestions.addEventListener('click', () => this.backToQuestions());
        this.elements.buttons.submitFinal.addEventListener('click', () => this.submitAssessment());

        // History screen
        this.elements.buttons.login.addEventListener('click', () => this.handleLogin());
        this.elements.buttons.logout.addEventListener('click', () => this.handleLogout());
        this.elements.buttons.backToWelcomeFromLogin.addEventListener('click', 
            () => this.showScreen(this.elements.screens.welcome));
        this.elements.buttons.backToWelcome.addEventListener('click', 
            () => this.showScreen(this.elements.screens.welcome));

        // Keyboard navigation
        document.addEventListener('keydown', (e) => this.handleKeyboardNavigation(e));

        // Mobile navigation
        this.attachMobileNavigation();
    }

    attachMobileNavigation() {
        const mobileAssessmentBtn = document.getElementById('mobileAssessmentBtn');
        const mobileHistoryBtn = document.getElementById('mobileHistoryBtn');
        const mobileHomeItems = document.querySelectorAll('.mobile-nav-item[data-screen="welcomeScreen"]');

        mobileAssessmentBtn?.addEventListener('click', (e) => {
            e.preventDefault();
            this.startAssessment();
        });

        mobileHistoryBtn?.addEventListener('click', (e) => {
            e.preventDefault();
            this.showHistoryScreen();
        });

        mobileHomeItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                this.showScreen(this.elements.screens.welcome);
            });
        });
    }

    handleKeyboardNavigation(e) {
        if (!this.elements.screens.questions.classList.contains('active')) return;

        switch(e.key) {
            case 'Enter':
                e.preventDefault();
                this.nextQuestion();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                this.previousQuestion();
                break;
            case 'ArrowRight':
                e.preventDefault();
                this.nextQuestion();
                break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
                e.preventDefault();
                this.selectOptionByNumber(parseInt(e.key));
                break;
        }
    }

    selectOptionByNumber(number) {
        const options = this.elements.questionElements.options.querySelectorAll('.option-btn');
        if (options[number - 1]) {
            const currentQuestion = this.assessmentConfig.questions[this.currentQuestionIndex];
            const answerType = currentQuestion.answerType;
            const answerOptions = this.getAnswerOptions(answerType);
            
            if (answerOptions[number - 1]) {
                const option = options[number - 1];
                const answer = answerOptions[number - 1];
                this.selectOption(option, answer, currentQuestion.code);
            }
        }
    }

    // ============================================
    // UI TEXT UPDATES (MINIMAL)
    // ============================================

    updateAllTexts() {
        // Only update UI elements that need translation
        const textMappings = [
            // Hero section
            ['hero-title', 'prediction.hero-title'],
            ['hero-description', 'prediction.hero-description'],
            ['feature-secure', 'prediction.feature-secure'],
            ['feature-clinical', 'prediction.feature-clinical'],
            ['feature-insights', 'prediction.feature-insights'],
            
            // Welcome screen
            ['welcome-title', 'prediction.welcome-title'],
            ['welcome-description', 'prediction.welcome-description'],
            ['feature-confidential', 'prediction.feature-confidential'],
            ['feature-time', 'prediction.feature-time'],
            ['feature-evidence', 'prediction.feature-evidence'],
            ['feature-personalized', 'prediction.feature-personalized'],
            ['start-button-text', 'prediction.start-button-text'],
            ['view-history-button-text', 'prediction.view-history-button-text'],
            ['important-note-title', 'prediction.important-note-title'],
            ['important-note-text', 'prediction.important-note-text'],
            
            // Navigation buttons
            ['previous-button-text', 'prediction.navigation.previous-button'],
            ['next-button-text', 'prediction.navigation.next-button'],
            ['back-to-questions', 'prediction.navigation.back-to-questions'],
            ['submit-assessment-button', 'prediction.navigation.submit-assessment-button'],
            
            // Review screen
            ['review-title', 'prediction.review-title'],
            ['review-description', 'prediction.review-description'],
            ['patient-info-title', 'prediction.patient-info-title'],
            ['patient-name-label', 'prediction.validation.name.label'],
            ['patient-number-label', 'prediction.validation.patient_number.label'],
            ['patient-age-label', 'prediction.validation.age.label'],
            ['patient-gender-label', 'prediction.patient-gender-label'],
            ['review-note-title', 'prediction.review-note-title'],
            ['review-note-text', 'prediction.review-note-text'],  // This contains HTML tags
            ['responses-title', 'prediction.responses-title'],
            
            // Loading screen
            ['processing-title', 'prediction.processing-title'],
            ['processing-description', 'prediction.processing-description'],
            ['step-validating', 'prediction.step-validating'],
            ['step-calculating', 'prediction.step-calculating'],
            ['step-analyzing', 'prediction.step-analyzing'],
            ['step-generating', 'prediction.step-generating'],
            ['step-finalizing', 'prediction.step-finalizing'],
            
            // History screen
            ['history-title', 'prediction.history-title'],
            ['history-description', 'prediction.history-description'],
            ['access-history-title', 'prediction.access-history-title'],
            ['login-name-label', 'prediction.validation.name.label'],
            ['login-number-label', 'prediction.validation.patient_number.label'],
            ['login-back-button', 'prediction.navigation.login-back'],
            ['login-access-button', 'prediction.navigation.login-access'],
            ['logout-button', 'prediction.navigation.logout'],
            ['history-back-button', 'prediction.navigation.history-back'],
            
            // Mobile navigation
            ['mobile-home', 'prediction.mobile.home'],
            ['mobile-assessment', 'prediction.mobile.assessment'],
            ['mobile-history', 'prediction.mobile.history']
        ];

        textMappings.forEach(([elementId, translationPath]) => {
            const element = document.getElementById(elementId);
            if (element) {
                const text = this.getTranslation(translationPath, elementId);
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.placeholder = text;
                    element.title = text;
                } else if (elementId === 'review-note-text') {
                    // Use innerHTML for review-note-text to render the <strong> tags
                    element.innerHTML = text;
                } else if (elementId === 'important-note-text') {
                    // Also use innerHTML for important-note-text if it contains HTML
                    element.innerHTML = text;
                } else {
                    element.textContent = text;
                }
            }
        });

        // Update gender options
        const genderOptions = {
            'gender-default': 'gender-default',
            'gender-male': 'pdf_report.gender.Male',
            'gender-female': 'pdf_report.gender.Female',
            'gender-other': 'pdf_report.gender.Other',
            'gender-prefer-not': 'pdf_report.gender.Prefer not to say'
        };

        Object.entries(genderOptions).forEach(([elementId, translationPath]) => {
            const element = document.getElementById(elementId);
            if (element) {
                let text;
                if (translationPath === 'gender-default') {
                    text = this.getTranslation('prediction.patient-gender-default', 'Select gender...');
                } else {
                    text = this.getTranslation(translationPath, elementId);
                }
                element.textContent = text;
            }
        });

        // Update validation hints
        this.updateValidationHints();
    }

    updateValidationHints() {
        const hints = [
            ['patient-name-hint', 'prediction.validation.name.hint'],
            ['patient-number-hint', 'prediction.validation.patient_number.hint'],
            ['patient-age-hint', 'prediction.validation.age.hint'],
            ['login-number-hint', 'prediction.validation.patient_number.hint']
        ];

        hints.forEach(([elementId, translationPath]) => {
            const element = document.getElementById(elementId);
            if (element) {
                const hintText = this.getTranslation(translationPath, '');
                if (hintText) {
                    element.innerHTML = `<span class="validation-hint-text">${hintText}</span>`;
                }
            }
        });
    }

    refreshCurrentScreen() {
        const activeScreen = Object.values(this.elements.screens).find(screen => 
            screen.classList.contains('active')
        );

        if (!activeScreen) return;

        if (activeScreen === this.elements.screens.questions) {
            this.refreshQuestionsScreen();
        } else if (activeScreen === this.elements.screens.review) {
            this.refreshReviewScreen();
        } else if (activeScreen === this.elements.screens.results) {
            this.refreshResultsScreen();
        } else if (activeScreen === this.elements.screens.history) {
            this.refreshHistoryScreen();
        }
    }

    refreshQuestionsScreen() {
        this.updateProgress();
        this.displayCurrentQuestion();
    }

    refreshReviewScreen() {
        this.displayReviewResponses();
    }

    refreshResultsScreen() {
        if (this.currentAssessmentData) {
            const resultsContainer = document.querySelector('#resultsScreen .result-box');
            resultsContainer.innerHTML = this.generateResultsHTML(this.currentAssessmentData);
            setTimeout(() => this.attachResultsListeners(), 50);
        }
    }

    refreshHistoryScreen() {
        if (this.currentPatient) {
            this.loadPatientHistory(this.currentPatient.name, this.currentPatient.number);
        }
        this.updateHistoryWelcomeMessage();
    }

    updateHistoryWelcomeMessage() {
        const welcomePatient = document.getElementById('welcome-patient');
        if (welcomePatient && this.currentPatient) {
            const welcomeText = this.getTranslation('prediction.welcome-patient', 'Welcome, {name}')
                .replace('{name}', this.currentPatient.name);
            welcomePatient.textContent = welcomeText;
        }
    }

    // ============================================
    // ALERTS AND NOTIFICATIONS
    // ============================================

    showAlert(alertKey, defaultMessage) {
        const message = this.getTranslation(`prediction.errors.${alertKey}`, defaultMessage);
        this.createModalAlert(message);
    }

    createModalAlert(message) {
        // Remove existing alert
        const existingAlert = document.querySelector('.custom-alert');
        if (existingAlert) existingAlert.remove();

        // Create alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'custom-alert';
        alertDiv.innerHTML = `
            <div class="alert-content">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-message">${message}</div>
                <button class="alert-close">&times;</button>
            </div>
        `;

        document.body.appendChild(alertDiv);

        // Show with animation
        setTimeout(() => alertDiv.classList.add('show'), 10);

        // Close button
        alertDiv.querySelector('.alert-close').addEventListener('click', () => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 300);
        });

        // Auto-close after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }
        }, 5000);
    }

    // ============================================
    // RESET AND CLEANUP
    // ============================================

    resetAssessment() {
        this.currentQuestionIndex = 0;
        this.responses = {};
        this.patientInfo = { name: '', number: '', age: '', gender: '' };
        this.currentAssessmentData = null;
        
        // Clear form inputs
        this.elements.reviewElements.patientName.value = '';
        this.elements.reviewElements.patientNumber.value = '';
        this.elements.reviewElements.patientAge.value = '';
        this.elements.reviewElements.patientGender.value = '';
        
        this.showScreen(this.elements.screens.welcome);
        this.updateProgress();
    }

    handleLogout() {
        this.currentPatient = null;
        this.resetHistoryState();
    }

    // ============================================
    // PDF AND DOWNLOAD
    // ============================================
// ============================================
// PDF TRANSLATION UTILITIES
// ============================================

buildPDFTranslations() {
    const translationKeys = {
        // Main sections
        title: 'pdf_report.title',
        assessment_details: 'pdf_report.assessment_details',
        patient_info: 'pdf_report.patient_info',
        clinical_results: 'pdf_report.clinical_results',
        differential_diagnoses: 'pdf_report.differential_diagnoses',
        key_responses: 'pdf_report.key_responses',
        important_disclaimer: 'pdf_report.important_disclaimer',
        footer: 'pdf_report.footer',
        
        // Assessment details
        assessment_id: 'pdf_report.assessment_id',
        assessment_started: 'pdf_report.assessment_started',
        report_generated: 'pdf_report.report_generated',
        assessment_timezone: 'pdf_report.assessment_timezone',
        
        // Patient info
        patient_name: 'pdf_report.patient_name',
        patient_number: 'pdf_report.patient_number',
        age: 'pdf_report.age',
        gender_title: 'pdf_report.gender_title',
        
        // Clinical results
        primary_diagnosis: 'pdf_report.primary_diagnosis',
        confidence_level: 'pdf_report.confidence_level',
        assessment_datetime: 'pdf_report.assessment_datetime',
        assessment_summary: 'pdf_report.assessment_summary',
        
        // Differential diagnoses
        diagnosis: 'pdf_report.diagnosis',
        probability: 'pdf_report.probability',
        
        // Key responses
        domain: 'pdf_report.domain',
        question: 'pdf_report.question',
        answer: 'pdf_report.answer',
        
        // Disclaimer
        disclaimer_text: 'pdf_report.disclaimer_text',
        not_provided: 'pdf_report.not_provided',
        
        // Timezone labels
        timezone_labels: {
            utc: 'pdf_report.timezone_labels.utc',
            local_time: 'pdf_report.timezone_labels.local_time',
            timezone: 'pdf_report.timezone_labels.timezone'
        }
    };
    
    // Build translations object recursively
    const buildTranslations = (keys) => {
        const result = {};
        
        for (const [key, value] of Object.entries(keys)) {
            if (typeof value === 'string') {
                result[key] = this.getTranslation(value, value);
            } else if (typeof value === 'object' && value !== null) {
                result[key] = buildTranslations(value);
            }
        }
        
        return result;
    };
    
    const translations = buildTranslations(translationKeys);
    
    // Add gender translations separately (they need special handling)
    translations.gender = this.getGenderTranslations();
    
    return translations;
}

getGenderTranslations() {
    const genderKeys = {
        'Male': 'pdf_report.gender.Male',
        'Female': 'pdf_report.gender.Female', 
        'Other': 'pdf_report.gender.Other',
        'Prefer not to say': 'pdf_report.gender.Prefer not to say'
    };
    
    const translations = {};
    for (const [key, translationKey] of Object.entries(genderKeys)) {
        translations[key] = this.getTranslation(translationKey, key);
    }
    
    return translations;
}

getTranslatedGender(genderKey) {
    if (!genderKey) return this.getTranslation('pdf_report.not_provided', 'N/A');
    
    const genderTranslations = this.getGenderTranslations();
    return genderTranslations[genderKey] || genderKey;
}

formatDateForPDF(dateString, fallbackKey = 'prediction.not_provided') {
    if (!dateString) return this.getTranslation(fallbackKey, 'Not provided');
    
    try {
        return new Date(dateString).toLocaleDateString(this.currentLanguage, {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateString;
    }
}

translateDiagnosis(diagnosisKey) {
    return this.getTranslation(
        `prediction.diagnosisTranslations.${diagnosisKey}`,
        diagnosisKey
    );
}

translateDiagnosisDescription(diagnosisKey) {
    return this.getTranslation(
        `prediction.diagnosisDescriptions.${diagnosisKey}`,
        this.getTranslation('prediction.diagnosisDescriptions.default_description', 'Evaluation completed successfully.')
    );
}

translateQuestionAndAnswer(questionCode, answerCode) {
    const questionConfig = this.assessmentConfig?.questions.find(q => q.code === questionCode);
    if (!questionConfig) return null;
    
    const questionText = this.getTranslation(`prediction.questions.${questionCode}`);
    const categoryText = this.getTranslation(
        `prediction.questionCategories.${questionConfig.categoryCode}`,
        this.CODE_TO_ENGLISH.CATEGORIES[questionConfig.categoryCode]
    );
    const answerText = this.getAnswerDisplayTextForCode(answerCode, questionConfig.answerType);
    
    return {
        category: categoryText,
        question: questionText,
        answer: answerText,
        feature: questionConfig.feature,
        questionCode,
        answerCode
    };
}

// ============================================
// PREPARE PDF DATA (REFACTORED)
// ============================================

prepareDataForPDF(assessmentData) {
    // Build patient info with translated gender
    const patientInfo = {
        name: assessmentData.patient_info?.name || '',
        number: assessmentData.patient_info?.number || '',
        age: assessmentData.patient_info?.age || '',
        gender: this.getTranslatedGender(assessmentData.patient_info?.gender)
    };
    
    // Translate primary diagnosis
    const primaryDiagnosis = this.translateDiagnosis(assessmentData.primary_diagnosis);
    const diagnosisDescription = this.translateDiagnosisDescription(assessmentData.primary_diagnosis);
    
    // Translate all diagnoses
    const allDiagnoses = (assessmentData.all_diagnoses || []).map(diag => ({
        diagnosis: this.translateDiagnosis(diag.diagnosis),
        probability: diag.probability || 0,
        confidence_percentage: diag.confidence_percentage || 0,
        rank: diag.rank || 0
    }));
    
    // Translate questions and answers
    const questionsAndAnswers = [];
    if (assessmentData.coded_responses) {
        Object.entries(assessmentData.coded_responses).forEach(([questionCode, answerCode]) => {
            const qa = this.translateQuestionAndAnswer(questionCode, answerCode);
            if (qa) questionsAndAnswers.push(qa);
        });
    }
    
    // Format dates
    const assessmentDate = this.formatDateForPDF(assessmentData.assessment_timestamp);
    const reportDate = this.formatDateForPDF(assessmentData.timestamp);
    
    // Calculate confidence percentage
    const confidencePercentage = assessmentData.confidence_percentage || 
                               Math.round((assessmentData.confidence || 0) * 100);
    
    // Build complete PDF data object
    return {
        // Metadata
        id: assessmentData.id || '',
        timestamp: reportDate,
        assessment_timestamp: assessmentDate,
        timezone: assessmentData.timezone || 'UTC',
        language: this.currentLanguage,
        
        // Patient info
        patient_info: patientInfo,
        
        // Diagnosis results
        primary_diagnosis: primaryDiagnosis,
        confidence_percentage: confidencePercentage,
        all_diagnoses: allDiagnoses,
        diagnosis_description: diagnosisDescription,
        
        // Questions and answers
        questions_and_answers: questionsAndAnswers,
        
        // Translations for PDF template
        pdf_translations: this.buildPDFTranslations(),
        
        // Original data for reference
        original_data: {
            primary_diagnosis_key: assessmentData.primary_diagnosis,
            coded_responses: assessmentData.coded_responses,
            confidence: assessmentData.confidence
        }
    };
}

    async downloadReport() {
        if (!this.currentAssessmentData) {
            this.showAlert('noDataForDownload', 'No assessment data available for download.');
            return;
        }

        const downloadBtn = document.getElementById('downloadBtn');
        const originalText = downloadBtn?.innerHTML;

        try {
            // Show loading state
            if (downloadBtn) {
                downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${this.getTranslation('prediction.generatingPDF', 'Generating PDF...')}`;
                downloadBtn.disabled = true;
            }

            console.log('Starting PDF generation...');
            console.log('Current assessment data:', this.currentAssessmentData);
            
            // Prepare translated data for PDF
            const pdfData = this.prepareDataForPDF(this.currentAssessmentData);
            console.log('PDF data prepared:', pdfData);
            
            // Add debug logging
            console.log('API Base URL:', this.API_BASE_URL);
            console.log('Request payload:', {
                pdf_data: pdfData,
                language: this.currentLanguage
            });

            // Send to backend for PDF generation
            const response = await fetch(`${this.API_BASE_URL}/api/generate-pdf-report`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/pdf'
                },
                body: JSON.stringify({
                    pdf_data: pdfData,
                    language: this.currentLanguage
                })
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));

            if (!response.ok) {
                // Try to get error message from response
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                    console.error('Backend error:', errorData);
                } catch (e) {
                    // If not JSON, get text
                    const text = await response.text();
                    errorMessage = text || errorMessage;
                    console.error('Response text:', text);
                }
                throw new Error(errorMessage);
            }

            // Check content type
            const contentType = response.headers.get('content-type');
            console.log('Content-Type:', contentType);
            
            if (!contentType || !contentType.includes('application/pdf')) {
                const text = await response.text();
                console.error('Expected PDF but got:', text.substring(0, 200));
                throw new Error('Server returned non-PDF response');
            }

            const pdfBlob = await response.blob();
            console.log('PDF blob size:', pdfBlob.size, 'bytes');
            
            if (pdfBlob.size === 0) {
                throw new Error('Empty PDF file received');
            }

            // Create download link
            const url = window.URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate filename
            const reportTitle = this.getTranslation('prediction.report-filename', 'Mental_Health_Report');
            const timestamp = new Date().toISOString().split('T')[0];
            const patientName = pdfData.patient_info?.name?.replace(/\s+/g, '_') || 'patient';
            
            a.download = `${reportTitle}_${patientName}_${timestamp}_${this.currentLanguage}.pdf`;
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
            
            console.log('PDF download initiated successfully');

        } catch (error) {
            console.error('PDF generation error details:', error);
            this.showAlert('pdfError', `PDF generation failed: ${error.message}`);
        } finally {
            if (downloadBtn) {
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }
    }


    async downloadHistoricalAssessment(assessmentId) {
        try {
            const response = await fetch(`${this.API_BASE_URL}/api/get-single-assessment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: this.currentPatient.name,
                    number: this.currentPatient.number,
                    assessment_id: assessmentId,
                    language: this.currentLanguage
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            if (result.success && result.assessment) {
                // Use the same PDF generation logic
                this.currentAssessmentData = result.assessment;
                await this.downloadReport();
            }
        } catch (error) {
            this.showAlert('downloadError', 'Error downloading assessment.');
            console.error('Historical download error:', error);
        }
    }


    async deleteHistoricalAssessment(assessmentId) {
        const confirmMessage = this.getTranslation('prediction.errors.deleteConfirm', 
            'Are you sure you want to delete this assessment? This action cannot be undone.');
        
        if (!confirm(confirmMessage)) return;

        try {
            const response = await fetch(`${this.API_BASE_URL}/api/delete-assessment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    patient_number: this.currentPatient.number,
                    assessment_id: assessmentId
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            if (result.success) {
                // Reload history in current language
                await this.loadPatientHistory(this.currentPatient.name, this.currentPatient.number);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            this.showAlert('deleteError', 'Error deleting assessment.');
        }
    }

    // ============================================
    // SIMULATION AND UTILITIES
    // ============================================

    async simulateProcessing() {
        const steps = document.querySelectorAll('.loading-step');
        for (let i = 0; i < steps.length; i++) {
            await new Promise(resolve => setTimeout(resolve, 800));
            steps[i].classList.add('active');
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    redirectToAnalogy() {
        if (!this.currentAssessmentData?.primary_diagnosis) return;
        
        const diagnosis = this.currentAssessmentData.primary_diagnosis;
        const url = `analogy.html?diagnosis=${encodeURIComponent(diagnosis)}&lang=${this.currentLanguage}`;
        window.location.href = url;
    }

    handleEnterKey() {
        const currentQuestion = this.assessmentConfig.questions[this.currentQuestionIndex];
        if (this.responses[currentQuestion.code]) {
            this.nextQuestion();
        } else {
            const firstOption = this.elements.questionElements.options.querySelector('.option-btn');
            firstOption?.focus();
        }
    }
}

// ============================================
// INITIALIZE THE APPLICATION
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    // Initialize after globalLangManager is ready
    const initApp = () => {
        if (!window.globalLangManager) {
            setTimeout(initApp, 100);
            return;
        }
        window.mentalHealthAssessment = new MentalHealthAssessmentSystem();
    };
    
    initApp();
});
</script>

</body>
</html>